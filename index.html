<!DOCTYPE html>
<html lang="en">
<!--
Budget Build Club Inventory Manager
Version: 2.0.0
Last Updated: 2025-10-29

CHANGELOG:
v2.0.0 (2025-10-29)
- MAJOR UPDATE: Combined Firebase sync with superior Offline App UI
- Integrated all Offline App features (order summary, visual status, product editing)
- Added automatic Shopify CSV import with kit mapping
- Smart kit name matching (handles variations like "S13" vs "KA24DE Coil On Plug Mounting Plate - S13")
- Preserved Firebase authentication and cloud sync
- Maintained offline-first architecture with background sync
- Enhanced order modal with product summary and inventory status
- Added visual ready-to-ship indicators
- Improved component and kit management from Offline App
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Build Club Inventory Manager v2.0.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .login-box h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }
        
        .login-box p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .error-message.show { display: block; }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .remember-me input[type="checkbox"] { width: auto; }
        
        /* App Container */
        .app-container { display: none; }
        .app-container.show { display: block; }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .version-badge {
            position: absolute;
            top: 15px;
            left: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.3);
            letter-spacing: 0.5px;
        }
        
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: background 0.2s;
            color: white;
            border: none;
        }
        
        .logout-btn:hover { background: rgba(255, 255, 255, 0.3); }
        
        .firebase-status-pill {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 10px;
            cursor: pointer;
        }
        
        .firebase-status-pill.connected { background: rgba(16, 185, 129, 0.9); }
        .firebase-status-pill.offline { background: rgba(107, 114, 128, 0.9); }
        .firebase-status-pill.syncing { background: rgba(245, 158, 11, 0.9); }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .value::before { content: attr(data-prefix); }
        
        .stat-card .subvalue {
            font-size: 14px;
            color: #999;
            margin-top: 4px;
        }
        
        .content { padding: 30px; }
        
        .section { margin-bottom: 40px; }
        
        .section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .btn-small { padding: 4px 10px; font-size: 12px; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr { cursor: pointer; }
        tbody tr:hover { opacity: 0.85; }
        
        .status-paid {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-paid.awaiting { background: #f59e0b; }
        .status-unpaid { background: #ef4444; color: white; padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        
        .onhand-ok { background: #d1fae5; color: #065f46; font-weight: bold; padding: 8px; border-radius: 6px; }
        .onhand-low { background: #fed7aa; color: #92400e; font-weight: bold; padding: 8px; border-radius: 6px; }
        .onhand-critical { background: #fecaca; color: #991b1b; font-weight: bold; padding: 8px; border-radius: 6px; }
        .inventory-ok { color: #10b981; font-weight: bold; }
        .inventory-low { color: #f59e0b; font-weight: bold; }
        .inventory-critical { color: #ef4444; font-weight: bold; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 { margin-bottom: 20px; color: #333; }
        
        .form-group { margin-bottom: 20px; }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .component-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .component-checkbox input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 2px solid #e5e7eb;
            border-radius: 4px;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            transform: translateY(150px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>
    
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>üîê Login Required</h1>
            <p>Budget Build Club Inventory Manager v2.0.0</p>
            
            <div id="loginError" class="error-message"></div>
            
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            
            <div class="remember-me">
                <input type="checkbox" id="rememberMe" checked>
                <label for="rememberMe">Remember me</label>
            </div>
            
            <button class="btn" id="loginBtn" onclick="handleLogin()">Sign In</button>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appContainer" class="app-container">
        <div class="container">
            <div class="header">
                <div class="version-badge">v2.0.0</div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
                <h1>üõ†Ô∏è COP Kits Inventory Manager</h1>
                <p>Track orders, inventory, and profits in real-time</p>
                <div id="firebaseStatus" class="firebase-status-pill offline" onclick="manualSync()">
                    <span id="firebaseStatusText">Offline Mode</span>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <div class="value" id="totalOrders">0</div>
                    <div class="subvalue">Active orders</div>
                </div>
                <div class="stat-card">
                    <h3>Ready to Ship</h3>
                    <div class="value" id="readyToShip">0</div>
                    <div class="subvalue" id="readyPercentage">0% ready</div>
                </div>
                <div class="stat-card">
                    <h3>Paid Orders</h3>
                    <div class="value" id="paidOrders">0</div>
                    <div class="subvalue" id="paidPercentage">0%</div>
                </div>
                <div class="stat-card">
                    <h3>Revenue Collected</h3>
                    <div class="value" id="revenueCollected" style="color: #10b981;" data-prefix="$">0</div>
                    <div class="subvalue" id="revenueTotal">of $0 total</div>
                </div>
                <div class="stat-card">
                    <h3>Total Profit</h3>
                    <div class="value" id="totalProfit" style="color: #10b981;" data-prefix="$">0</div>
                    <div class="subvalue" id="profitMargin">0% margin</div>
                </div>
                <div class="stat-card">
                    <h3>Total Costs</h3>
                    <div class="value" id="totalCosts" style="color: #ef4444;" data-prefix="$">0</div>
                    <div class="subvalue">Materials + Shipping</div>
                </div>
            </div>
            
            <div class="content">
                <div class="section">
                    <h2>üì¶ Orders</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn" onclick="showNewOrderModal()">+ Add New Order</button>
                        <button class="btn" onclick="document.getElementById('csvFileInput').click()">üì• Import from Shopify CSV</button>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="collectionProgress" style="width: 0%">0% Collected</div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; flex-wrap: wrap; justify-content: center;">
                        <div id="ordersSummary" style="display: flex; gap: 15px; flex-wrap: wrap;"></div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 25%;">Customer</th>
                                <th style="width: 15%;">Order #</th>
                                <th style="width: 35%;">Products</th>
                                <th style="width: 25%;">Payment Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>üìä Inventory</h2>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #555;">Components</h3>
                    <button class="btn" onclick="showNewComponentModal()" style="margin-bottom: 20px;">+ Add Component</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Needed for Orders</th>
                                <th>On Hand</th>
                                <th>On Order</th>
                                <th>ETA</th>
                                <th>Total Available</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                    
                    <h3 style="margin: 40px 0 10px 0; color: #555;">Kits</h3>
                    <button class="btn" onclick="showNewKitModal()" style="margin-bottom: 20px;">+ Add Kit</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Kit Name</th>
                                <th>Components Required</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Can Make</th>
                            </tr>
                        </thead>
                        <tbody id="kitsBody"></tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>üìÆ Shipped Orders</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Order</th>
                                <th>Amount</th>
                                <th>Tracking</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shippedBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Modal -->
    <div id="newOrderModal" class="modal">
        <div class="modal-content">
            <h3 id="orderModalTitle">Add New Order</h3>
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="newOrderName" placeholder="Enter customer name">
            </div>
            
            <div id="orderSummaryView" style="display: none;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Order Summary</h4>
                    <div id="orderSummaryContent"></div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>Total:</strong>
                            <strong id="orderSummaryTotal" style="font-size: 20px; color: #667eea;">$0</strong>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Components Needed</h4>
                    <div id="orderComponentsNeeded"></div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Inventory Status</h4>
                    <div id="orderInventoryStatus"></div>
                </div>
                
                <div style="background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333;">Edit Products</h4>
                        <button class="btn btn-small" onclick="showAddProductToOrder()">+ Add Product</button>
                    </div>
                    <div id="orderProductsList"></div>
                </div>
            </div>
            
            <div id="orderKitsContainer" style="display: none;"></div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="newOrderPaid"> Paid
                </label>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeNewOrderModal()">Cancel</button>
                <button class="btn btn-success" id="orderModalSaveBtn" onclick="addNewOrder()">Add Order</button>
                <button class="btn btn-danger" id="orderModalDeleteBtn" onclick="deleteCurrentOrder()" style="display: none;">Delete Order</button>
                <button class="btn btn-success" id="orderModalShipBtn" onclick="showShipOrderModalFromEdit()" style="display: none;">Ship Order</button>
            </div>
        </div>
    </div>
    
    <!-- Component Modal -->
    <div id="editComponentModal" class="modal">
        <div class="modal-content">
            <h3 id="componentModalTitle">Edit Component</h3>
            <div class="form-group">
                <label>Component Name</label>
                <input type="text" id="editComponentName">
            </div>
            <div class="form-group">
                <label>On Hand</label>
                <input type="number" id="editComponentOnHand" min="0">
            </div>
            <div class="form-group">
                <label>On Order</label>
                <input type="number" id="editComponentOnOrder" min="0">
            </div>
            <div class="form-group">
                <label>ETA</label>
                <input type="text" id="editComponentEta" placeholder="e.g., 10/23">
            </div>
            <div class="form-group">
                <label>Cost Type</label>
                <select id="editComponentCostType" onchange="toggleCostFields()">
                    <option value="piece">Per Piece</option>
                    <option value="box">Per Box/Pack</option>
                </select>
            </div>
            <div class="form-group" id="pieceCostGroup">
                <label>Cost Per Piece ($)</label>
                <input type="number" id="editComponentCostPiece" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-group" id="boxCostGroup" style="display: none;">
                <label>Box/Pack Size</label>
                <input type="number" id="editComponentBoxSize" min="1" placeholder="e.g., 50">
                <label style="margin-top: 10px;">Cost Per Box/Pack ($)</label>
                <input type="number" id="editComponentCostBox" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeEditComponentModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveComponentEdit()">Save</button>
                <button class="btn btn-danger" id="componentDeleteBtn" onclick="deleteCurrentComponent()" style="display: none;">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Kit Modal -->
    <div id="newKitModal" class="modal">
        <div class="modal-content">
            <h3 id="kitModalTitle">Add New Kit</h3>
            <div class="form-group">
                <label>Kit Name</label>
                <input type="text" id="newKitName" placeholder="Enter kit name">
            </div>
            <div class="form-group">
                <label>Cost Per Kit ($) - <small>Leave empty to auto-calculate</small></label>
                <input type="number" id="newKitCost" step="0.01" min="0" placeholder="Auto-calculated">
            </div>
            <div class="form-group">
                <label>Sell Price Per Kit ($)</label>
                <input type="number" id="newKitPrice" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Select Components</label>
                <div id="kitComponentsList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px;">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeNewKitModal()">Cancel</button>
                <button class="btn btn-success" id="kitModalSaveBtn" onclick="addNewKit()">Add Kit</button>
                <button class="btn btn-danger" id="kitModalDeleteBtn" onclick="deleteCurrentKit()" style="display: none;">Delete Kit</button>
            </div>
        </div>
    </div>
    
    <!-- Ship Order Modal -->
    <div id="shipOrderModal" class="modal">
        <div class="modal-content">
            <h3>Ship Order</h3>
            <p id="shipOrderCustomer"></p>
            <div class="form-group">
                <label>Tracking Number</label>
                <input type="text" id="shipOrderTracking" placeholder="Enter tracking number">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeShipOrderModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmShipOrder()">Mark as Shipped</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, writeBatch, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAOyGTs-fGXuY08pmmCIxLtB_02_gFwMJs",
            authDomain: "inventory-464e0.firebaseapp.com",
            projectId: "inventory-464e0",
            storageBucket: "inventory-464e0.firebasestorage.app",
            messagingSenderId: "1042168855557",
            appId: "1:1042168855557:web:1165defaf0bee779e8706c"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        setPersistence(auth, browserLocalPersistence);
        enableIndexedDbPersistence(db).catch((err) => {
            console.log('Persistence error:', err.code);
        });
        
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.firebaseCollection = collection;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseWriteBatch = writeBatch;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.firebaseReady = true;
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User authenticated:', user.email);
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').classList.add('show');
                window.initializeApp();
            } else {
                console.log('User not authenticated');
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('appContainer').classList.remove('show');
            }
        });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        const APP_VERSION = '2.0.0';
        let orders = [];
        let components = {};
        let kits = {};
        let nextOrderId = 1;
        let currentEditOrderId = null;
        let currentEditComponent = null;
        let currentEditKit = null;
        let currentShipOrderId = null;
        let firebaseAvailable = false;
        
        // Kit name mapping for Shopify CSV import
        const KIT_NAME_MAP = {
            'KA24DE Coil On Plug Mounting Plate - S13 (3 Valve Cover Bolts)': 'S13',
            'KA24DE Coil On Plug Mounting Plate - S14 (2 Valve Cover Bolts)': 'S14',
            'KA24 S13 Distributor Cap Cover': 'Cap',
            'Toyota 1JZ/2JZ Smart Coil (1NZ) Bracket - Single': '1NZ COP Adapter',
            '2JZ-GE to 2JZ-GTE FFFIM Adapter - 2JZ': '2JZ Intake Adapter'
        };
        
        // Login handling
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.classList.add('show');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.classList.remove('show');
            
            try {
                await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Invalid email or password. Please try again.';
                errorDiv.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }
        
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.firebaseAuth);
                    showToast('Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Error logging out');
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        });
        
        // Initialize app
        function initializeApp() {
            console.log(`Initializing Budget Build Club Inventory Manager v${APP_VERSION}`);
            loadFromLocalStorage();
            tryLoadFromFirebase();
        }
        
        function loadFromLocalStorage() {
            console.log('Loading from localStorage...');
            try {
                const savedOrders = localStorage.getItem('bbc_orders');
                const savedComponents = localStorage.getItem('bbc_components');
                const savedKits = localStorage.getItem('bbc_kits');
                const savedNextOrderId = localStorage.getItem('bbc_nextOrderId');
                
                if (savedOrders) orders = JSON.parse(savedOrders);
                if (savedComponents) components = JSON.parse(savedComponents);
                if (savedKits) kits = JSON.parse(savedKits);
                if (savedNextOrderId) nextOrderId = parseInt(savedNextOrderId);
                
                console.log(`Loaded: ${orders.length} orders, ${Object.keys(components).length} components, ${Object.keys(kits).length} kits`);
                updateFirebaseStatus('offline', 'Offline Mode');
                renderAll();
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('bbc_orders', JSON.stringify(orders));
                localStorage.setItem('bbc_components', JSON.stringify(components));
                localStorage.setItem('bbc_kits', JSON.stringify(kits));
                localStorage.setItem('bbc_nextOrderId', nextOrderId.toString());
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        async function tryLoadFromFirebase() {
            if (!window.firebaseReady || !window.firebaseAuth.currentUser) return;
            
            updateFirebaseStatus('syncing', 'Connecting...');
            console.log('Loading from Firebase...');
            
            try {
                const ordersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'orders'));
                const firebaseOrders = [];
                ordersSnapshot.forEach(doc => firebaseOrders.push(doc.data()));
                
                const componentsSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'components'));
                const firebaseComponents = {};
                componentsSnapshot.forEach(doc => firebaseComponents[doc.id] = doc.data());
                
                const kitsSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'kits'));
                const firebaseKits = {};
                kitsSnapshot.forEach(doc => firebaseKits[doc.id] = doc.data());
                
                const docRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'nextOrderId');
                const docSnap = await window.firebaseGetDoc(docRef);
                let firebaseNextOrderId = 1;
                if (docSnap.exists()) firebaseNextOrderId = docSnap.data().value;
                
                console.log(`Firebase: ${firebaseOrders.length} orders, ${Object.keys(firebaseComponents).length} components, ${Object.keys(firebaseKits).length} kits`);
                
                if (firebaseOrders.length > 0 || Object.keys(firebaseComponents).length > 0 || Object.keys(firebaseKits).length > 0) {
                    orders = firebaseOrders;
                    components = firebaseComponents;
                    kits = firebaseKits;
                    nextOrderId = firebaseNextOrderId;
                    saveToLocalStorage();
                    renderAll();
                } else if (orders.length > 0 || Object.keys(components).length > 0 || Object.keys(kits).length > 0) {
                    console.log('Pushing local data to Firebase...');
                    await syncToFirebase();
                }
                
                firebaseAvailable = true;
                updateFirebaseStatus('connected', 'Connected');
            } catch (error) {
                console.error('Firebase error:', error);
                firebaseAvailable = false;
                updateFirebaseStatus('offline', 'Offline Mode');
                showToast('Working in offline mode');
            }
        }
        
        async function syncToFirebase() {
            if (!window.firebaseReady || !firebaseAvailable || !window.firebaseAuth.currentUser) return;
            
            updateFirebaseStatus('syncing', 'Syncing...');
            try {
                const batch = window.firebaseWriteBatch(window.firebaseDB);
                
                for (const order of orders) {
                    const orderRef = window.firebaseDoc(window.firebaseDB, 'orders', String(order.id));
                    batch.set(orderRef, order);
                }
                
                for (const [name, comp] of Object.entries(components)) {
                    const compRef = window.firebaseDoc(window.firebaseDB, 'components', name);
                    batch.set(compRef, comp);
                }
                
                for (const [name, kit] of Object.entries(kits)) {
                    const kitRef = window.firebaseDoc(window.firebaseDB, 'kits', name);
                    batch.set(kitRef, kit);
                }
                
                const nextOrderIdRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'nextOrderId');
                batch.set(nextOrderIdRef, { value: nextOrderId });
                
                await batch.commit();
                updateFirebaseStatus('connected', 'Synced');
                setTimeout(() => updateFirebaseStatus('connected', 'Connected'), 2000);
            } catch (error) {
                console.error('Sync error:', error);
                updateFirebaseStatus('offline', 'Sync Failed');
            }
        }
        
        function manualSync() {
            if (firebaseAvailable) {
                syncToFirebase();
                showToast('Syncing to cloud...');
            } else {
                tryLoadFromFirebase();
                showToast('Reconnecting...');
            }
        }
        
        function updateFirebaseStatus(status, text) {
            const statusPill = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            if (statusPill && statusText) {
                statusPill.className = 'firebase-status-pill ' + status;
                statusText.textContent = text;
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // CSV Import Handler
        async function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('Processing CSV...');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsed:', results.data.length, 'rows');
                    
                    // Group by order number
                    const orderMap = new Map();
                    
                    results.data.forEach(row => {
                        const orderNum = row['Name']?.trim();
                        if (!orderNum || !orderNum.startsWith('#')) return;
                        
                        if (!orderMap.has(orderNum)) {
                            orderMap.set(orderNum, {
                                id: nextOrderId++,
                                shopifyOrderNumber: orderNum,
                                name: row['Billing Name']?.trim() || row['Shipping Name']?.trim() || 'Unknown',
                                paid: row['Financial Status']?.toLowerCase() === 'paid',
                                shipped: row['Fulfillment Status']?.toLowerCase() === 'fulfilled',
                                tracking: ''
                            });
                        }
                        
                        const order = orderMap.get(orderNum);
                        const lineitemName = row['Lineitem name']?.trim();
                        const lineitemQty = parseInt(row['Lineitem quantity']) || 0;
                        
                        if (lineitemName && lineitemQty > 0) {
                            // Map Shopify product name to kit name
                            let kitName = KIT_NAME_MAP[lineitemName] || lineitemName;
                            
                            // Try fuzzy matching if exact match not found
                            if (!KIT_NAME_MAP[lineitemName]) {
                                for (const [shopifyName, mappedName] of Object.entries(KIT_NAME_MAP)) {
                                    if (lineitemName.toLowerCase().includes(mappedName.toLowerCase())) {
                                        kitName = mappedName;
                                        break;
                                    }
                                }
                            }
                            
                            const kitKey = kitName.toLowerCase();
                            order[kitKey] = (order[kitKey] || 0) + lineitemQty;
                        }
                    });
                    
                    // Add orders to array
                    const newOrders = Array.from(orderMap.values());
                    orders.push(...newOrders);
                    
                    saveToLocalStorage();
                    syncToFirebase();
                    renderAll();
                    
                    showToast(`Imported ${newOrders.length} orders from Shopify!`);
                },
                error: function(error) {
                    console.error('CSV parse error:', error);
                    showToast('Error parsing CSV');
                }
            });
            
            event.target.value = '';
        }
        
        function renderAll() {
            updateStats();
            renderOrders();
            renderInventory();
            renderKits();
            renderShippedOrders();
        }
        
        function calculateStats() {
            const activeOrders = orders.filter(o => !o.shipped);
            const paidOrders = activeOrders.filter(o => o.paid);
            
            let totalRevenue = 0;
            let revenueCollected = 0;
            
            activeOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    totalRevenue += qty * (kit.price || 0);
                }
            });
            
            paidOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    revenueCollected += qty * (kit.price || 0);
                }
            });
            
            let totalCosts = 0;
            paidOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    totalCosts += qty * (kit.cost || 0);
                }
            });
            
            const profit = revenueCollected - totalCosts;
            const margin = revenueCollected > 0 ? (profit / revenueCollected) * 100 : 0;
            
            return { 
                totalOrders: activeOrders.length, 
                paidOrders: paidOrders.length, 
                totalRevenue, 
                revenueCollected, 
                profit, 
                margin, 
                totalCosts 
            };
        }
        
        function updateStats() {
            const stats = calculateStats();
            const activeOrders = orders.filter(o => !o.shipped);
            const paidOrders = activeOrders.filter(o => o.paid);
            
            let readyToShipCount = 0;
            paidOrders.forEach(order => {
                if (canFulfillOrder(order)) {
                    readyToShipCount++;
                }
            });
            
            document.getElementById('totalOrders').textContent = stats.totalOrders;
            document.getElementById('readyToShip').textContent = readyToShipCount;
            const readyPct = paidOrders.length > 0 ? ((readyToShipCount / paidOrders.length) * 100).toFixed(1) : 0;
            document.getElementById('readyPercentage').textContent = `${readyPct}% ready`;
            document.getElementById('paidOrders').textContent = stats.paidOrders;
            const paidPct = stats.totalOrders > 0 ? ((stats.paidOrders / stats.totalOrders) * 100).toFixed(1) : 0;
            document.getElementById('paidPercentage').textContent = `${paidPct}%`;
            document.getElementById('revenueCollected').textContent = `${stats.revenueCollected.toFixed(0)}`;
            document.getElementById('revenueTotal').textContent = `of $${stats.totalRevenue.toFixed(0)} total`;
            document.getElementById('totalProfit').textContent = `${stats.profit.toFixed(2)}`;
            document.getElementById('profitMargin').textContent = `${stats.margin.toFixed(1)}% margin`;
            document.getElementById('totalCosts').textContent = `${stats.totalCosts.toFixed(2)}`;
            const collectionPct = stats.totalRevenue > 0 ? (stats.revenueCollected / stats.totalRevenue) * 100 : 0;
            document.getElementById('collectionProgress').style.width = collectionPct + '%';
            document.getElementById('collectionProgress').textContent = `${collectionPct.toFixed(1)}% Collected`;
        }
        
        function canFulfillOrder(order) {
            for (const [kitName, kit] of Object.entries(kits)) {
                const qtyNeeded = order[kitName.toLowerCase()] || 0;
                if (qtyNeeded === 0) continue;
                
                for (const [componentName, componentQty] of Object.entries(kit.components)) {
                    const comp = components[componentName];
                    if (!comp) return false;
                    const totalNeeded = componentQty * qtyNeeded;
                    if (comp.onHand < totalNeeded) return false;
                }
            }
            return true;
        }
        
        function renderOrdersSummary() {
            const activeOrders = orders.filter(o => !o.shipped);
            const kitTotals = {};
            
            activeOrders.forEach(order => {
                for (const kitName of Object.keys(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        kitTotals[kitName] = (kitTotals[kitName] || 0) + qty;
                    }
                }
            });
            
            const summaryDiv = document.getElementById('ordersSummary');
            summaryDiv.innerHTML = '';
            
            for (const [kitName, total] of Object.entries(kitTotals)) {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                card.innerHTML = `
                    <div style="font-size: 12px; color: #666; font-weight: 600; margin-bottom: 5px;">${kitName.toUpperCase()}</div>
                    <div style="font-size: 24px; color: #667eea; font-weight: bold;">${total}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">to build</div>
                `;
                summaryDiv.appendChild(card);
            }
            
            if (Object.keys(kitTotals).length === 0) {
                summaryDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No active orders</div>';
            }
        }
        
        function renderOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            const activeOrders = orders.filter(o => !o.shipped);
            
            activeOrders.forEach(order => {
                let totalQty = 0;
                const productList = [];
                
                for (const kitName of Object.keys(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        totalQty += qty;
                        productList.push(`${qty}√ó ${kitName}`);
                    }
                }
                
                const productText = totalQty > 0 
                    ? `${totalQty} item${totalQty > 1 ? 's' : ''} (${productList.join(', ')})`
                    : 'No products';
                
                const ready = canFulfillOrder(order);
                const orderNumber = order.shopifyOrderNumber || '-';
                
                let bgColor = '';
                let statusText = '';
                
                if (order.paid && ready) {
                    bgColor = '#d1fae5';
                    statusText = '<span class="status-paid">‚úì PAID & READY TO SHIP</span>';
                } else if (order.paid) {
                    bgColor = '#fef3c7';
                    statusText = '<span class="status-paid awaiting">‚ö† PAID - AWAITING STOCK</span>';
                } else {
                    bgColor = '#fee2e2';
                    statusText = '<span class="status-unpaid">UNPAID</span>';
                }
                
                const tr = document.createElement('tr');
                tr.style.backgroundColor = bgColor;
                tr.onclick = () => editOrder(order.id);
                
                tr.innerHTML = `
                    <td><strong>${order.name}</strong></td>
                    <td>${orderNumber}</td>
                    <td>${productText}</td>
                    <td>${statusText}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            renderOrdersSummary();
        }
        
        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            for (const [name, comp] of Object.entries(components)) {
                let needed = 0;
                
                const paidOrders = orders.filter(o => o.paid && !o.shipped);
                paidOrders.forEach(order => {
                    for (const [kitName, kit] of Object.entries(kits)) {
                        const kitQty = order[kitName.toLowerCase()] || 0;
                        const componentQty = kit.components[name] || 0;
                        needed += kitQty * componentQty;
                    }
                });
                
                const totalAvailable = comp.onHand + comp.onOrder;
                let statusClass = 'inventory-ok', statusText = '‚úì OK';
                let onHandClass = 'onhand-ok';
                
                if (comp.onHand < needed) {
                    if (totalAvailable >= needed) {
                        statusClass = 'inventory-low';
                        statusText = '‚ö† On Order';
                        onHandClass = 'onhand-low';
                    } else {
                        statusClass = 'inventory-critical';
                        statusText = '‚ö†Ô∏è Need Ordered';
                        onHandClass = 'onhand-critical';
                    }
                }
                
                const row = document.createElement('tr');
                row.onclick = () => editComponent(name);
                row.innerHTML = `
                    <td><strong>${name}</strong></td>
                    <td>${needed}</td>
                    <td><span class="${onHandClass}">${comp.onHand}</span></td>
                    <td>${comp.onOrder}</td>
                    <td>${comp.eta}</td>
                    <td><strong>${totalAvailable}</strong></td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function calculateKitsCanMake(kitName) {
            const kit = kits[kitName];
            if (!kit) return 0;
            
            let minCanMake = Infinity;
            for (const [componentName, qtyNeeded] of Object.entries(kit.components)) {
                const comp = components[componentName];
                if (!comp) return 0;
                const canMake = Math.floor(comp.onHand / qtyNeeded);
                minCanMake = Math.min(minCanMake, canMake);
            }
            return minCanMake === Infinity ? 0 : minCanMake;
        }
        
        function renderKits() {
            const tbody = document.getElementById('kitsBody');
            tbody.innerHTML = '';
            
            for (const [kitName, kit] of Object.entries(kits)) {
                const canMake = calculateKitsCanMake(kitName);
                const componentsList = Object.entries(kit.components)
                    .map(([comp, qty]) => `${qty}√ó ${comp}`)
                    .join(', ');
                
                const row = document.createElement('tr');
                row.onclick = () => editKit(kitName);
                row.innerHTML = `
                    <td><strong>${kitName}</strong></td>
                    <td>${componentsList}</td>
                    <td>$${(kit.cost || 0).toFixed(2)}</td>
                    <td>$${(kit.price || 0).toFixed(2)}</td>
                    <td><strong>${canMake}</strong></td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function renderShippedOrders() {
            const tbody = document.getElementById('shippedBody');
            tbody.innerHTML = '';
            const shippedOrders = orders.filter(o => o.shipped);
            if (shippedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No shipped orders yet</td></tr>';
                return;
            }
            shippedOrders.forEach((order) => {
                let amount = 0;
                const items = [];
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        items.push(`${qty} ${kitName}`);
                        amount += qty * (kit.price || 0);
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${order.name}</strong></td>
                    <td>${items.join(', ')}</td>
                    <td><strong>$${amount.toFixed(2)}</strong></td>
                    <td>${order.tracking || 'N/A'}</td>
                    <td><button class="btn btn-small btn-danger" onclick="event.stopPropagation(); unshipOrder(${order.id})">Unship</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Order Modal Functions
        function showNewOrderModal() {
            currentEditOrderId = null;
            document.getElementById('orderModalTitle').textContent = 'Add New Order';
            document.getElementById('orderModalSaveBtn').textContent = 'Add Order';
            document.getElementById('orderModalSaveBtn').onclick = addNewOrder;
            document.getElementById('orderModalDeleteBtn').style.display = 'none';
            document.getElementById('orderModalShipBtn').style.display = 'none';
            document.getElementById('newOrderName').value = '';
            document.getElementById('newOrderPaid').checked = false;
            
            const summaryView = document.getElementById('orderSummaryView');
            if (summaryView) summaryView.style.display = 'block';
            
            const kitsContainer = document.getElementById('orderKitsContainer');
            if (kitsContainer) kitsContainer.style.display = 'none';
            
            renderOrderKitsInputs({});
            updateOrderSummary();
            renderOrderProductsList();
            
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function closeNewOrderModal() {
            document.getElementById('newOrderModal').classList.remove('active');
        }
        
        function renderOrderKitsInputs(orderData = {}) {
            const container = document.getElementById('orderKitsContainer');
            container.innerHTML = '';
            
            for (const [kitName] of Object.entries(kits)) {
                const qty = orderData[kitName.toLowerCase()] || 0;
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.innerHTML = `
                    <label>${kitName} Quantity</label>
                    <input type="number" id="orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${qty}" min="0" onchange="updateOrderSummary()">
                `;
                container.appendChild(formGroup);
            }
        }
        
        function updateOrderSummary() {
            let totalAmount = 0;
            const selectedKits = [];
            const componentsNeeded = {};
            
            for (const [kitName, kit] of Object.entries(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                const qty = parseInt(input?.value) || 0;
                
                if (qty > 0) {
                    totalAmount += qty * (kit.price || 0);
                    selectedKits.push({ name: kitName, qty, price: kit.price });
                    
                    for (const [componentName, componentQty] of Object.entries(kit.components)) {
                        componentsNeeded[componentName] = (componentsNeeded[componentName] || 0) + (componentQty * qty);
                    }
                }
            }
            
            const summaryContent = document.getElementById('orderSummaryContent');
            if (!summaryContent) return;
            
            if (selectedKits.length === 0) {
                summaryContent.innerHTML = '<div style="color: #999;">No products selected</div>';
            } else {
                summaryContent.innerHTML = selectedKits.map(kit => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                        <span>${kit.qty}√ó ${kit.name}</span>
                        <span style="color: #667eea; font-weight: 600;">$${(kit.qty * kit.price).toFixed(2)}</span>
                    </div>
                `).join('');
            }
            
            const totalElement = document.getElementById('orderSummaryTotal');
            if (totalElement) {
                totalElement.textContent = `$${totalAmount.toFixed(2)}`;
            }
            
            const componentsDiv = document.getElementById('orderComponentsNeeded');
            if (componentsDiv) {
                if (Object.keys(componentsNeeded).length === 0) {
                    componentsDiv.innerHTML = '<div style="color: #999;">No components needed</div>';
                } else {
                    componentsDiv.innerHTML = Object.entries(componentsNeeded).map(([name, qty]) => `
                        <div style="padding: 6px 0; border-bottom: 1px solid #e5e7eb;">
                            <span style="font-weight: 600;">${qty}√ó</span> ${name}
                        </div>
                    `).join('');
                }
            }
            
            const statusDiv = document.getElementById('orderInventoryStatus');
            if (statusDiv) {
                if (Object.keys(componentsNeeded).length === 0) {
                    statusDiv.innerHTML = '<div style="color: #999;">-</div>';
                } else {
                    let allAvailable = true;
                    const statusHTML = Object.entries(componentsNeeded).map(([name, needed]) => {
                        const comp = components[name];
                        if (!comp) {
                            allAvailable = false;
                            return `<div style="padding: 6px 0; color: #ef4444;">‚úó ${name} - Component not found</div>`;
                        }
                        
                        const available = comp.onHand >= needed;
                        if (!available) allAvailable = false;
                        
                        return `
                            <div style="padding: 6px 0; display: flex; justify-content: space-between;">
                                <span>${name}</span>
                                <span style="color: ${available ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                    ${available ? '‚úì' : '‚úó'} ${comp.onHand} / ${needed} available
                                </span>
                            </div>
                        `;
                    }).join('');
                    
                    statusDiv.innerHTML = statusHTML;
                    
                    if (allAvailable && Object.keys(componentsNeeded).length > 0) {
                        statusDiv.innerHTML += '<div style="margin-top: 10px; padding: 10px; background: #d1fae5; color: #065f46; border-radius: 6px; font-weight: 600; text-align: center;">‚úì All components available - Ready to build!</div>';
                    } else if (Object.keys(componentsNeeded).length > 0) {
                        statusDiv.innerHTML += '<div style="margin-top: 10px; padding: 10px; background: #fee2e2; color: #991b1b; border-radius: 6px; font-weight: 600; text-align: center;">‚ö† Missing components - Cannot fulfill yet</div>';
                    }
                }
            }
        }
        
        function renderOrderProductsList() {
            const container = document.getElementById('orderProductsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            let hasProducts = false;
            for (const [kitName] of Object.entries(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (!input) continue;
                
                const qty = parseInt(input.value) || 0;
                
                if (qty > 0) {
                    hasProducts = true;
                    const productRow = document.createElement('div');
                    productRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;';
                    productRow.innerHTML = `
                        <div style="flex: 1;">
                            <strong>${kitName}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                <input type="number" value="${qty}" min="1" style="width: 60px; padding: 4px; border: 2px solid #e5e7eb; border-radius: 4px;" onchange="updateProductQuantity('${kitName}', this.value)"> units
                            </div>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="removeProductFromOrder('${kitName}')">Remove</button>
                    `;
                    container.appendChild(productRow);
                }
            }
            
            if (!hasProducts) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No products in this order. Click "+ Add Product" to add one.</div>';
            }
        }
        
        function showAddProductToOrder() {
            const availableProducts = [];
            for (const [kitName] of Object.entries(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                const qty = parseInt(input?.value) || 0;
                if (qty === 0) {
                    availableProducts.push(kitName);
                }
            }
            
            if (availableProducts.length === 0) {
                alert('All products are already in this order!');
                return;
            }
            
            const product = prompt(`Select product to add:\n${availableProducts.map((p, i) => `${i + 1}. ${p}`).join('\n')}\n\nEnter product name:`);
            
            if (product && availableProducts.some(p => p.toLowerCase() === product.toLowerCase())) {
                const kitName = availableProducts.find(p => p.toLowerCase() === product.toLowerCase());
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (input) {
                    input.value = '1';
                    updateOrderSummary();
                    renderOrderProductsList();
                }
            } else if (product) {
                alert('Product not found. Please enter an exact product name.');
            }
        }
        
        function updateProductQuantity(kitName, newQty) {
            const qty = parseInt(newQty) || 0;
            const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (input) {
                input.value = qty;
                updateOrderSummary();
                
                if (qty === 0) {
                    renderOrderProductsList();
                }
            }
        }
        
        function removeProductFromOrder(kitName) {
            const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (input) {
                input.value = '0';
                updateOrderSummary();
                renderOrderProductsList();
            }
        }
        
        function addNewOrder() {
            const name = document.getElementById('newOrderName').value.trim();
            const paid = document.getElementById('newOrderPaid').checked;
            
            if (!name) { 
                alert('Please enter a customer name'); 
                return; 
            }
            
            const newOrder = { 
                id: nextOrderId++, 
                name, 
                paid, 
                shipped: false, 
                tracking: "" 
            };
            
            let hasAnyQuantity = false;
            for (const kitName of Object.keys(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                const qty = parseInt(input?.value) || 0;
                newOrder[kitName.toLowerCase()] = qty;
                if (qty > 0) hasAnyQuantity = true;
            }
            
            if (!hasAnyQuantity) { 
                alert('Please select at least one product'); 
                return; 
            }
            
            orders.push(newOrder);
            closeNewOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order added');
        }
        
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            currentEditOrderId = orderId;
            document.getElementById('orderModalTitle').textContent = 'Edit Order - ' + order.name;
            document.getElementById('newOrderName').value = order.name;
            
            const orderData = {};
            for (const kitName of Object.keys(kits)) {
                orderData[kitName.toLowerCase()] = order[kitName.toLowerCase()] || 0;
            }
            
            document.getElementById('orderKitsContainer').style.display = 'none';
            
            renderOrderKitsInputs(orderData);
            
            document.getElementById('newOrderPaid').checked = order.paid;
            
            document.getElementById('orderSummaryView').style.display = 'block';
            updateOrderSummary();
            renderOrderProductsList();
            
            document.getElementById('orderModalSaveBtn').textContent = 'Save Changes';
            document.getElementById('orderModalSaveBtn').onclick = saveOrderEdit;
            document.getElementById('orderModalDeleteBtn').style.display = 'inline-block';
            
            const ready = canFulfillOrder(order);
            if (order.paid && ready) {
                document.getElementById('orderModalShipBtn').style.display = 'inline-block';
            } else {
                document.getElementById('orderModalShipBtn').style.display = 'none';
            }
            
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function saveOrderEdit() {
            if (!currentEditOrderId) return;
            
            const order = orders.find(o => o.id === currentEditOrderId);
            if (!order) return;
            
            order.name = document.getElementById('newOrderName').value.trim();
            order.paid = document.getElementById('newOrderPaid').checked;
            
            for (const kitName of Object.keys(kits)) {
                const input = document.getElementById('orderKit_' + kitName.replace(/[^a-zA-Z0-9]/g, '_'));
                order[kitName.toLowerCase()] = parseInt(input.value) || 0;
            }
            
            closeNewOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order updated');
        }
        
        function deleteCurrentOrder() {
            if (!currentEditOrderId) return;
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            const index = orders.findIndex(o => o.id === currentEditOrderId);
            if (index > -1) {
                orders.splice(index, 1);
            }
            
            closeNewOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order deleted');
        }
        
        function showShipOrderModalFromEdit() {
            if (!currentEditOrderId) return;
            
            currentShipOrderId = currentEditOrderId;
            const order = orders.find(o => o.id === currentShipOrderId);
            if (!order) return;
            
            closeNewOrderModal();
            
            document.getElementById('shipOrderCustomer').textContent = `Shipping order for ${order.name}`;
            document.getElementById('shipOrderTracking').value = order.tracking || '';
            document.getElementById('shipOrderModal').classList.add('active');
        }
        
        function closeShipOrderModal() {
            document.getElementById('shipOrderModal').classList.remove('active');
        }
        
        function confirmShipOrder() {
            if (!currentShipOrderId) return;
            
            const order = orders.find(o => o.id === currentShipOrderId);
            if (!order) return;
            
            const tracking = document.getElementById('shipOrderTracking').value.trim();
            order.shipped = true;
            order.tracking = tracking;
            
            closeShipOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order shipped!');
        }
        
        function unshipOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.shipped = false;
            order.tracking = '';
            
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order unshipped');
        }
        
        // Component Modal Functions
        function showNewComponentModal() {
            currentEditComponent = null;
            document.getElementById('componentModalTitle').textContent = 'Add New Component';
            document.getElementById('editComponentName').value = '';
            document.getElementById('editComponentName').disabled = false;
            document.getElementById('editComponentOnHand').value = '0';
            document.getElementById('editComponentOnOrder').value = '0';
            document.getElementById('editComponentEta').value = '';
            document.getElementById('editComponentCostType').value = 'piece';
            document.getElementById('editComponentCostPiece').value = '';
            document.getElementById('editComponentBoxSize').value = '';
            document.getElementById('editComponentCostBox').value = '';
            toggleCostFields();
            document.getElementById('componentDeleteBtn').style.display = 'none';
            document.getElementById('editComponentModal').classList.add('active');
        }
        
        function closeEditComponentModal() {
            document.getElementById('editComponentModal').classList.remove('active');
            currentEditComponent = null;
        }
        
        function toggleCostFields() {
            const costType = document.getElementById('editComponentCostType').value;
            const pieceCostGroup = document.getElementById('pieceCostGroup');
            const boxCostGroup = document.getElementById('boxCostGroup');
            
            if (costType === 'box') {
                pieceCostGroup.style.display = 'none';
                boxCostGroup.style.display = 'block';
            } else {
                pieceCostGroup.style.display = 'block';
                boxCostGroup.style.display = 'none';
            }
        }
        
        function saveComponentEdit() {
            const name = document.getElementById('editComponentName').value.trim();
            const onHand = parseInt(document.getElementById('editComponentOnHand').value) || 0;
            const onOrder = parseInt(document.getElementById('editComponentOnOrder').value) || 0;
            const eta = document.getElementById('editComponentEta').value.trim();
            const costType = document.getElementById('editComponentCostType').value;
            
            if (!name) {
                alert('Please enter a component name');
                return;
            }
            
            let costData = { costType };
            if (costType === 'piece') {
                const costPerPiece = parseFloat(document.getElementById('editComponentCostPiece').value) || 0;
                costData.costPerPiece = costPerPiece;
            } else {
                const boxSize = parseInt(document.getElementById('editComponentBoxSize').value) || 0;
                const costPerBox = parseFloat(document.getElementById('editComponentCostBox').value) || 0;
                if (boxSize <= 0) {
                    alert('Please enter a valid box/pack size');
                    return;
                }
                costData.boxSize = boxSize;
                costData.costPerBox = costPerBox;
            }
            
            if (currentEditComponent && currentEditComponent !== name) {
                alert('Cannot rename components. Please delete and create a new one.');
                return;
            }
            
            if (!currentEditComponent) {
                components[name] = {
                    onHand,
                    onOrder,
                    eta,
                    ...costData
                };
            } else {
                const comp = components[currentEditComponent];
                comp.onHand = onHand;
                comp.onOrder = onOrder;
                comp.eta = eta;
                Object.assign(comp, costData);
            }
            
            closeEditComponentModal();
            saveToLocalStorage();
            syncToFirebase();
            renderInventory();
            renderOrders();
            showToast('Component saved');
        }
        
        function editComponent(componentName) {
            currentEditComponent = componentName;
            const comp = components[componentName];
            
            document.getElementById('componentModalTitle').textContent = `Edit ${componentName}`;
            document.getElementById('editComponentName').value = componentName;
            document.getElementById('editComponentName').disabled = true;
            document.getElementById('editComponentOnHand').value = comp.onHand;
            document.getElementById('editComponentOnOrder').value = comp.onOrder;
            document.getElementById('editComponentEta').value = comp.eta;
            
            document.getElementById('editComponentCostType').value = comp.costType || 'piece';
            if (comp.costType === 'box') {
                document.getElementById('editComponentBoxSize').value = comp.boxSize || '';
                document.getElementById('editComponentCostBox').value = comp.costPerBox || '';
                document.getElementById('editComponentCostPiece').value = '';
            } else {
                document.getElementById('editComponentCostPiece').value = comp.costPerPiece || '';
                document.getElementById('editComponentBoxSize').value = '';
                document.getElementById('editComponentCostBox').value = '';
            }
            toggleCostFields();
            
            document.getElementById('componentDeleteBtn').style.display = 'inline-block';
            document.getElementById('editComponentModal').classList.add('active');
        }
        
        function deleteCurrentComponent() {
            if (!currentEditComponent) return;
            if (!confirm(`Are you sure you want to delete ${currentEditComponent}?`)) return;
            
            for (const [kitName, kit] of Object.entries(kits)) {
                if (kit.components[currentEditComponent]) {
                    alert(`Cannot delete ${currentEditComponent} because it's used in the ${kitName} kit.`);
                    return;
                }
            }
            
            delete components[currentEditComponent];
            
            closeEditComponentModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Component deleted');
        }
        
        // Kit Modal Functions
        function showNewKitModal() {
            currentEditKit = null;
            document.getElementById('kitModalTitle').textContent = 'Add New Kit';
            document.getElementById('newKitName').value = '';
            document.getElementById('newKitName').disabled = false;
            document.getElementById('newKitCost').value = '';
            document.getElementById('newKitPrice').value = '';
            document.getElementById('kitModalSaveBtn').textContent = 'Add Kit';
            document.getElementById('kitModalSaveBtn').onclick = addNewKit;
            document.getElementById('kitModalDeleteBtn').style.display = 'none';
            
            renderKitComponentsList({});
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function closeNewKitModal() {
            document.getElementById('newKitModal').classList.remove('active');
            currentEditKit = null;
        }
        
        function renderKitComponentsList(selectedComponents) {
            const container = document.getElementById('kitComponentsList');
            container.innerHTML = '';
            
            for (const [componentName] of Object.entries(components)) {
                const qty = selectedComponents[componentName] || 0;
                const div = document.createElement('div');
                div.className = 'component-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="kit_${componentName.replace(/[^a-zA-Z0-9]/g, '_')}" ${qty > 0 ? 'checked' : ''} 
                           onchange="toggleKitComponent('${componentName.replace(/'/g, "\\'")}')">
                    <label for="kit_${componentName.replace(/[^a-zA-Z0-9]/g, '_')}" style="flex: 1;">${componentName}</label>
                    <input type="number" id="qty_${componentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${qty}" min="1" 
                           style="width: 60px;" placeholder="Qty">
                `;
                container.appendChild(div);
            }
        }
        
        function toggleKitComponent(componentName) {
            const safeId = componentName.replace(/[^a-zA-Z0-9]/g, '_');
            const checkbox = document.getElementById(`kit_${safeId}`);
            const qtyInput = document.getElementById(`qty_${safeId}`);
            if (!checkbox.checked) {
                qtyInput.value = '0';
            } else if (qtyInput.value === '0' || qtyInput.value === '') {
                qtyInput.value = '1';
            }
        }
        
        function calculateKitCost(kitComponents) {
            let totalCost = 0;
            for (const [componentName, qty] of Object.entries(kitComponents)) {
                const comp = components[componentName];
                if (!comp) continue;
                
                if (comp.costType === 'piece') {
                    totalCost += (comp.costPerPiece || 0) * qty;
                } else if (comp.costType === 'box') {
                    const costPerPiece = (comp.costPerBox || 0) / (comp.boxSize || 1);
                    totalCost += costPerPiece * qty;
                }
            }
            return totalCost;
        }
        
        function addNewKit() {
            const name = document.getElementById('newKitName').value.trim();
            const cost = parseFloat(document.getElementById('newKitCost').value) || 0;
            const price = parseFloat(document.getElementById('newKitPrice').value) || 0;
            const selectedComponents = {};
            
            if (!name) {
                alert('Please enter a kit name');
                return;
            }
            
            for (const [componentName] of Object.entries(components)) {
                const safeId = componentName.replace(/[^a-zA-Z0-9]/g, '_');
                const checkbox = document.getElementById(`kit_${safeId}`);
                const qtyInput = document.getElementById(`qty_${safeId}`);
                if (checkbox && checkbox.checked) {
                    const qty = parseInt(qtyInput.value) || 1;
                    selectedComponents[componentName] = qty;
                }
            }
            
            if (Object.keys(selectedComponents).length === 0) {
                alert('Please select at least one component');
                return;
            }
            
            const calculatedCost = calculateKitCost(selectedComponents);
            
            kits[name] = {
                cost: cost > 0 ? cost : calculatedCost,
                price: price,
                components: selectedComponents
            };
            
            closeNewKitModal();
            saveToLocalStorage();
            syncToFirebase();
            renderKits();
            showToast('Kit added');
        }
        
        function editKit(kitName) {
            const kit = kits[kitName];
            if (!kit) return;
            
            currentEditKit = kitName;
            const autoCalculatedCost = calculateKitCost(kit.components);
            
            document.getElementById('kitModalTitle').textContent = `Edit ${kitName} Kit`;
            document.getElementById('newKitName').value = kitName;
            document.getElementById('newKitName').disabled = true;
            document.getElementById('newKitCost').value = kit.cost || autoCalculatedCost.toFixed(2);
            document.getElementById('newKitCost').placeholder = `Auto: ${autoCalculatedCost.toFixed(2)}`;
            document.getElementById('newKitPrice').value = kit.price || '';
            document.getElementById('kitModalSaveBtn').textContent = 'Save Changes';
            document.getElementById('kitModalSaveBtn').onclick = saveKitEdit;
            document.getElementById('kitModalDeleteBtn').style.display = 'inline-block';
            
            renderKitComponentsList(kit.components);
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function saveKitEdit() {
            if (!currentEditKit) return;
            
            const kit = kits[currentEditKit];
            const cost = parseFloat(document.getElementById('newKitCost').value) || 0;
            const price = parseFloat(document.getElementById('newKitPrice').value) || 0;
            const selectedComponents = {};
            
            for (const [componentName] of Object.entries(components)) {
                const safeId = componentName.replace(/[^a-zA-Z0-9]/g, '_');
                const checkbox = document.getElementById(`kit_${safeId}`);
                const qtyInput = document.getElementById(`qty_${safeId}`);
                if (checkbox && checkbox.checked) {
                    const qty = parseInt(qtyInput.value) || 1;
                    selectedComponents[componentName] = qty;
                }
            }
            
            if (Object.keys(selectedComponents).length === 0) {
                alert('Please select at least one component');
                return;
            }
            
            const calculatedCost = calculateKitCost(selectedComponents);
            
            kit.cost = cost > 0 ? cost : calculatedCost;
            kit.price = price;
            kit.components = selectedComponents;
            
            closeNewKitModal();
            saveToLocalStorage();
            syncToFirebase();
            renderKits();
            showToast('Kit updated');
        }
        
        function deleteCurrentKit() {
            if (!currentEditKit) return;
            if (!confirm(`Are you sure you want to delete the ${currentEditKit} kit?`)) return;
            
            delete kits[currentEditKit];
            
            closeNewKitModal();
            saveToLocalStorage();
            syncToFirebase();
            renderKits();
            renderOrders();
            showToast('Kit deleted');
        }
        
        // Initialize
        window.showNewOrderModal = showNewOrderModal;
        window.closeNewOrderModal = closeNewOrderModal;
        window.addNewOrder = addNewOrder;
        window.editOrder = editOrder;
        window.saveOrderEdit = saveOrderEdit;
        window.deleteCurrentOrder = deleteCurrentOrder;
        window.showShipOrderModalFromEdit = showShipOrderModalFromEdit;
        window.closeShipOrderModal = closeShipOrderModal;
        window.confirmShipOrder = confirmShipOrder;
        window.unshipOrder = unshipOrder;
        window.showAddProductToOrder = showAddProductToOrder;
        window.updateProductQuantity = updateProductQuantity;
        window.removeProductFromOrder = removeProductFromOrder;
        window.updateOrderSummary = updateOrderSummary;
        window.showNewComponentModal = showNewComponentModal;
        window.closeEditComponentModal = closeEditComponentModal;
        window.toggleCostFields = toggleCostFields;
        window.saveComponentEdit = saveComponentEdit;
        window.editComponent = editComponent;
        window.deleteCurrentComponent = deleteCurrentComponent;
        window.showNewKitModal = showNewKitModal;
        window.closeNewKitModal = closeNewKitModal;
        window.toggleKitComponent = toggleKitComponent;
        window.addNewKit = addNewKit;
        window.editKit = editKit;
        window.saveKitEdit = saveKitEdit;
        window.deleteCurrentKit = deleteCurrentKit;
        window.handleCSVImport = handleCSVImport;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.manualSync = manualSync;
        window.initializeApp = initializeApp;
    </script>
</body>
</html>
