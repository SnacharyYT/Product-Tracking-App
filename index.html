<!DOCTYPE html>
<html lang="en">
<!--
Budget Build Club Inventory Manager
Version: 2.3.0
Last Updated: 2025-10-31

CHANGELOG (v2.3.0):
- NEW: Order number displayed in shipped orders table
- NEW: Order number shown in order summary card
- NEW: Shipping cost from Shopify CSV added to order summary
- NEW: Time period filter for dashboard metrics (Current, Since Last Update, Last Month, This Year, All Time)
- NEW: "Make" type components have different source options (CNC, 3D Print, Other)
- NEW: Custom source input - add your own sources to dropdowns
- IMPROVED: Inventory status hidden for shipped orders in summary
- IMPROVED: Source dropdowns are context-aware based on component type
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Build Club Inventory Manager v2.3.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .login-box h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }
        
        .login-box p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .error-message.show { display: block; }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .remember-me input[type="checkbox"] { width: auto; }
        
        /* App Container */
        .app-container { display: none; }
        .app-container.show { display: block; }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .version-badge {
            position: absolute;
            top: 15px;
            left: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.3);
            letter-spacing: 0.5px;
        }
        
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: background 0.2s;
            color: white;
            border: none;
        }
        
        .logout-btn:hover { background: rgba(255, 255, 255, 0.3); }
        
        .firebase-status-pill {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 10px;
            cursor: pointer;
        }
        
        .firebase-status-pill.connected { background: rgba(16, 185, 129, 0.9); }
        .firebase-status-pill.offline { background: rgba(107, 114, 128, 0.9); }
        .firebase-status-pill.syncing { background: rgba(245, 158, 11, 0.9); }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .header h1:hover { opacity: 0.9; }
        
        .header h1.editing {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 8px;
            outline: 2px solid white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .value::before { content: attr(data-prefix); }
        
        .stat-card .subvalue {
            font-size: 14px;
            color: #999;
            margin-top: 4px;
        }
        
        .period-filter {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .period-filter label {
            font-weight: 600;
            color: #555;
        }
        
        .period-filter select {
            padding: 8px 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            background: white;
        }
        
        .content { padding: 30px; }
        
        .section { margin-bottom: 40px; }
        
        .section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .section h3 {
            font-size: 18px;
            margin: 20px 0 10px 0;
            color: #555;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .btn-small { padding: 4px 10px; font-size: 12px; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr { cursor: pointer; }
        tbody tr:hover { opacity: 0.85; }
        
        .status-paid {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-paid.awaiting { background: #f59e0b; }
        .status-unpaid { background: #ef4444; color: white; padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        
        .onhand-ok { background: #d1fae5; color: #065f46; font-weight: bold; padding: 8px; border-radius: 6px; }
        .onhand-low { background: #fed7aa; color: #92400e; font-weight: bold; padding: 8px; border-radius: 6px; }
        .onhand-critical { background: #fecaca; color: #991b1b; font-weight: bold; padding: 8px; border-radius: 6px; }
        .inventory-ok { color: #10b981; font-weight: bold; }
        .inventory-low { color: #f59e0b; font-weight: bold; }
        .inventory-critical { color: #ef4444; font-weight: bold; }
        
        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .type-purchased {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .type-make {
            background: #fce7f3;
            color: #9f1239;
        }
        
        .shopping-list-alert {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .shopping-list-alert h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .shopping-list-empty {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #065f46;
        }
        
        .part-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .part-link:hover {
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 { margin-bottom: 20px; color: #333; }
        
        .form-group { margin-bottom: 20px; }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .component-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .component-checkbox input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 2px solid #e5e7eb;
            border-radius: 4px;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            transform: translateY(150px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .filter-controls label {
            font-weight: 600;
            color: #555;
        }
        
        .filter-controls select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>
    
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>üîí Login Required</h1>
            <p>Budget Build Club Inventory Manager v2.3.0</p>
            
            <div id="loginError" class="error-message"></div>
            
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            
            <div class="remember-me">
                <input type="checkbox" id="rememberMe" checked>
                <label for="rememberMe">Remember me</label>
            </div>
            
            <button class="btn" id="loginBtn" onclick="handleLogin()">Sign In</button>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appContainer" class="app-container">
        <div class="container">
            <div class="header">
                <div class="version-badge">v2.3.0</div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
                <h1 id="businessName" contenteditable="true" onclick="selectAllText(this)" onblur="saveBusinessName()" onkeydown="handleBusinessNameKeypress(event)">üõ†Ô∏è COP Kits Inventory Manager</h1>
                <p>Track orders, inventory, and profits in real-time</p>
                <div id="firebaseStatus" class="firebase-status-pill offline" onclick="manualSync()">
                    <span id="firebaseStatusText">Offline Mode</span>
                </div>
            </div>
            
            <div class="period-filter">
                <label>üìä Time Period:</label>
                <select id="periodFilter" onchange="updatePeriodFilter()">
                    <option value="current">Current (Active Orders)</option>
                    <option value="last_update">Since Last Update</option>
                    <option value="last_month">Last Month</option>
                    <option value="this_year">This Year</option>
                    <option value="all_time">All Time</option>
                </select>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <div class="value" id="totalOrders">0</div>
                    <div class="subvalue" id="totalOrdersSub">Active orders</div>
                </div>
                <div class="stat-card">
                    <h3>Ready to Ship</h3>
                    <div class="value" id="readyToShip">0</div>
                    <div class="subvalue" id="readyPercentage">0% ready</div>
                </div>
                <div class="stat-card">
                    <h3>Paid Orders</h3>
                    <div class="value" id="paidOrders">0</div>
                    <div class="subvalue" id="paidPercentage">0%</div>
                </div>
                <div class="stat-card">
                    <h3>Revenue Collected</h3>
                    <div class="value" id="revenueCollected" style="color: #10b981;" data-prefix="$">0</div>
                    <div class="subvalue" id="revenueTotal">of $0 total</div>
                </div>
                <div class="stat-card">
                    <h3>Total Profit</h3>
                    <div class="value" id="totalProfit" style="color: #10b981;" data-prefix="$">0</div>
                    <div class="subvalue" id="profitMargin">0% margin</div>
                </div>
                <div class="stat-card">
                    <h3>Total Costs</h3>
                    <div class="value" id="totalCosts" style="color: #ef4444;" data-prefix="$">0</div>
                    <div class="subvalue">Materials + Shipping</div>
                </div>
            </div>
            
            <div class="content">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin-bottom: 0;">üì¶ Orders</h2>
                        <button class="btn btn-danger" onclick="deleteAllOrders()">üóëÔ∏è Delete All Orders</button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn" onclick="showNewOrderModal()">+ Add New Order</button>
                        <button class="btn" onclick="document.getElementById('csvFileInput').click()">üì• Import from Shopify CSV</button>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="collectionProgress" style="width: 0%">0% Collected</div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; flex-wrap: wrap; justify-content: center;">
                        <div id="ordersSummary" style="display: flex; gap: 15px; flex-wrap: wrap;"></div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 25%;">Customer</th>
                                <th style="width: 15%;">Order #</th>
                                <th style="width: 35%;">Products</th>
                                <th style="width: 25%;">Payment Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>üìä Inventory</h2>
                    
                    <!-- Shopping List Section -->
                    <h3>üõí Shopping List</h3>
                    <div id="shoppingListContainer"></div>
                    
                    <h3>Components</h3>
                    <button class="btn" onclick="showNewComponentModal()" style="margin-bottom: 20px;">+ Add Component</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Type</th>
                                <th>Source</th>
                                <th>Part Number</th>
                                <th>Needed</th>
                                <th>On Hand</th>
                                <th>On Order</th>
                                <th>ETA</th>
                                <th>Total Available</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                    
                    <h3>Kits</h3>
                    <button class="btn" onclick="showNewKitModal()" style="margin-bottom: 20px;">+ Add Kit</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Kit Name</th>
                                <th>Components Required</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Can Make</th>
                            </tr>
                        </thead>
                        <tbody id="kitsBody"></tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>üìÆ Shipped Orders</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Amount</th>
                                <th>Tracking</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shippedBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Modal -->
    <div id="newOrderModal" class="modal">
        <div class="modal-content">
            <h3 id="orderModalTitle">Add New Order</h3>
            
            <!-- Order Info Section -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div id="orderInfoSection"></div>
            </div>
            
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="newOrderName" placeholder="Enter customer name">
            </div>
            
            <div id="orderSummaryView" style="display: none;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Order Summary</h4>
                    <div id="orderSummaryContent"></div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>Total:</strong>
                            <strong id="orderSummaryTotal" style="font-size: 20px; color: #667eea;">$0</strong>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Components Needed</h4>
                    <div id="orderComponentsNeeded"></div>
                </div>
                
                <div id="orderInventoryStatusSection" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Inventory Status</h4>
                    <div id="orderInventoryStatus"></div>
                </div>
                
                <div style="background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333;">Edit Products</h4>
                        <button class="btn btn-small" onclick="showAddProductToOrder()">+ Add Product</button>
                    </div>
                    <div id="orderProductsList"></div>
                </div>
            </div>
            
            <div id="orderKitsContainer" style="display: none;"></div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="newOrderPaid"> Paid
                </label>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeNewOrderModal()">Cancel</button>
                <button class="btn btn-success" id="orderModalSaveBtn" onclick="addNewOrder()">Add Order</button>
                <button class="btn btn-danger" id="orderModalDeleteBtn" onclick="deleteCurrentOrder()" style="display: none;">Delete Order</button>
                <button class="btn btn-success" id="orderModalShipBtn" onclick="showShipOrderModalFromEdit()" style="display: none;">Ship Order</button>
            </div>
        </div>
    </div>
    
    <!-- Component Modal -->
    <div id="editComponentModal" class="modal">
        <div class="modal-content">
            <h3 id="componentModalTitle">Edit Component</h3>
            <div class="form-group">
                <label>Component Name</label>
                <input type="text" id="editComponentName">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="editComponentType" onchange="updateSourceOptions()">
                    <option value="purchased">Purchased</option>
                    <option value="make">Make</option>
                </select>
            </div>
            <div class="form-group">
                <label>Source/Vendor</label>
                <select id="editComponentSource" onchange="handleSourceChange()">
                    <!-- Options populated dynamically -->
                </select>
            </div>
            <div class="form-group" id="customSourceGroup" style="display: none;">
                <label>Custom Source Name</label>
                <input type="text" id="editComponentCustomSource" placeholder="Enter source name">
            </div>
            <div class="form-group">
                <label>Part Number</label>
                <input type="text" id="editComponentPartNumber" placeholder="e.g., B07XYZ1234">
            </div>
            <div class="form-group">
                <label>Product Link (URL)</label>
                <input type="text" id="editComponentProductLink" placeholder="e.g., https://www.amazon.com/...">
            </div>
            <div class="form-group">
                <label>On Hand</label>
                <input type="number" id="editComponentOnHand" min="0">
            </div>
            <div class="form-group">
                <label>On Order</label>
                <input type="number" id="editComponentOnOrder" min="0">
            </div>
            <div class="form-group">
                <label>ETA</label>
                <input type="text" id="editComponentEta" placeholder="e.g., 10/23">
            </div>
            <div class="form-group">
                <label>Cost Type</label>
                <select id="editComponentCostType" onchange="toggleCostFields()">
                    <option value="piece">Per Piece</option>
                    <option value="box">Per Box/Pack</option>
                </select>
            </div>
            <div class="form-group" id="pieceCostGroup">
                <label>Cost Per Piece ($)</label>
                <input type="number" id="editComponentCostPiece" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-group" id="boxCostGroup" style="display: none;">
                <label>Box/Pack Size</label>
                <input type="number" id="editComponentBoxSize" min="1" placeholder="e.g., 50">
                <label style="margin-top: 10px;">Cost Per Box/Pack ($)</label>
                <input type="number" id="editComponentCostBox" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeEditComponentModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveComponentEdit()">Save</button>
                <button class="btn btn-danger" id="componentDeleteBtn" onclick="deleteCurrentComponent()" style="display: none;">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Kit Modal -->
    <div id="newKitModal" class="modal">
        <div class="modal-content">
            <h3 id="kitModalTitle">Add New Kit</h3>
            <div class="form-group">
                <label>Kit Name</label>
                <input type="text" id="newKitName" placeholder="Enter kit name">
            </div>
            <div class="form-group">
                <label>Cost Per Kit ($) - <small>Leave empty to auto-calculate</small></label>
                <input type="number" id="newKitCost" step="0.01" min="0" placeholder="Auto-calculated">
            </div>
            <div class="form-group">
                <label>Sell Price Per Kit ($)</label>
                <input type="number" id="newKitPrice" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Select Components</label>
                <div id="kitComponentsList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px;">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeNewKitModal()">Cancel</button>
                <button class="btn btn-success" id="kitModalSaveBtn" onclick="addNewKit()">Add Kit</button>
                <button class="btn btn-danger" id="kitModalDeleteBtn" onclick="deleteCurrentKit()" style="display: none;">Delete Kit</button>
            </div>
        </div>
    </div>
    
    <!-- Ship Order Modal -->
    <div id="shipOrderModal" class="modal">
        <div class="modal-content">
            <h3>Ship Order</h3>
            <p id="shipOrderCustomer"></p>
            <div id="shipOrderWarning" style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                <strong style="color: #92400e;">‚ö†Ô∏è Warning:</strong>
                <div id="shipOrderWarningText" style="color: #92400e; margin-top: 8px;"></div>
            </div>
            <div class="form-group">
                <label>Tracking Number</label>
                <input type="text" id="shipOrderTracking" placeholder="Enter tracking number">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeShipOrderModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmShipOrder()">Mark as Shipped</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, writeBatch, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAOyGTs-fGXuY08pmmCIxLtB_02_gFwMJs",
            authDomain: "inventory-464e0.firebaseapp.com",
            projectId: "inventory-464e0",
            storageBucket: "inventory-464e0.firebasestorage.app",
            messagingSenderId: "1042168855557",
            appId: "1:1042168855557:web:1165defaf0bee779e8706c"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        setPersistence(auth, browserLocalPersistence);
        enableIndexedDbPersistence(db).catch((err) => {
            console.log('Persistence error:', err.code);
        });
        
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.firebaseCollection = collection;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseWriteBatch = writeBatch;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.firebaseReady = true;
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User authenticated:', user.email);
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').classList.add('show');
                window.initializeApp();
            } else {
                console.log('User not authenticated');
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('appContainer').classList.remove('show');
            }
        });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        const APP_VERSION = '2.3.0';
        let orders = [];
        let components = {};
        let kits = {};
        let nextOrderId = 1;
        let currentEditOrderId = null;
        let currentEditComponent = null;
        let currentEditKit = null;
        let currentShipOrderId = null;
        let firebaseAvailable = false;
        let shoppingListFilter = 'all';
        let businessName = 'üõ†Ô∏è COP Kits Inventory Manager';
        let currentPeriod = 'current';
        let lastUpdateDate = null;
        
        // Custom sources
        let customPurchasedSources = [];
        let customMakeSources = [];
        
        // Kit name mapping for Shopify CSV import
        const KIT_NAME_MAP = {
            'KA24DE Coil On Plug Mounting Plate - S13 (3 Valve Cover Bolts)': 'S13',
            'KA24DE Coil On Plug Mounting Plate - S14 (2 Valve Cover Bolts)': 'S14',
            'KA24 S13 Distributor Cap Cover': 'Cap',
            'Toyota 1JZ/2JZ Smart Coil (1NZ) Bracket - Single': '1NZ COP Adapter',
            '2JZ-GE to 2JZ-GTE FFFIM Adapter - 2JZ': '2JZ Intake Adapter'
        };
        
        // Business name functions
        function selectAllText(element) {
            const range = document.createRange();
            range.selectNodeContents(element);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
        
        function handleBusinessNameKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.target.blur();
            }
        }
        
        function saveBusinessName() {
            const nameElement = document.getElementById('businessName');
            businessName = nameElement.textContent.trim();
            if (!businessName) {
                businessName = 'üõ†Ô∏è COP Kits Inventory Manager';
                nameElement.textContent = businessName;
            }
            localStorage.setItem('bbc_businessName', businessName);
            syncToFirebase();
            showToast('Business name updated');
        }
        
        function loadBusinessName() {
            const saved = localStorage.getItem('bbc_businessName');
            if (saved) {
                businessName = saved;
                document.getElementById('businessName').textContent = businessName;
            }
        }
        
        // Period filter functions
        function updatePeriodFilter() {
            currentPeriod = document.getElementById('periodFilter').value;
            localStorage.setItem('bbc_currentPeriod', currentPeriod);
            updateStats();
        }
        
        function loadPeriodFilter() {
            const saved = localStorage.getItem('bbc_currentPeriod');
            if (saved) {
                currentPeriod = saved;
                document.getElementById('periodFilter').value = currentPeriod;
            }
        }
        
        function getFilteredOrders() {
            const now = new Date();
            
            switch(currentPeriod) {
                case 'current':
                    return orders.filter(o => !o.shipped);
                    
                case 'last_update':
                    if (!lastUpdateDate) return orders;
                    return orders.filter(o => {
                        const orderDate = o.createdAt ? new Date(o.createdAt) : new Date(0);
                        return orderDate >= lastUpdateDate;
                    });
                    
                case 'last_month':
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    return orders.filter(o => {
                        const orderDate = o.createdAt ? new Date(o.createdAt) : new Date(0);
                        return orderDate >= lastMonth && orderDate < thisMonth;
                    });
                    
                case 'this_year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    return orders.filter(o => {
                        const orderDate = o.createdAt ? new Date(o.createdAt) : new Date(0);
                        return orderDate >= yearStart;
                    });
                    
                case 'all_time':
                    return orders;
                    
                default:
                    return orders.filter(o => !o.shipped);
            }
        }
        
        // Source options management
        function updateSourceOptions() {
            const type = document.getElementById('editComponentType').value;
            const sourceSelect = document.getElementById('editComponentSource');
            const customSourceGroup = document.getElementById('customSourceGroup');
            
            sourceSelect.innerHTML = '';
            
            if (type === 'purchased') {
                const defaultSources = ['Amazon', 'McMaster', 'SendCutSend'];
                [...defaultSources, ...customPurchasedSources, 'Other'].forEach(source => {
                    const option = document.createElement('option');
                    option.value = source;
                    option.textContent = source;
                    sourceSelect.appendChild(option);
                });
            } else if (type === 'make') {
                const defaultSources = ['CNC', '3D Print'];
                [...defaultSources, ...customMakeSources, 'Other'].forEach(source => {
                    const option = document.createElement('option');
                    option.value = source;
                    option.textContent = source;
                    sourceSelect.appendChild(option);
                });
            }
            
            customSourceGroup.style.display = 'none';
        }
        
        function handleSourceChange() {
            const source = document.getElementById('editComponentSource').value;
            const customSourceGroup = document.getElementById('customSourceGroup');
            
            if (source === 'Other') {
                customSourceGroup.style.display = 'block';
            } else {
                customSourceGroup.style.display = 'none';
                document.getElementById('editComponentCustomSource').value = '';
            }
        }
        
        function addCustomSource(type, sourceName) {
            if (type === 'purchased') {
                if (!customPurchasedSources.includes(sourceName)) {
                    customPurchasedSources.push(sourceName);
                    customPurchasedSources.sort();
                }
            } else if (type === 'make') {
                if (!customMakeSources.includes(sourceName)) {
                    customMakeSources.push(sourceName);
                    customMakeSources.sort();
                }
            }
            
            localStorage.setItem('bbc_customPurchasedSources', JSON.stringify(customPurchasedSources));
            localStorage.setItem('bbc_customMakeSources', JSON.stringify(customMakeSources));
        }
        
        function loadCustomSources() {
            const savedPurchased = localStorage.getItem('bbc_customPurchasedSources');
            const savedMake = localStorage.getItem('bbc_customMakeSources');
            
            if (savedPurchased) customPurchasedSources = JSON.parse(savedPurchased);
            if (savedMake) customMakeSources = JSON.parse(savedMake);
        }
        
        // Login handling
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.classList.add('show');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.classList.remove('show');
            
            try {
                await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Invalid email or password. Please try again.';
                errorDiv.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }
        
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.firebaseAuth);
                    showToast('Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Error logging out');
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        });
        
        // Initialize app
        function initializeApp() {
            console.log(`Initializing Budget Build Club Inventory Manager v${APP_VERSION}`);
            initializeDefaultData();
            loadFromLocalStorage();
            loadBusinessName();
            loadPeriodFilter();
            loadCustomSources();
            tryLoadFromFirebase();
        }
        
        // Initialize default components and kits if they don't exist
        function initializeDefaultData() {
            console.log('=== INITIALIZING DEFAULT DATA ===');
            
            if (Object.keys(components).length === 0) {
                console.log('‚úì Initializing default components...');
                components = {
                    "4x4x18\" Box": { 
                        onHand: 40, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 25, costPerBox: 39,
                        type: "purchased", source: "Amazon", partNumber: "", productLink: ""
                    },
                    "0.5x0.25x0.3125\" Spacer": { 
                        onHand: 98, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 50, costPerBox: 24,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "0.5x0.25x1.375\" Spacer": { 
                        onHand: 0, onOrder: 0, eta: "", 
                        costType: "piece", costPerPiece: 3.94,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "M6x30mm Socket Head Screw": { 
                        onHand: 100, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 50, costPerBox: 12.46,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "M6x50mm Hex Drive Flat Head": { 
                        onHand: 0, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 10, costPerBox: 6.26,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "M6 Flat Washer": { 
                        onHand: 161, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 100, costPerBox: 6.58,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "M6 Split Washer": { 
                        onHand: 191, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 100, costPerBox: 5.29,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "M6x65mm Hex Drive Flat Head": { 
                        onHand: 49, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 10, costPerBox: 6.77,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "M8x65mm Hex Drive Flat Head": { 
                        onHand: 17, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 5, costPerBox: 6.0,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "M8x18mm Hex Drive Flat Head Screw": { 
                        onHand: 0, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 10, costPerBox: 6.69,
                        type: "purchased", source: "McMaster", partNumber: "", productLink: ""
                    },
                    "S13 Bracket": { 
                        onHand: 12, onOrder: 0, eta: "", 
                        costType: "piece", costPerPiece: 28.52,
                        type: "purchased", source: "SendCutSend", partNumber: "", productLink: ""
                    },
                    "S14 Bracket": { 
                        onHand: 6, onOrder: 0, eta: "", 
                        costType: "piece", costPerPiece: 32.80,
                        type: "purchased", source: "SendCutSend", partNumber: "", productLink: ""
                    },
                    "1NZ Bracket": { 
                        onHand: 0, onOrder: 0, eta: "", 
                        costType: "piece", costPerPiece: 28.52,
                        type: "purchased", source: "SendCutSend", partNumber: "", productLink: ""
                    },
                    "2JZ Intake Bracket": { 
                        onHand: 0, onOrder: 0, eta: "", 
                        costType: "box", boxSize: 5, costPerBox: 259.5,
                        type: "purchased", source: "SendCutSend", partNumber: "", productLink: ""
                    },
                    "Cap Part": { 
                        onHand: 99, onOrder: 0, eta: "", 
                        costType: "piece", costPerPiece: 5.00,
                        type: "make", source: "3D Print", partNumber: "", productLink: ""
                    }
                };
            } else {
                // Migrate old components
                for (const [name, comp] of Object.entries(components)) {
                    if (!comp.type) comp.type = name === "Cap Part" ? "make" : "purchased";
                    if (!comp.source) {
                        if (comp.type === "make") {
                            comp.source = "3D Print";
                        } else {
                            comp.source = "McMaster";
                        }
                    }
                    if (comp.partNumber === undefined) comp.partNumber = "";
                    if (comp.productLink === undefined) comp.productLink = "";
                }
            }
            
            if (Object.keys(kits).length === 0) {
                console.log('‚úì Initializing default kits...');
                kits = {
                    "S13": {
                        cost: 42.67,
                        price: 80,
                        components: {
                            "4x4x18\" Box": 1,
                            "0.5x0.25x0.3125\" Spacer": 4,
                            "M6x30mm Socket Head Screw": 4,
                            "M6 Flat Washer": 4,
                            "M6 Split Washer": 4,
                            "M6x65mm Hex Drive Flat Head": 3,
                            "S13 Bracket": 1
                        }
                    },
                    "S14": {
                        cost: 45.87,
                        price: 80,
                        components: {
                            "4x4x18\" Box": 1,
                            "0.5x0.25x0.3125\" Spacer": 4,
                            "M6x30mm Socket Head Screw": 4,
                            "M6 Flat Washer": 4,
                            "M6 Split Washer": 4,
                            "M8x65mm Hex Drive Flat Head": 2,
                            "S14 Bracket": 1
                        }
                    },
                    "Cap": {
                        cost: 5.00,
                        price: 20,
                        components: {
                            "Cap Part": 1
                        }
                    },
                    "1NZ COP Adapter": {
                        cost: 31.40,
                        price: 80,
                        components: {
                            "1NZ Bracket": 1,
                            "M6x50mm Hex Drive Flat Head": 6,
                            "M6x30mm Socket Head Screw": 6,
                            "M6 Flat Washer": 6,
                            "M6 Split Washer": 6,
                            "0.5x0.25x1.375\" Spacer": 6,
                            "0.5x0.25x0.3125\" Spacer": 6
                        }
                    },
                    "2JZ Intake Adapter": {
                        cost: 58.34,
                        price: 60,
                        components: {
                            "4x4x18\" Box": 1,
                            "M8x18mm Hex Drive Flat Head Screw": 7,
                            "2JZ Intake Bracket": 1
                        }
                    }
                };
            }
            
            console.log('=== END DEFAULT DATA INIT ===');
        }
        
        function loadFromLocalStorage() {
            console.log('Loading from localStorage...');
            try {
                const savedOrders = localStorage.getItem('bbc_orders');
                const savedComponents = localStorage.getItem('bbc_components');
                const savedKits = localStorage.getItem('bbc_kits');
                const savedNextOrderId = localStorage.getItem('bbc_nextOrderId');
                const savedLastUpdate = localStorage.getItem('bbc_lastUpdateDate');
                
                if (savedOrders) orders = JSON.parse(savedOrders);
                if (savedComponents) components = JSON.parse(savedComponents);
                if (savedKits) kits = JSON.parse(savedKits);
                if (savedNextOrderId) nextOrderId = parseInt(savedNextOrderId);
                if (savedLastUpdate) lastUpdateDate = new Date(savedLastUpdate);
                
                // Migrate old orders to add date if missing
                orders.forEach(order => {
                    if (!order.createdAt) {
                        order.createdAt = new Date().toISOString();
                    }
                    if (order.shippingCost === undefined) {
                        order.shippingCost = 0;
                    }
                });
                
                console.log(`Loaded: ${orders.length} orders, ${Object.keys(components).length} components, ${Object.keys(kits).length} kits`);
                updateFirebaseStatus('offline', 'Offline Mode');
                renderAll();
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('bbc_orders', JSON.stringify(orders));
                localStorage.setItem('bbc_components', JSON.stringify(components));
                localStorage.setItem('bbc_kits', JSON.stringify(kits));
                localStorage.setItem('bbc_nextOrderId', nextOrderId.toString());
                localStorage.setItem('bbc_businessName', businessName);
                localStorage.setItem('bbc_lastUpdateDate', new Date().toISOString());
                lastUpdateDate = new Date();
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        async function tryLoadFromFirebase() {
            if (!window.firebaseReady || !window.firebaseAuth.currentUser) return;
            
            updateFirebaseStatus('syncing', 'Connecting...');
            console.log('=== LOADING FROM FIREBASE ===');
            
            try {
                // Load orders
                const ordersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'orders'));
                const firebaseOrders = [];
                ordersSnapshot.forEach(doc => firebaseOrders.push(doc.data()));
                
                // Load components
                const componentsSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'components'));
                const firebaseComponents = {};
                componentsSnapshot.forEach(doc => firebaseComponents[doc.id] = doc.data());
                
                // Load kits
                const kitsSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'kits'));
                const firebaseKits = {};
                kitsSnapshot.forEach(doc => firebaseKits[doc.id] = doc.data());
                
                // Load metadata
                const docRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'nextOrderId');
                const docSnap = await window.firebaseGetDoc(docRef);
                let firebaseNextOrderId = 1;
                if (docSnap.exists()) firebaseNextOrderId = docSnap.data().value;
                
                // Load business name
                const nameRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'businessName');
                const nameSnap = await window.firebaseGetDoc(nameRef);
                if (nameSnap.exists()) {
                    businessName = nameSnap.data().value;
                    document.getElementById('businessName').textContent = businessName;
                }
                
                // Load custom sources
                const sourcesRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'customSources');
                const sourcesSnap = await window.firebaseGetDoc(sourcesRef);
                if (sourcesSnap.exists()) {
                    const sourcesData = sourcesSnap.data();
                    if (sourcesData.purchased) customPurchasedSources = sourcesData.purchased;
                    if (sourcesData.make) customMakeSources = sourcesData.make;
                }
                
                console.log(`Firebase has: ${firebaseOrders.length} orders, ${Object.keys(firebaseComponents).length} components, ${Object.keys(firebaseKits).length} kits`);
                
                let needsSync = false;
                
                // Handle components
                if (Object.keys(firebaseComponents).length > 0) {
                    components = firebaseComponents;
                    
                    // Migrate old data
                    for (const [name, comp] of Object.entries(components)) {
                        if (!comp.type) comp.type = name === "Cap Part" ? "make" : "purchased";
                        if (!comp.source) {
                            if (comp.type === "make") {
                                comp.source = "3D Print";
                            } else {
                                comp.source = "McMaster";
                            }
                        }
                        if (comp.partNumber === undefined) comp.partNumber = "";
                        if (comp.productLink === undefined) comp.productLink = "";
                    }
                } else if (Object.keys(components).length > 0) {
                    needsSync = true;
                }
                
                // Handle kits
                if (Object.keys(firebaseKits).length > 0) {
                    kits = firebaseKits;
                } else if (Object.keys(kits).length > 0) {
                    needsSync = true;
                }
                
                // Handle orders
                if (firebaseOrders.length > 0) {
                    orders = firebaseOrders;
                    nextOrderId = firebaseNextOrderId;
                    
                    // Migrate old orders
                    orders.forEach(order => {
                        if (!order.createdAt) {
                            order.createdAt = new Date().toISOString();
                        }
                        if (order.shippingCost === undefined) {
                            order.shippingCost = 0;
                        }
                    });
                }
                
                saveToLocalStorage();
                renderAll();
                
                if (needsSync) {
                    await syncToFirebase();
                    showToast('Initialized Firebase with default data');
                }
                
                firebaseAvailable = true;
                updateFirebaseStatus('connected', 'Connected');
            } catch (error) {
                console.error('Firebase error:', error);
                firebaseAvailable = false;
                updateFirebaseStatus('offline', 'Offline Mode');
                showToast('Working in offline mode');
            }
        }
        
        async function syncToFirebase() {
            if (!window.firebaseReady || !firebaseAvailable || !window.firebaseAuth.currentUser) {
                return;
            }
            
            updateFirebaseStatus('syncing', 'Syncing...');
            
            try {
                const batch = window.firebaseWriteBatch(window.firebaseDB);
                
                // Sync orders
                for (const order of orders) {
                    const orderRef = window.firebaseDoc(window.firebaseDB, 'orders', String(order.id));
                    batch.set(orderRef, order);
                }
                
                // Sync components
                for (const [name, comp] of Object.entries(components)) {
                    const compRef = window.firebaseDoc(window.firebaseDB, 'components', name);
                    batch.set(compRef, comp);
                }
                
                // Sync kits
                for (const [name, kit] of Object.entries(kits)) {
                    const kitRef = window.firebaseDoc(window.firebaseDB, 'kits', name);
                    batch.set(kitRef, kit);
                }
                
                // Sync metadata
                const nextOrderIdRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'nextOrderId');
                batch.set(nextOrderIdRef, { value: nextOrderId });
                
                const businessNameRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'businessName');
                batch.set(businessNameRef, { value: businessName });
                
                const customSourcesRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'customSources');
                batch.set(customSourcesRef, { 
                    purchased: customPurchasedSources,
                    make: customMakeSources
                });
                
                await batch.commit();
                updateFirebaseStatus('connected', 'Synced');
                setTimeout(() => updateFirebaseStatus('connected', 'Connected'), 2000);
            } catch (error) {
                console.error('Sync error:', error);
                updateFirebaseStatus('offline', 'Sync Failed');
            }
        }
        
        function manualSync() {
            if (firebaseAvailable) {
                syncToFirebase();
                showToast('Syncing to cloud...');
            } else {
                tryLoadFromFirebase();
                showToast('Reconnecting...');
            }
        }
        
        function updateFirebaseStatus(status, text) {
            const statusPill = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            if (statusPill && statusText) {
                statusPill.className = 'firebase-status-pill ' + status;
                statusText.textContent = text;
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // CSV Import Handler
        async function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('Processing CSV...');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsed:', results.data.length, 'rows');
                    
                    // Create map of existing orders by Shopify number
                    const existingOrdersMap = new Map();
                    orders.forEach(order => {
                        if (order.shopifyOrderNumber) {
                            existingOrdersMap.set(order.shopifyOrderNumber, order);
                        }
                    });
                    
                    // Group CSV rows by order number
                    const csvOrdersMap = new Map();
                    
                    results.data.forEach(row => {
                        const orderNum = row['Name']?.trim();
                        if (!orderNum || !orderNum.startsWith('#')) return;
                        
                        if (!csvOrdersMap.has(orderNum)) {
                            const shippingCost = parseFloat(row['Shipping']) || 0;
                            const createdAt = row['Created at'] ? new Date(row['Created at']).toISOString() : new Date().toISOString();
                            
                            csvOrdersMap.set(orderNum, {
                                shopifyOrderNumber: orderNum,
                                name: row['Billing Name']?.trim() || row['Shipping Name']?.trim() || 'Unknown',
                                paid: row['Financial Status']?.toLowerCase() === 'paid',
                                shipped: row['Fulfillment Status']?.toLowerCase() === 'fulfilled',
                                tracking: '',
                                shippingCost: shippingCost,
                                createdAt: createdAt,
                                products: {}
                            });
                        }
                        
                        const csvOrder = csvOrdersMap.get(orderNum);
                        const lineitemName = row['Lineitem name']?.trim();
                        const lineitemQty = parseInt(row['Lineitem quantity']) || 0;
                        
                        if (lineitemName && lineitemQty > 0) {
                            let kitName = KIT_NAME_MAP[lineitemName] || lineitemName;
                            
                            if (!KIT_NAME_MAP[lineitemName]) {
                                for (const [shopifyName, mappedName] of Object.entries(KIT_NAME_MAP)) {
                                    if (lineitemName.toLowerCase().includes(mappedName.toLowerCase())) {
                                        kitName = mappedName;
                                        break;
                                    }
                                }
                            }
                            
                            const kitKey = kitName.toLowerCase();
                            csvOrder.products[kitKey] = (csvOrder.products[kitKey] || 0) + lineitemQty;
                        }
                    });
                    
                    let newCount = 0;
                    let updatedCount = 0;
                    let unchangedCount = 0;
                    
                    // Process each CSV order
                    csvOrdersMap.forEach((csvOrder, orderNum) => {
                        const existingOrder = existingOrdersMap.get(orderNum);
                        
                        if (existingOrder) {
                            // Check if anything changed
                            let hasChanges = false;
                            
                            if (existingOrder.name !== csvOrder.name) hasChanges = true;
                            if (existingOrder.paid !== csvOrder.paid) hasChanges = true;
                            if (existingOrder.shipped !== csvOrder.shipped) hasChanges = true;
                            if (existingOrder.shippingCost !== csvOrder.shippingCost) hasChanges = true;
                            
                            // Check products
                            for (const [kitKey, qty] of Object.entries(csvOrder.products)) {
                                if ((existingOrder[kitKey] || 0) !== qty) {
                                    hasChanges = true;
                                    break;
                                }
                            }
                            
                            if (hasChanges) {
                                // Update existing order
                                existingOrder.name = csvOrder.name;
                                existingOrder.paid = csvOrder.paid;
                                existingOrder.shipped = csvOrder.shipped;
                                existingOrder.shippingCost = csvOrder.shippingCost;
                                
                                // Update product quantities
                                for (const [kitKey, qty] of Object.entries(csvOrder.products)) {
                                    existingOrder[kitKey] = qty;
                                }
                                
                                updatedCount++;
                            } else {
                                unchangedCount++;
                            }
                        } else {
                            // Create new order
                            const newOrder = {
                                id: nextOrderId++,
                                shopifyOrderNumber: csvOrder.shopifyOrderNumber,
                                name: csvOrder.name,
                                paid: csvOrder.paid,
                                shipped: csvOrder.shipped,
                                tracking: '',
                                shippingCost: csvOrder.shippingCost,
                                createdAt: csvOrder.createdAt
                            };
                            
                            // Add products
                            for (const [kitKey, qty] of Object.entries(csvOrder.products)) {
                                newOrder[kitKey] = qty;
                            }
                            
                            orders.push(newOrder);
                            newCount++;
                        }
                    });
                    
                    saveToLocalStorage();
                    syncToFirebase();
                    renderAll();
                    
                    // Show appropriate message
                    if (newCount > 0 && updatedCount > 0) {
                        showToast(`Imported ${newCount} new, updated ${updatedCount} orders${unchangedCount > 0 ? `, ${unchangedCount} unchanged` : ''}!`);
                    } else if (newCount > 0) {
                        showToast(`Imported ${newCount} new orders!`);
                    } else if (updatedCount > 0) {
                        showToast(`Updated ${updatedCount} orders${unchangedCount > 0 ? `, ${unchangedCount} unchanged` : ''}!`);
                    } else {
                        showToast('No changes detected in CSV');
                    }
                },
                error: function(error) {
                    console.error('CSV parse error:', error);
                    showToast('Error parsing CSV');
                }
            });
            
            event.target.value = '';
        }
        
        function renderAll() {
            updateStats();
            renderOrders();
            renderShoppingList();
            renderInventory();
            renderKits();
            renderShippedOrders();
        }
        
        function getKitQtyFromOrder(order, kitName) {
            const variations = [
                kitName.toLowerCase(),
                kitName.toLowerCase().replace(/\s+/g, ' '),
                kitName,
                kitName.toLowerCase().replace(/\s+/g, '')
            ];
            
            for (const variation of variations) {
                if (order[variation] !== undefined && order[variation] > 0) {
                    return order[variation];
                }
            }
            return 0;
        }
        
        function deductInventoryForOrder(order) {
            console.log('Deducting inventory for order:', order.id);
            
            for (const [kitName, kit] of Object.entries(kits)) {
                const qtyNeeded = getKitQtyFromOrder(order, kitName);
                if (qtyNeeded === 0) continue;
                
                for (const [componentName, componentQty] of Object.entries(kit.components)) {
                    const comp = components[componentName];
                    if (!comp) continue;
                    
                    const totalNeeded = componentQty * qtyNeeded;
                    comp.onHand = Math.max(0, comp.onHand - totalNeeded);
                }
            }
            
            saveToLocalStorage();
            syncToFirebase();
        }
        
        function renderShoppingList() {
            const container = document.getElementById('shoppingListContainer');
            const shoppingList = [];
            
            // Calculate what's needed
            const paidOrders = orders.filter(o => o.paid && !o.shipped);
            
            paidOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const kitQty = getKitQtyFromOrder(order, kitName);
                    if (kitQty === 0) continue;
                    
                    for (const [componentName, componentQty] of Object.entries(kit.components)) {
                        const comp = components[componentName];
                        if (!comp) continue;
                        
                        const totalNeeded = componentQty * kitQty;
                        const shortage = Math.max(0, totalNeeded - comp.onHand);
                        
                        if (shortage > 0) {
                            const existing = shoppingList.find(item => item.name === componentName);
                            if (existing) {
                                existing.shortage += shortage;
                            } else {
                                shoppingList.push({
                                    name: componentName,
                                    shortage: shortage,
                                    type: comp.type || 'purchased',
                                    source: comp.source || 'Other',
                                    partNumber: comp.partNumber || '',
                                    productLink: comp.productLink || '',
                                    onOrder: comp.onOrder || 0
                                });
                            }
                        }
                    }
                }
            });
            
            // Sort by source then alphabetically
            shoppingList.sort((a, b) => {
                if (a.source !== b.source) return a.source.localeCompare(b.source);
                return a.name.localeCompare(b.name);
            });
            
            if (shoppingList.length === 0) {
                container.innerHTML = '<div class="shopping-list-empty"><strong>‚úÖ All components in stock!</strong><br>No items need to be ordered right now.</div>';
                return;
            }
            
            // Get unique sources and types for filter
            const sources = [...new Set(shoppingList.map(item => item.source))].sort();
            const types = [...new Set(shoppingList.map(item => item.type))];
            
            // Filter items
            let filteredList = shoppingList;
            if (shoppingListFilter !== 'all') {
                if (shoppingListFilter === 'purchased' || shoppingListFilter === 'make') {
                    filteredList = shoppingList.filter(item => item.type === shoppingListFilter);
                } else {
                    filteredList = shoppingList.filter(item => item.source === shoppingListFilter);
                }
            }
            
            let html = '<div class="shopping-list-alert"><h4>‚ö†Ô∏è Items Low in Stock</h4>';
            html += `<div class="filter-controls">
                <label>Show only:</label>
                <select onchange="shoppingListFilter = this.value; renderShoppingList()">
                    <option value="all" ${shoppingListFilter === 'all' ? 'selected' : ''}>All Items (${shoppingList.length})</option>
                    <optgroup label="By Source">`;
            
            sources.forEach(source => {
                const count = shoppingList.filter(item => item.source === source).length;
                html += `<option value="${source}" ${shoppingListFilter === source ? 'selected' : ''}>${source} (${count})</option>`;
            });
            
            html += `</optgroup>
                    <optgroup label="By Type">`;
            
            types.forEach(type => {
                const count = shoppingList.filter(item => item.type === type).length;
                const label = type.charAt(0).toUpperCase() + type.slice(1);
                html += `<option value="${type}" ${shoppingListFilter === type ? 'selected' : ''}>${label} (${count})</option>`;
            });
            
            html += `</optgroup>
                </select>
            </div></div>`;
            
            html += '<table><thead><tr><th>Component</th><th>Type</th><th>Source</th><th>Part Info</th><th>Need to Order</th><th>Already On Order</th></tr></thead><tbody>';
            
            filteredList.forEach(item => {
                const typeBadge = `<span class="type-badge type-${item.type}">${item.type}</span>`;
                
                let partInfo = '<span style="color: #999;">-</span>';
                if (item.partNumber) {
                    if (item.productLink) {
                        partInfo = `<a href="${item.productLink}" target="_blank" class="part-link">${item.partNumber}</a>`;
                    } else {
                        partInfo = `<span style="font-weight: 600;">${item.partNumber}</span>`;
                    }
                } else if (item.productLink) {
                    partInfo = `<a href="${item.productLink}" target="_blank" class="part-link">View Product</a>`;
                }
                
                const onOrderStatus = item.onOrder >= item.shortage ? 
                    `<span style="color: #10b981; font-weight: bold;">${item.onOrder} ‚úì</span>` :
                    `<span style="color: #ef4444; font-weight: bold;">${item.onOrder}</span>`;
                
                html += `<tr onclick="editComponent('${item.name.replace(/'/g, "\\'")}')" style="background: ${item.type === 'make' ? '#fef3f3' : '#f8f9fa'}">
                    <td><strong>${item.name}</strong></td>
                    <td>${typeBadge}</td>
                    <td>${item.source}</td>
                    <td>${partInfo}</td>
                    <td><strong style="color: #ef4444;">${item.shortage}</strong></td>
                    <td>${onOrderStatus}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function calculateStats() {
            const filteredOrders = getFilteredOrders();
            const activeOrders = filteredOrders.filter(o => !o.shipped);
            const paidOrders = activeOrders.filter(o => o.paid);
            
            let totalRevenue = 0;
            let revenueCollected = 0;
            
            activeOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = getKitQtyFromOrder(order, kitName);
                    totalRevenue += qty * (kit.price || 0);
                }
            });
            
            paidOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = getKitQtyFromOrder(order, kitName);
                    revenueCollected += qty * (kit.price || 0);
                }
            });
            
            let totalCosts = 0;
            paidOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = getKitQtyFromOrder(order, kitName);
                    totalCosts += qty * (kit.cost || 0);
                }
            });
            
            const profit = revenueCollected - totalCosts;
            const margin = revenueCollected > 0 ? (profit / revenueCollected) * 100 : 0;
            
            return { 
                totalOrders: activeOrders.length, 
                paidOrders: paidOrders.length, 
                totalRevenue, 
                revenueCollected, 
                profit, 
                margin, 
                totalCosts 
            };
        }
        
        function updateStats() {
            const stats = calculateStats();
            const filteredOrders = getFilteredOrders();
            const activeOrders = filteredOrders.filter(o => !o.shipped);
            const paidOrders = activeOrders.filter(o => o.paid);
            
            let readyToShipCount = 0;
            paidOrders.forEach(order => {
                if (canFulfillOrder(order)) {
                    readyToShipCount++;
                }
            });
            
            // Update sub-labels based on period
            let ordersSub = 'Active orders';
            switch(currentPeriod) {
                case 'last_update':
                    ordersSub = 'Since last update';
                    break;
                case 'last_month':
                    ordersSub = 'Last month';
                    break;
                case 'this_year':
                    ordersSub = 'This year';
                    break;
                case 'all_time':
                    ordersSub = 'All time';
                    break;
            }
            
            document.getElementById('totalOrders').textContent = stats.totalOrders;
            document.getElementById('totalOrdersSub').textContent = ordersSub;
            document.getElementById('readyToShip').textContent = readyToShipCount;
            const readyPct = paidOrders.length > 0 ? ((readyToShipCount / paidOrders.length) * 100).toFixed(1) : 0;
            document.getElementById('readyPercentage').textContent = `${readyPct}% ready`;
            document.getElementById('paidOrders').textContent = stats.paidOrders;
            const paidPct = stats.totalOrders > 0 ? ((stats.paidOrders / stats.totalOrders) * 100).toFixed(1) : 0;
            document.getElementById('paidPercentage').textContent = `${paidPct}%`;
            document.getElementById('revenueCollected').textContent = `${stats.revenueCollected.toFixed(0)}`;
            document.getElementById('revenueTotal').textContent = `of $${stats.totalRevenue.toFixed(0)} total`;
            document.getElementById('totalProfit').textContent = `${stats.profit.toFixed(2)}`;
            document.getElementById('profitMargin').textContent = `${stats.margin.toFixed(1)}% margin`;
            document.getElementById('totalCosts').textContent = `${stats.totalCosts.toFixed(2)}`;
            const collectionPct = stats.totalRevenue > 0 ? (stats.revenueCollected / stats.totalRevenue) * 100 : 0;
            document.getElementById('collectionProgress').style.width = collectionPct + '%';
            document.getElementById('collectionProgress').textContent = `${collectionPct.toFixed(1)}% Collected`;
        }
        
        function canFulfillOrder(order) {
            for (const [kitName, kit] of Object.entries(kits)) {
                const qtyNeeded = getKitQtyFromOrder(order, kitName);
                if (qtyNeeded === 0) continue;
                
                for (const [componentName, componentQty] of Object.entries(kit.components)) {
                    const comp = components[componentName];
                    if (!comp) return false;
                    const totalNeeded = componentQty * qtyNeeded;
                    if (comp.onHand < totalNeeded) return false;
                }
            }
            return true;
        }
        
        function renderOrdersSummary() {
            const activeOrders = orders.filter(o => !o.shipped);
            const kitTotals = {};
            
            activeOrders.forEach(order => {
                for (const kitName of Object.keys(kits)) {
                    const qty = getKitQtyFromOrder(order, kitName);
                    if (qty > 0) {
                        kitTotals[kitName] = (kitTotals[kitName] || 0) + qty;
                    }
                }
            });
            
            const summaryDiv = document.getElementById('ordersSummary');
            summaryDiv.innerHTML = '';
            
            for (const [kitName, total] of Object.entries(kitTotals)) {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                card.innerHTML = `
                    <div style="font-size: 12px; color: #666; font-weight: 600; margin-bottom: 5px;">${kitName.toUpperCase()}</div>
                    <div style="font-size: 24px; color: #667eea; font-weight: bold;">${total}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">to build</div>
                `;
                summaryDiv.appendChild(card);
            }
            
            if (Object.keys(kitTotals).length === 0) {
                summaryDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No active orders</div>';
            }
        }
        
        function renderOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            const activeOrders = orders.filter(o => !o.shipped);
            
            activeOrders.forEach(order => {
                let totalQty = 0;
                const productList = [];
                
                for (const kitName of Object.keys(kits)) {
                    const qty = getKitQtyFromOrder(order, kitName);
                    
                    if (qty > 0) {
                        totalQty += qty;
                        productList.push(`${qty}√ó ${kitName}`);
                    }
                }
                
                const productText = totalQty > 0 
                    ? `${totalQty} item${totalQty > 1 ? 's' : ''} (${productList.join(', ')})`
                    : 'No products';
                
                const ready = canFulfillOrder(order);
                const orderNumber = order.shopifyOrderNumber || '-';
                
                let bgColor = '';
                let statusText = '';
                
                if (order.paid && ready) {
                    bgColor = '#d1fae5';
                    statusText = '<span class="status-paid">‚úì PAID & READY TO SHIP</span>';
                } else if (order.paid) {
                    bgColor = '#fef3c7';
                    statusText = '<span class="status-paid awaiting">‚ö† PAID - AWAITING STOCK</span>';
                } else {
                    bgColor = '#fee2e2';
                    statusText = '<span class="status-unpaid">UNPAID</span>';
                }
                
                const tr = document.createElement('tr');
                tr.style.backgroundColor = bgColor;
                tr.onclick = () => editOrder(order.id);
                
                tr.innerHTML = `
                    <td><strong>${order.name}</strong></td>
                    <td>${orderNumber}</td>
                    <td>${productText}</td>
                    <td>${statusText}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            renderOrdersSummary();
        }
        
        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            // Sort components by source, then alphabetically
            const sortedComponents = Object.entries(components).sort((a, b) => {
                const [nameA, compA] = a;
                const [nameB, compB] = b;
                const sourceA = compA.source || 'Other';
                const sourceB = compB.source || 'Other';
                
                if (sourceA !== sourceB) {
                    return sourceA.localeCompare(sourceB);
                }
                return nameA.localeCompare(nameB);
            });
            
            for (const [name, comp] of sortedComponents) {
                let needed = 0;
                
                const paidOrders = orders.filter(o => o.paid && !o.shipped);
                paidOrders.forEach(order => {
                    for (const [kitName, kit] of Object.entries(kits)) {
                        const kitQty = getKitQtyFromOrder(order, kitName);
                        const componentQty = kit.components[name] || 0;
                        needed += kitQty * componentQty;
                    }
                });
                
                const totalAvailable = comp.onHand + comp.onOrder;
                let statusClass = 'inventory-ok', statusText = '‚úì OK';
                let onHandClass = 'onhand-ok';
                
                if (comp.onHand < needed) {
                    if (totalAvailable >= needed) {
                        statusClass = 'inventory-low';
                        statusText = '‚ö† On Order';
                        onHandClass = 'onhand-low';
                    } else {
                        statusClass = 'inventory-critical';
                        statusText = '‚ö†Ô∏è Need Ordered';
                        onHandClass = 'onhand-critical';
                    }
                }
                
                const typeBadge = `<span class="type-badge type-${comp.type || 'purchased'}">${comp.type || 'purchased'}</span>`;
                
                let partInfo = '<span style="color: #999;">-</span>';
                if (comp.partNumber) {
                    if (comp.productLink) {
                        partInfo = `<a href="${comp.productLink}" target="_blank" class="part-link">${comp.partNumber}</a>`;
                    } else {
                        partInfo = `<span style="font-weight: 600;">${comp.partNumber}</span>`;
                    }
                } else if (comp.productLink) {
                    partInfo = `<a href="${comp.productLink}" target="_blank" class="part-link">View Product</a>`;
                }
                
                const row = document.createElement('tr');
                row.onclick = () => editComponent(name);
                row.innerHTML = `
                    <td><strong>${name}</strong></td>
                    <td>${typeBadge}</td>
                    <td>${comp.source || 'Other'}</td>
                    <td>${partInfo}</td>
                    <td>${needed}</td>
                    <td><span class="${onHandClass}">${comp.onHand}</span></td>
                    <td>${comp.onOrder}</td>
                    <td>${comp.eta}</td>
                    <td><strong>${totalAvailable}</strong></td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function calculateKitsCanMake(kitName) {
            const kit = kits[kitName];
            if (!kit) return 0;
            
            let minCanMake = Infinity;
            for (const [componentName, qtyNeeded] of Object.entries(kit.components)) {
                const comp = components[componentName];
                if (!comp) return 0;
                const canMake = Math.floor(comp.onHand / qtyNeeded);
                minCanMake = Math.min(minCanMake, canMake);
            }
            return minCanMake === Infinity ? 0 : minCanMake;
        }
        
        function renderKits() {
            const tbody = document.getElementById('kitsBody');
            tbody.innerHTML = '';
            
            if (Object.keys(kits).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No kits defined. Click "+ Add Kit" to create one.</td></tr>';
                return;
            }
            
            for (const [kitName, kit] of Object.entries(kits)) {
                const canMake = calculateKitsCanMake(kitName);
                const componentsList = Object.entries(kit.components)
                    .map(([comp, qty]) => `${qty}√ó ${comp}`)
                    .join(', ');
                
                const row = document.createElement('tr');
                row.onclick = () => editKit(kitName);
                row.innerHTML = `
                    <td><strong>${kitName}</strong></td>
                    <td>${componentsList}</td>
                    <td>$${(kit.cost || 0).toFixed(2)}</td>
                    <td>$${(kit.price || 0).toFixed(2)}</td>
                    <td><strong>${canMake}</strong></td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function renderShippedOrders() {
            const tbody = document.getElementById('shippedBody');
            tbody.innerHTML = '';
            const shippedOrders = orders.filter(o => o.shipped);
            if (shippedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No shipped orders yet</td></tr>';
                return;
            }
            shippedOrders.forEach((order) => {
                let amount = 0;
                const items = [];
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = getKitQtyFromOrder(order, kitName);
                    if (qty > 0) {
                        items.push(`${qty} ${kitName}`);
                        amount += qty * (kit.price || 0);
                    }
                }
                
                const orderNumber = order.shopifyOrderNumber || '-';
                
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => editOrder(order.id);
                row.innerHTML = `
                    <td><strong>${orderNumber}</strong></td>
                    <td><strong>${order.name}</strong></td>
                    <td>${items.join(', ')}</td>
                    <td><strong>$${amount.toFixed(2)}</strong></td>
                    <td>${order.tracking || 'N/A'}</td>
                    <td><button class="btn btn-small btn-danger" onclick="event.stopPropagation(); unshipOrder(${order.id})">Unship</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Order Modal Functions
        function showNewOrderModal() {
            currentEditOrderId = null;
            document.getElementById('orderModalTitle').textContent = 'Add New Order';
            document.getElementById('orderModalSaveBtn').textContent = 'Add Order';
            document.getElementById('orderModalSaveBtn').onclick = addNewOrder;
            document.getElementById('orderModalDeleteBtn').style.display = 'none';
            document.getElementById('orderModalShipBtn').style.display = 'none';
            document.getElementById('newOrderName').value = '';
            document.getElementById('newOrderPaid').checked = false;
            document.getElementById('orderInfoSection').innerHTML = '';
            
            const summaryView = document.getElementById('orderSummaryView');
            if (summaryView) summaryView.style.display = 'block';
            
            const kitsContainer = document.getElementById('orderKitsContainer');
            if (kitsContainer) kitsContainer.style.display = 'none';
            
            renderOrderKitsInputs({});
            updateOrderSummary();
            renderOrderProductsList();
            
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function closeNewOrderModal() {
            document.getElementById('newOrderModal').classList.remove('active');
        }
        
        function renderOrderKitsInputs(orderData = {}) {
            const container = document.getElementById('orderKitsContainer');
            container.innerHTML = '';
            
            for (const [kitName] of Object.entries(kits)) {
                const qty = orderData[kitName.toLowerCase()] || 0;
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.innerHTML = `
                    <label>${kitName} Quantity</label>
                    <input type="number" id="orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${qty}" min="0" onchange="updateOrderSummary()">
                `;
                container.appendChild(formGroup);
            }
        }
        
        function updateOrderSummary() {
            let totalAmount = 0;
            const selectedKits = [];
            const componentsNeeded = {};
            
            for (const [kitName, kit] of Object.entries(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                const qty = parseInt(input?.value) || 0;
                
                if (qty > 0) {
                    totalAmount += qty * (kit.price || 0);
                    selectedKits.push({ name: kitName, qty, price: kit.price });
                    
                    for (const [componentName, componentQty] of Object.entries(kit.components)) {
                        componentsNeeded[componentName] = (componentsNeeded[componentName] || 0) + (componentQty * qty);
                    }
                }
            }
            
            const summaryContent = document.getElementById('orderSummaryContent');
            if (!summaryContent) return;
            
            if (selectedKits.length === 0) {
                summaryContent.innerHTML = '<div style="color: #999;">No products selected</div>';
            } else {
                summaryContent.innerHTML = selectedKits.map(kit => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                        <span>${kit.qty}√ó ${kit.name}</span>
                        <span style="color: #667eea; font-weight: 600;">$${(kit.qty * kit.price).toFixed(2)}</span>
                    </div>
                `).join('');
            }
            
            const totalElement = document.getElementById('orderSummaryTotal');
            if (totalElement) {
                totalElement.textContent = `$${totalAmount.toFixed(2)}`;
            }
            
            const componentsDiv = document.getElementById('orderComponentsNeeded');
            if (componentsDiv) {
                if (Object.keys(componentsNeeded).length === 0) {
                    componentsDiv.innerHTML = '<div style="color: #999;">No components needed</div>';
                } else {
                    componentsDiv.innerHTML = Object.entries(componentsNeeded).map(([name, qty]) => `
                        <div style="padding: 6px 0; border-bottom: 1px solid #e5e7eb;">
                            <span style="font-weight: 600;">${qty}√ó</span> ${name}
                        </div>
                    `).join('');
                }
            }
            
            // Only show inventory status if order is not shipped
            const isShipped = currentEditOrderId ? orders.find(o => o.id === currentEditOrderId)?.shipped : false;
            const inventorySection = document.getElementById('orderInventoryStatusSection');
            
            if (isShipped) {
                inventorySection.style.display = 'none';
            } else {
                inventorySection.style.display = 'block';
                
                const statusDiv = document.getElementById('orderInventoryStatus');
                if (statusDiv) {
                    if (Object.keys(componentsNeeded).length === 0) {
                        statusDiv.innerHTML = '<div style="color: #999;">-</div>';
                    } else {
                        let allAvailable = true;
                        const statusHTML = Object.entries(componentsNeeded).map(([name, needed]) => {
                            const comp = components[name];
                            if (!comp) {
                                allAvailable = false;
                                return `<div style="padding: 6px 0; color: #ef4444;">‚úó ${name} - Component not found</div>`;
                            }
                            
                            const available = comp.onHand >= needed;
                            if (!available) allAvailable = false;
                            
                            return `
                                <div style="padding: 6px 0; display: flex; justify-content: space-between;">
                                    <span>${name}</span>
                                    <span style="color: ${available ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                        ${available ? '‚úì' : '‚úó'} ${comp.onHand} / ${needed} available
                                    </span>
                                </div>
                            `;
                        }).join('');
                        
                        statusDiv.innerHTML = statusHTML;
                        
                        if (allAvailable && Object.keys(componentsNeeded).length > 0) {
                            statusDiv.innerHTML += '<div style="margin-top: 10px; padding: 10px; background: #d1fae5; color: #065f46; border-radius: 6px; font-weight: 600; text-align: center;">‚úì All components available - Ready to build!</div>';
                        } else if (Object.keys(componentsNeeded).length > 0) {
                            statusDiv.innerHTML += '<div style="margin-top: 10px; padding: 10px; background: #fee2e2; color: #991b1b; border-radius: 6px; font-weight: 600; text-align: center;">‚ö† Missing components - Cannot fulfill yet</div>';
                        }
                    }
                }
            }
        }
        
        function renderOrderProductsList() {
            const container = document.getElementById('orderProductsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            let hasProducts = false;
            for (const [kitName] of Object.entries(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (!input) continue;
                
                const qty = parseInt(input.value) || 0;
                
                if (qty > 0) {
                    hasProducts = true;
                    const productRow = document.createElement('div');
                    productRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;';
                    productRow.innerHTML = `
                        <div style="flex: 1;">
                            <strong>${kitName}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                <input type="number" value="${qty}" min="1" style="width: 60px; padding: 4px; border: 2px solid #e5e7eb; border-radius: 4px;" onchange="updateProductQuantity('${kitName}', this.value)"> units
                            </div>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="removeProductFromOrder('${kitName}')">Remove</button>
                    `;
                    container.appendChild(productRow);
                }
            }
            
            if (!hasProducts) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No products in this order. Click "+ Add Product" to add one.</div>';
            }
        }
        
        function showAddProductToOrder() {
            const availableProducts = [];
            for (const [kitName] of Object.entries(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                const qty = parseInt(input?.value) || 0;
                if (qty === 0) {
                    availableProducts.push(kitName);
                }
            }
            
            if (availableProducts.length === 0) {
                alert('All products are already in this order!');
                return;
            }
            
            const product = prompt(`Select product to add:\n${availableProducts.map((p, i) => `${i + 1}. ${p}`).join('\n')}\n\nEnter product name:`);
            
            if (product && availableProducts.some(p => p.toLowerCase() === product.toLowerCase())) {
                const kitName = availableProducts.find(p => p.toLowerCase() === product.toLowerCase());
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (input) {
                    input.value = '1';
                    updateOrderSummary();
                    renderOrderProductsList();
                }
            } else if (product) {
                alert('Product not found. Please enter an exact product name.');
            }
        }
        
        function updateProductQuantity(kitName, newQty) {
            const qty = parseInt(newQty) || 0;
            const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (input) {
                input.value = qty;
                updateOrderSummary();
                
                if (qty === 0) {
                    renderOrderProductsList();
                }
            }
        }
        
        function removeProductFromOrder(kitName) {
            const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (input) {
                input.value = '0';
                updateOrderSummary();
                renderOrderProductsList();
            }
        }
        
        function addNewOrder() {
            const name = document.getElementById('newOrderName').value.trim();
            const paid = document.getElementById('newOrderPaid').checked;
            
            if (!name) { 
                alert('Please enter a customer name'); 
                return; 
            }
            
            const newOrder = { 
                id: nextOrderId++, 
                name, 
                paid, 
                shipped: false, 
                tracking: "",
                shippingCost: 0,
                createdAt: new Date().toISOString()
            };
            
            let hasAnyQuantity = false;
            for (const kitName of Object.keys(kits)) {
                const input = document.getElementById(`orderKit_${kitName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                const qty = parseInt(input?.value) || 0;
                newOrder[kitName.toLowerCase()] = qty;
                if (qty > 0) hasAnyQuantity = true;
            }
            
            if (!hasAnyQuantity) { 
                alert('Please select at least one product'); 
                return; 
            }
            
            orders.push(newOrder);
            closeNewOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order added');
        }
        
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            currentEditOrderId = orderId;
            document.getElementById('orderModalTitle').textContent = 'Edit Order - ' + order.name;
            document.getElementById('newOrderName').value = order.name;
            
            // Show order info section
            const orderInfoSection = document.getElementById('orderInfoSection');
            let infoHTML = '';
            
            if (order.shopifyOrderNumber) {
                infoHTML += `<div class="info-row">
                    <span class="info-label">Order Number:</span>
                    <span class="info-value">${order.shopifyOrderNumber}</span>
                </div>`;
            }
            
            if (order.shippingCost > 0) {
                infoHTML += `<div class="info-row">
                    <span class="info-label">Shipping Cost:</span>
                    <span class="info-value">$${order.shippingCost.toFixed(2)}</span>
                </div>`;
            }
            
            if (order.shipped && order.tracking) {
                infoHTML += `<div class="info-row">
                    <span class="info-label">Tracking:</span>
                    <span class="info-value">${order.tracking}</span>
                </div>`;
            }
            
            orderInfoSection.innerHTML = infoHTML;
            
            const orderData = {};
            for (const kitName of Object.keys(kits)) {
                orderData[kitName.toLowerCase()] = getKitQtyFromOrder(order, kitName);
            }
            
            document.getElementById('orderKitsContainer').style.display = 'none';
            
            renderOrderKitsInputs(orderData);
            
            document.getElementById('newOrderPaid').checked = order.paid;
            
            document.getElementById('orderSummaryView').style.display = 'block';
            updateOrderSummary();
            renderOrderProductsList();
            
            document.getElementById('orderModalSaveBtn').textContent = 'Save Changes';
            document.getElementById('orderModalSaveBtn').onclick = saveOrderEdit;
            document.getElementById('orderModalDeleteBtn').style.display = 'inline-block';
            
            const ready = canFulfillOrder(order);
            if (order.paid && ready && !order.shipped) {
                document.getElementById('orderModalShipBtn').style.display = 'inline-block';
            } else {
                document.getElementById('orderModalShipBtn').style.display = 'none';
            }
            
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function saveOrderEdit() {
            if (!currentEditOrderId) return;
            
            const order = orders.find(o => o.id === currentEditOrderId);
            if (!order) return;
            
            order.name = document.getElementById('newOrderName').value.trim();
            order.paid = document.getElementById('newOrderPaid').checked;
            
            for (const kitName of Object.keys(kits)) {
                const input = document.getElementById('orderKit_' + kitName.replace(/[^a-zA-Z0-9]/g, '_'));
                order[kitName.toLowerCase()] = parseInt(input.value) || 0;
            }
            
            closeNewOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order updated');
        }
        
        function deleteCurrentOrder() {
            if (!currentEditOrderId) return;
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            const index = orders.findIndex(o => o.id === currentEditOrderId);
            if (index > -1) {
                orders.splice(index, 1);
            }
            
            closeNewOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order deleted');
        }
        
        function showShipOrderModalFromEdit() {
            if (!currentEditOrderId) return;
            
            currentShipOrderId = currentEditOrderId;
            const order = orders.find(o => o.id === currentShipOrderId);
            if (!order) return;
            
            closeNewOrderModal();
            
            const canShip = canFulfillOrder(order);
            const warningDiv = document.getElementById('shipOrderWarning');
            const warningText = document.getElementById('shipOrderWarningText');
            
            if (!canShip) {
                warningDiv.style.display = 'block';
                const shortages = [];
                
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qtyNeeded = getKitQtyFromOrder(order, kitName);
                    if (qtyNeeded === 0) continue;
                    
                    for (const [componentName, componentQty] of Object.entries(kit.components)) {
                        const comp = components[componentName];
                        if (!comp) continue;
                        const totalNeeded = componentQty * qtyNeeded;
                        if (comp.onHand < totalNeeded) {
                            shortages.push(`${componentName}: need ${totalNeeded}, have ${comp.onHand}`);
                        }
                    }
                }
                
                warningText.innerHTML = `This order cannot be fully fulfilled with current stock. Missing components:<br><br>${shortages.join('<br>')}`;
            } else {
                warningDiv.style.display = 'none';
            }
            
            document.getElementById('shipOrderCustomer').textContent = `Shipping order for ${order.name}`;
            document.getElementById('shipOrderTracking').value = order.tracking || '';
            document.getElementById('shipOrderModal').classList.add('active');
        }
        
        function closeShipOrderModal() {
            document.getElementById('shipOrderModal').classList.remove('active');
        }
        
        function confirmShipOrder() {
            if (!currentShipOrderId) return;
            
            const order = orders.find(o => o.id === currentShipOrderId);
            if (!order) return;
            
            const tracking = document.getElementById('shipOrderTracking').value.trim();
            order.shipped = true;
            order.tracking = tracking;
            
            deductInventoryForOrder(order);
            
            closeShipOrderModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order shipped! Inventory updated.');
        }
        
        function unshipOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            if (confirm('Unship this order? Note: Inventory will NOT be restored automatically.')) {
                order.shipped = false;
                order.tracking = '';
                
                saveToLocalStorage();
                syncToFirebase();
                renderAll();
                showToast('Order unshipped (inventory not restored)');
            }
        }
        
        // Component Modal Functions
        function showNewComponentModal() {
            currentEditComponent = null;
            document.getElementById('componentModalTitle').textContent = 'Add New Component';
            document.getElementById('editComponentName').value = '';
            document.getElementById('editComponentName').disabled = false;
            document.getElementById('editComponentType').value = 'purchased';
            updateSourceOptions();
            document.getElementById('editComponentPartNumber').value = '';
            document.getElementById('editComponentProductLink').value = '';
            document.getElementById('editComponentOnHand').value = '0';
            document.getElementById('editComponentOnOrder').value = '0';
            document.getElementById('editComponentEta').value = '';
            document.getElementById('editComponentCostType').value = 'piece';
            document.getElementById('editComponentCostPiece').value = '';
            document.getElementById('editComponentBoxSize').value = '';
            document.getElementById('editComponentCostBox').value = '';
            document.getElementById('editComponentCustomSource').value = '';
            toggleCostFields();
            document.getElementById('componentDeleteBtn').style.display = 'none';
            document.getElementById('editComponentModal').classList.add('active');
        }
        
        function closeEditComponentModal() {
            document.getElementById('editComponentModal').classList.remove('active');
            currentEditComponent = null;
        }
        
        function toggleCostFields() {
            const costType = document.getElementById('editComponentCostType').value;
            const pieceCostGroup = document.getElementById('pieceCostGroup');
            const boxCostGroup = document.getElementById('boxCostGroup');
            
            if (costType === 'box') {
                pieceCostGroup.style.display = 'none';
                boxCostGroup.style.display = 'block';
            } else {
                pieceCostGroup.style.display = 'block';
                boxCostGroup.style.display = 'none';
            }
        }
        
        function saveComponentEdit() {
            const name = document.getElementById('editComponentName').value.trim();
            const type = document.getElementById('editComponentType').value;
            let source = document.getElementById('editComponentSource').value;
            const customSource = document.getElementById('editComponentCustomSource').value.trim();
            const partNumber = document.getElementById('editComponentPartNumber').value.trim();
            const productLink = document.getElementById('editComponentProductLink').value.trim();
            const onHand = parseInt(document.getElementById('editComponentOnHand').value) || 0;
            const onOrder = parseInt(document.getElementById('editComponentOnOrder').value) || 0;
            const eta = document.getElementById('editComponentEta').value.trim();
            const costType = document.getElementById('editComponentCostType').value;
            
            if (!name) {
                alert('Please enter a component name');
                return;
            }
            
            // Handle custom source
            if (source === 'Other' && customSource) {
                source = customSource;
                addCustomSource(type, customSource);
            } else if (source === 'Other' && !customSource) {
                alert('Please enter a custom source name or select a different source');
                return;
            }
            
            let costData = { costType, type, source, partNumber, productLink };
            if (costType === 'piece') {
                const costPerPiece = parseFloat(document.getElementById('editComponentCostPiece').value) || 0;
                costData.costPerPiece = costPerPiece;
            } else {
                const boxSize = parseInt(document.getElementById('editComponentBoxSize').value) || 0;
                const costPerBox = parseFloat(document.getElementById('editComponentCostBox').value) || 0;
                if (boxSize <= 0) {
                    alert('Please enter a valid box/pack size');
                    return;
                }
                costData.boxSize = boxSize;
                costData.costPerBox = costPerBox;
            }
            
            if (currentEditComponent && currentEditComponent !== name) {
                alert('Cannot rename components. Please delete and create a new one.');
                return;
            }
            
            if (!currentEditComponent) {
                components[name] = {
                    onHand,
                    onOrder,
                    eta,
                    ...costData
                };
            } else {
                const comp = components[currentEditComponent];
                comp.onHand = onHand;
                comp.onOrder = onOrder;
                comp.eta = eta;
                Object.assign(comp, costData);
            }
            
            closeEditComponentModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Component saved');
        }
        
        function editComponent(componentName) {
            currentEditComponent = componentName;
            const comp = components[componentName];
            
            document.getElementById('componentModalTitle').textContent = `Edit ${componentName}`;
            document.getElementById('editComponentName').value = componentName;
            document.getElementById('editComponentName').disabled = true;
            document.getElementById('editComponentType').value = comp.type || 'purchased';
            updateSourceOptions();
            
            // Check if source is custom
            const sourceSelect = document.getElementById('editComponentSource');
            const sourceOptions = Array.from(sourceSelect.options).map(o => o.value);
            
            if (sourceOptions.includes(comp.source)) {
                document.getElementById('editComponentSource').value = comp.source;
                document.getElementById('customSourceGroup').style.display = 'none';
            } else {
                // Source is custom
                document.getElementById('editComponentSource').value = 'Other';
                document.getElementById('customSourceGroup').style.display = 'block';
                document.getElementById('editComponentCustomSource').value = comp.source;
            }
            
            document.getElementById('editComponentPartNumber').value = comp.partNumber || '';
            document.getElementById('editComponentProductLink').value = comp.productLink || '';
            document.getElementById('editComponentOnHand').value = comp.onHand;
            document.getElementById('editComponentOnOrder').value = comp.onOrder;
            document.getElementById('editComponentEta').value = comp.eta;
            
            document.getElementById('editComponentCostType').value = comp.costType || 'piece';
            if (comp.costType === 'box') {
                document.getElementById('editComponentBoxSize').value = comp.boxSize || '';
                document.getElementById('editComponentCostBox').value = comp.costPerBox || '';
                document.getElementById('editComponentCostPiece').value = '';
            } else {
                document.getElementById('editComponentCostPiece').value = comp.costPerPiece || '';
                document.getElementById('editComponentBoxSize').value = '';
                document.getElementById('editComponentCostBox').value = '';
            }
            toggleCostFields();
            
            document.getElementById('componentDeleteBtn').style.display = 'inline-block';
            document.getElementById('editComponentModal').classList.add('active');
        }
        
        function deleteCurrentComponent() {
            if (!currentEditComponent) return;
            if (!confirm(`Are you sure you want to delete ${currentEditComponent}?`)) return;
            
            for (const [kitName, kit] of Object.entries(kits)) {
                if (kit.components[currentEditComponent]) {
                    alert(`Cannot delete ${currentEditComponent} because it's used in the ${kitName} kit.`);
                    return;
                }
            }
            
            delete components[currentEditComponent];
            
            closeEditComponentModal();
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Component deleted');
        }
        
        // Kit Modal Functions
        function showNewKitModal() {
            currentEditKit = null;
            document.getElementById('kitModalTitle').textContent = 'Add New Kit';
            document.getElementById('newKitName').value = '';
            document.getElementById('newKitName').disabled = false;
            document.getElementById('newKitCost').value = '';
            document.getElementById('newKitPrice').value = '';
            document.getElementById('kitModalSaveBtn').textContent = 'Add Kit';
            document.getElementById('kitModalSaveBtn').onclick = addNewKit;
            document.getElementById('kitModalDeleteBtn').style.display = 'none';
            
            renderKitComponentsList({});
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function closeNewKitModal() {
            document.getElementById('newKitModal').classList.remove('active');
            currentEditKit = null;
        }
        
        function renderKitComponentsList(selectedComponents) {
            const container = document.getElementById('kitComponentsList');
            container.innerHTML = '';
            
            for (const [componentName] of Object.entries(components)) {
                const qty = selectedComponents[componentName] || 0;
                const div = document.createElement('div');
                div.className = 'component-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="kit_${componentName.replace(/[^a-zA-Z0-9]/g, '_')}" ${qty > 0 ? 'checked' : ''} 
                           onchange="toggleKitComponent('${componentName.replace(/'/g, "\\'")}')">
                    <label for="kit_${componentName.replace(/[^a-zA-Z0-9]/g, '_')}" style="flex: 1;">${componentName}</label>
                    <input type="number" id="qty_${componentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${qty}" min="1" 
                           style="width: 60px;" placeholder="Qty">
                `;
                container.appendChild(div);
            }
        }
        
        function toggleKitComponent(componentName) {
            const safeId = componentName.replace(/[^a-zA-Z0-9]/g, '_');
            const checkbox = document.getElementById(`kit_${safeId}`);
            const qtyInput = document.getElementById(`qty_${safeId}`);
            if (!checkbox.checked) {
                qtyInput.value = '0';
            } else if (qtyInput.value === '0' || qtyInput.value === '') {
                qtyInput.value = '1';
            }
        }
        
        function calculateKitCost(kitComponents) {
            let totalCost = 0;
            for (const [componentName, qty] of Object.entries(kitComponents)) {
                const comp = components[componentName];
                if (!comp) continue;
                
                if (comp.costType === 'piece') {
                    totalCost += (comp.costPerPiece || 0) * qty;
                } else if (comp.costType === 'box') {
                    const costPerPiece = (comp.costPerBox || 0) / (comp.boxSize || 1);
                    totalCost += costPerPiece * qty;
                }
            }
            return totalCost;
        }
        
        function addNewKit() {
            const name = document.getElementById('newKitName').value.trim();
            const cost = parseFloat(document.getElementById('newKitCost').value) || 0;
            const price = parseFloat(document.getElementById('newKitPrice').value) || 0;
            const selectedComponents = {};
            
            if (!name) {
                alert('Please enter a kit name');
                return;
            }
            
            for (const [componentName] of Object.entries(components)) {
                const safeId = componentName.replace(/[^a-zA-Z0-9]/g, '_');
                const checkbox = document.getElementById(`kit_${safeId}`);
                const qtyInput = document.getElementById(`qty_${safeId}`);
                if (checkbox && checkbox.checked) {
                    const qty = parseInt(qtyInput.value) || 1;
                    selectedComponents[componentName] = qty;
                }
            }
            
            if (Object.keys(selectedComponents).length === 0) {
                alert('Please select at least one component');
                return;
            }
            
            const calculatedCost = calculateKitCost(selectedComponents);
            
            kits[name] = {
                cost: cost > 0 ? cost : calculatedCost,
                price: price,
                components: selectedComponents
            };
            
            closeNewKitModal();
            saveToLocalStorage();
            syncToFirebase();
            renderKits();
            showToast('Kit added');
        }
        
        function editKit(kitName) {
            const kit = kits[kitName];
            if (!kit) return;
            
            currentEditKit = kitName;
            const autoCalculatedCost = calculateKitCost(kit.components);
            
            document.getElementById('kitModalTitle').textContent = `Edit ${kitName} Kit`;
            document.getElementById('newKitName').value = kitName;
            document.getElementById('newKitName').disabled = true;
            document.getElementById('newKitCost').value = kit.cost || autoCalculatedCost.toFixed(2);
            document.getElementById('newKitCost').placeholder = `Auto: ${autoCalculatedCost.toFixed(2)}`;
            document.getElementById('newKitPrice').value = kit.price || '';
            document.getElementById('kitModalSaveBtn').textContent = 'Save Changes';
            document.getElementById('kitModalSaveBtn').onclick = saveKitEdit;
            document.getElementById('kitModalDeleteBtn').style.display = 'inline-block';
            
            renderKitComponentsList(kit.components);
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function saveKitEdit() {
            if (!currentEditKit) return;
            
            const kit = kits[currentEditKit];
            const cost = parseFloat(document.getElementById('newKitCost').value) || 0;
            const price = parseFloat(document.getElementById('newKitPrice').value) || 0;
            const selectedComponents = {};
            
            for (const [componentName] of Object.entries(components)) {
                const safeId = componentName.replace(/[^a-zA-Z0-9]/g, '_');
                const checkbox = document.getElementById(`kit_${safeId}`);
                const qtyInput = document.getElementById(`qty_${safeId}`);
                if (checkbox && checkbox.checked) {
                    const qty = parseInt(qtyInput.value) || 1;
                    selectedComponents[componentName] = qty;
                }
            }
            
            if (Object.keys(selectedComponents).length === 0) {
                alert('Please select at least one component');
                return;
            }
            
            const calculatedCost = calculateKitCost(selectedComponents);
            
            kit.cost = cost > 0 ? cost : calculatedCost;
            kit.price = price;
            kit.components = selectedComponents;
            
            closeNewKitModal();
            saveToLocalStorage();
            syncToFirebase();
            renderKits();
            showToast('Kit updated');
        }
        
        function deleteCurrentKit() {
            if (!currentEditKit) return;
            if (!confirm(`Are you sure you want to delete the ${currentEditKit} kit?`)) return;
            
            delete kits[currentEditKit];
            
            closeNewKitModal();
            saveToLocalStorage();
            syncToFirebase();
            renderKits();
            renderOrders();
            showToast('Kit deleted');
        }
        
        async function deleteAllOrders() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL orders!\n\nAre you absolutely sure? This cannot be undone!')) {
                return;
            }
            
            if (!confirm('üö® FINAL CONFIRMATION: Delete all ' + orders.length + ' orders?\n\nType YES in your mind and click OK to proceed.')) {
                return;
            }
            
            showToast('Deleting all orders...');
            
            orders = [];
            nextOrderId = 1;
            
            saveToLocalStorage();
            
            if (window.firebaseReady && firebaseAvailable && window.firebaseAuth.currentUser) {
                try {
                    updateFirebaseStatus('syncing', 'Deleting orders...');
                    
                    const ordersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'orders'));
                    
                    const batch = window.firebaseWriteBatch(window.firebaseDB);
                    ordersSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    const nextOrderIdRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'nextOrderId');
                    batch.set(nextOrderIdRef, { value: 1 });
                    
                    await batch.commit();
                    updateFirebaseStatus('connected', 'Connected');
                    showToast('All orders deleted successfully!');
                } catch (error) {
                    console.error('Error deleting from Firebase:', error);
                    showToast('Orders deleted locally, Firebase sync failed');
                }
            } else {
                showToast('All orders deleted locally');
            }
            
            renderAll();
        }
        
        // Initialize
        window.showNewOrderModal = showNewOrderModal;
        window.closeNewOrderModal = closeNewOrderModal;
        window.addNewOrder = addNewOrder;
        window.editOrder = editOrder;
        window.saveOrderEdit = saveOrderEdit;
        window.deleteCurrentOrder = deleteCurrentOrder;
        window.deleteAllOrders = deleteAllOrders;
        window.showShipOrderModalFromEdit = showShipOrderModalFromEdit;
        window.closeShipOrderModal = closeShipOrderModal;
        window.confirmShipOrder = confirmShipOrder;
        window.unshipOrder = unshipOrder;
        window.showAddProductToOrder = showAddProductToOrder;
        window.updateProductQuantity = updateProductQuantity;
        window.removeProductFromOrder = removeProductFromOrder;
        window.updateOrderSummary = updateOrderSummary;
        window.showNewComponentModal = showNewComponentModal;
        window.closeEditComponentModal = closeEditComponentModal;
        window.toggleCostFields = toggleCostFields;
        window.saveComponentEdit = saveComponentEdit;
        window.editComponent = editComponent;
        window.deleteCurrentComponent = deleteCurrentComponent;
        window.showNewKitModal = showNewKitModal;
        window.closeNewKitModal = closeNewKitModal;
        window.toggleKitComponent = toggleKitComponent;
        window.addNewKit = addNewKit;
        window.editKit = editKit;
        window.saveKitEdit = saveKitEdit;
        window.deleteCurrentKit = deleteCurrentKit;
        window.handleCSVImport = handleCSVImport;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.manualSync = manualSync;
        window.initializeApp = initializeApp;
        window.selectAllText = selectAllText;
        window.handleBusinessNameKeypress = handleBusinessNameKeypress;
        window.saveBusinessName = saveBusinessName;
        window.updatePeriodFilter = updatePeriodFilter;
        window.updateSourceOptions = updateSourceOptions;
        window.handleSourceChange = handleSourceChange;
    </script>
</body>
</html>
