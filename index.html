<!DOCTYPE html>
<html lang="en">
<!--
Budget Build Club Inventory Manager
Version: 1.2.1
Last Updated: 2025-10-28

CHANGELOG:
v1.2.1 (2025-10-28)
- Added Firebase Authentication (email/password)
- Added login screen for secure access
- Added logout functionality
- Updated security rules to require authentication
- Remember me functionality with secure token storage
- Auto-login if previously authenticated

v1.2.0 (2025-10-28)
- Added version number display in header
- Implemented localStorage fallback
- Offline-first architecture with background sync
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Build Club Inventory Manager v1.2.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Login Screen Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .login-box h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }
        
        .login-box p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .remember-me input[type="checkbox"] {
            width: auto;
        }
        
        /* App Container (hidden until logged in) */
        .app-container {
            display: none;
        }
        
        .app-container.show {
            display: block;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .version-badge {
            position: absolute;
            top: 15px;
            left: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.3);
            letter-spacing: 0.5px;
        }
        
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .firebase-status-pill {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 10px;
            cursor: pointer;
        }
        
        .firebase-status-pill.connected { background: rgba(16, 185, 129, 0.9); }
        .firebase-status-pill.offline { background: rgba(107, 114, 128, 0.9); }
        .firebase-status-pill.syncing { background: rgba(245, 158, 11, 0.9); }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .file-label {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            display: inline-block;
        }
        
        .file-label:hover {
            background: #5568d3;
        }
        
        .controls input[type="file"] {
            display: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr {
            cursor: pointer;
        }
        
        tbody tr:hover {
            background: #f9fafb;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            transform: translateY(150px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .danger-zone {
            margin-top: 30px;
            padding: 15px;
            background: #fee2e2;
            border-radius: 8px;
            border: 2px solid #fecaca;
        }
        
        .danger-zone h3 {
            color: #991b1b;
            margin-bottom: 10px;
        }
        
        .orders-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-paid {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-paid.awaiting {
            background: #f59e0b;
        }
        
        .status-unpaid {
            background: #ef4444;
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .onhand-ok { background: #d1fae5; color: #065f46; font-weight: bold; padding: 8px; border-radius: 6px; }
        .onhand-low { background: #fed7aa; color: #92400e; font-weight: bold; padding: 8px; border-radius: 6px; }
        .onhand-critical { background: #fecaca; color: #991b1b; font-weight: bold; padding: 8px; border-radius: 6px; }
        .inventory-ok { color: #10b981; font-weight: bold; }
        .inventory-low { color: #f59e0b; font-weight: bold; }
        .inventory-critical { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>
    
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>🔐 Login Required</h1>
            <p>Budget Build Club Inventory Manager v1.2.1</p>
            
            <div id="loginError" class="error-message"></div>
            
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="••••••••" autocomplete="current-password">
            </div>
            
            <div class="remember-me">
                <input type="checkbox" id="rememberMe" checked>
                <label for="rememberMe">Remember me</label>
            </div>
            
            <button class="btn" id="loginBtn" onclick="handleLogin()">Sign In</button>
        </div>
    </div>
    
    <!-- Main App (hidden until logged in) -->
    <div id="appContainer" class="app-container">
        <div class="container">
            <div class="header">
                <div class="version-badge">v1.2.1</div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
                <h1>📦 Budget Build Club Inventory Manager</h1>
                <p>Track orders, components, and inventory in real-time</p>
                <div id="firebaseStatus" class="firebase-status-pill offline" onclick="manualSync()">
                    <span id="firebaseStatusText">Offline Mode</span>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Active Orders</h3>
                    <div class="value" id="activeOrdersCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Paid & Ready</h3>
                    <div class="value" id="readyToShipCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Components</h3>
                    <div class="value" id="totalComponents">0</div>
                </div>
                <div class="stat-card">
                    <h3>Inventory Value</h3>
                    <div class="value" id="inventoryValue">$0</div>
                </div>
            </div>
            
            <div class="content">
                <div class="section">
                    <h2>📋 Active Orders</h2>
                    <div class="controls">
                        <button class="btn btn-small" onclick="openNewOrderModal()">+ New Order</button>
                        <label class="file-label">
                            📥 Import CSV
                            <input type="file" id="importOrdersCSV" accept=".csv" onchange="importOrdersCSV(event)">
                        </label>
                        <button class="btn btn-small" onclick="exportOrdersCSV()">📤 Export</button>
                    </div>
                    <div id="ordersSummary" class="orders-summary"></div>
                    <table>
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Order #</th>
                                <th>Products</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr><td colspan="4" style="text-align: center; color: #999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>📦 Inventory Status</h2>
                    <div class="controls">
                        <button class="btn btn-small" onclick="openNewComponentModal()">+ New Component</button>
                        <label class="file-label">
                            📥 Import CSV
                            <input type="file" id="importInventoryCSV" accept=".csv" onchange="importInventoryCSV(event)">
                        </label>
                        <button class="btn btn-small" onclick="exportInventoryCSV()">📤 Export Full Inventory</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Needed</th>
                                <th>On Hand</th>
                                <th>On Order</th>
                                <th>ETA</th>
                                <th>Total Available</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                            <tr><td colspan="7" style="text-align: center; color: #999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>🎁 Kits</h2>
                    <div class="controls">
                        <button class="btn btn-small" onclick="openNewKitModal()">+ New Kit</button>
                        <label class="file-label">
                            📥 Import CSV
                            <input type="file" id="importKitsCSV" accept=".csv" onchange="importKitsCSV(event)">
                        </label>
                        <button class="btn btn-small" onclick="exportKitsCSV()">📤 Export</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Kit Name</th>
                                <th>Components</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Can Make</th>
                            </tr>
                        </thead>
                        <tbody id="kitsBody">
                            <tr><td colspan="5" style="text-align: center; color: #999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>✅ Shipped Orders</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Amount</th>
                                <th>Tracking</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shippedBody">
                            <tr><td colspan="5" style="text-align: center; color: #999;">No shipped orders yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals (simplified versions) -->
    <div id="newOrderModal" class="modal">
        <div class="modal-content">
            <h2 id="orderModalTitle">New Order</h2>
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="orderName" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label>Shopify Order #</label>
                <input type="text" id="orderShopifyNumber" placeholder="#1001">
            </div>
            <div id="orderKitsContainer"></div>
            <div class="checkbox-group">
                <input type="checkbox" id="orderPaid">
                <label for="orderPaid">Paid</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="orderShipped">
                <label for="orderShipped">Shipped</label>
            </div>
            <div class="form-group" id="trackingGroup" style="display: none;">
                <label>Tracking Number</label>
                <input type="text" id="orderTracking" placeholder="1Z999AA10123456784">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="saveOrder()">Save Order</button>
                <button class="btn btn-danger" onclick="closeNewOrderModal()">Cancel</button>
            </div>
            <div id="deleteOrderZone" class="danger-zone" style="display: none;">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" onclick="deleteCurrentOrder()">Delete Order</button>
            </div>
        </div>
    </div>
    
    <div id="newComponentModal" class="modal">
        <div class="modal-content">
            <h2 id="componentModalTitle">New Component</h2>
            <div class="form-group">
                <label>Component Name</label>
                <input type="text" id="componentName" placeholder="M3 Screw">
            </div>
            <div class="form-group">
                <label>On Hand</label>
                <input type="number" id="componentOnHand" value="0">
            </div>
            <div class="form-group">
                <label>On Order</label>
                <input type="number" id="componentOnOrder" value="0">
            </div>
            <div class="form-group">
                <label>ETA</label>
                <input type="text" id="componentETA" placeholder="2 weeks">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="saveComponent()">Save</button>
                <button class="btn btn-danger" onclick="closeNewComponentModal()">Cancel</button>
            </div>
            <div id="deleteComponentZone" class="danger-zone" style="display: none;">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" onclick="deleteCurrentComponent()">Delete</button>
            </div>
        </div>
    </div>
    
    <div id="newKitModal" class="modal">
        <div class="modal-content">
            <h2 id="kitModalTitle">New Kit</h2>
            <div class="form-group">
                <label>Kit Name</label>
                <input type="text" id="kitName" placeholder="Basic Kit">
            </div>
            <div class="form-group">
                <label>Cost</label>
                <input type="number" step="0.01" id="kitCost" value="0">
            </div>
            <div class="form-group">
                <label>Price</label>
                <input type="number" step="0.01" id="kitPrice" value="0">
            </div>
            <div class="form-group">
                <label>Components</label>
                <div id="kitComponentsContainer"></div>
                <button class="btn btn-small" onclick="addKitComponent()">+ Add Component</button>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="saveKit()">Save</button>
                <button class="btn btn-danger" onclick="closeNewKitModal()">Cancel</button>
            </div>
            <div id="deleteKitZone" class="danger-zone" style="display: none;">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" onclick="deleteCurrentKit()">Delete</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, writeBatch, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAOyGTs-fGXuY08pmmCIxLtB_02_gFwMJs",
            authDomain: "inventory-464e0.firebaseapp.com",
            projectId: "inventory-464e0",
            storageBucket: "inventory-464e0.firebasestorage.app",
            messagingSenderId: "1042168855557",
            appId: "1:1042168855557:web:1165defaf0bee779e8706c"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Set persistence
        setPersistence(auth, browserLocalPersistence);
        
        // Enable offline persistence
        enableIndexedDbPersistence(db).catch((err) => {
            console.log('Persistence error:', err.code);
        });
        
        // Expose to global scope
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.firebaseCollection = collection;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseWriteBatch = writeBatch;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.firebaseReady = true;
        
        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User authenticated:', user.email);
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').classList.add('show');
                window.initializeApp();
            } else {
                console.log('User not authenticated');
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('appContainer').classList.remove('show');
            }
        });
    </script>
    
    <script>
        const APP_VERSION = '1.2.1';
        let orders = [];
        let components = {};
        let kits = {};
        let nextOrderId = 1;
        let currentEditOrder = null;
        let currentEditComponent = null;
        let currentEditKit = null;
        let firebaseAvailable = false;
        
        // Login handling
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.classList.add('show');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.classList.remove('show');
            
            try {
                await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Invalid email or password. Please try again.';
                errorDiv.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }
        
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.firebaseAuth);
                    showToast('Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Error logging out');
                }
            }
        }
        
        // Allow Enter key to login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        });
        
        // Initialize app function
        function initializeApp() {
            console.log(`Initializing Budget Build Club Inventory Manager v${APP_VERSION}`);
            loadFromLocalStorage();
            tryLoadFromFirebase();
        }
        
        function loadFromLocalStorage() {
            console.log('Loading from localStorage...');
            try {
                const savedOrders = localStorage.getItem('bbc_orders');
                const savedComponents = localStorage.getItem('bbc_components');
                const savedKits = localStorage.getItem('bbc_kits');
                const savedNextOrderId = localStorage.getItem('bbc_nextOrderId');
                
                if (savedOrders) orders = JSON.parse(savedOrders);
                if (savedComponents) components = JSON.parse(savedComponents);
                if (savedKits) kits = JSON.parse(savedKits);
                if (savedNextOrderId) nextOrderId = parseInt(savedNextOrderId);
                
                console.log(`Loaded: ${orders.length} orders, ${Object.keys(components).length} components, ${Object.keys(kits).length} kits`);
                updateFirebaseStatus('offline', 'Offline Mode');
                renderAll();
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('bbc_orders', JSON.stringify(orders));
                localStorage.setItem('bbc_components', JSON.stringify(components));
                localStorage.setItem('bbc_kits', JSON.stringify(kits));
                localStorage.setItem('bbc_nextOrderId', nextOrderId.toString());
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        async function tryLoadFromFirebase() {
            if (!window.firebaseReady || !window.firebaseAuth.currentUser) return;
            
            updateFirebaseStatus('syncing', 'Connecting...');
            console.log('Loading from Firebase...');
            
            try {
                const ordersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'orders'));
                const firebaseOrders = [];
                ordersSnapshot.forEach(doc => firebaseOrders.push(doc.data()));
                
                const componentsSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'components'));
                const firebaseComponents = {};
                componentsSnapshot.forEach(doc => firebaseComponents[doc.id] = doc.data());
                
                const kitsSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDB, 'kits'));
                const firebaseKits = {};
                kitsSnapshot.forEach(doc => firebaseKits[doc.id] = doc.data());
                
                const docRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'nextOrderId');
                const docSnap = await window.firebaseGetDoc(docRef);
                let firebaseNextOrderId = 1;
                if (docSnap.exists()) firebaseNextOrderId = docSnap.data().value;
                
                console.log(`Firebase: ${firebaseOrders.length} orders, ${Object.keys(firebaseComponents).length} components, ${Object.keys(firebaseKits).length} kits`);
                
                if (firebaseOrders.length > 0 || Object.keys(firebaseComponents).length > 0 || Object.keys(firebaseKits).length > 0) {
                    orders = firebaseOrders;
                    components = firebaseComponents;
                    kits = firebaseKits;
                    nextOrderId = firebaseNextOrderId;
                    saveToLocalStorage();
                    renderAll();
                } else if (orders.length > 0 || Object.keys(components).length > 0 || Object.keys(kits).length > 0) {
                    console.log('Pushing local data to Firebase...');
                    await syncToFirebase();
                }
                
                firebaseAvailable = true;
                updateFirebaseStatus('connected', 'Connected');
            } catch (error) {
                console.error('Firebase error:', error);
                firebaseAvailable = false;
                updateFirebaseStatus('offline', 'Offline Mode');
                showToast('Working in offline mode');
            }
        }
        
        async function syncToFirebase() {
            if (!window.firebaseReady || !firebaseAvailable || !window.firebaseAuth.currentUser) return;
            
            updateFirebaseStatus('syncing', 'Syncing...');
            try {
                const batch = window.firebaseWriteBatch(window.firebaseDB);
                
                for (const order of orders) {
                    const orderRef = window.firebaseDoc(window.firebaseDB, 'orders', String(order.id));
                    batch.set(orderRef, order);
                }
                
                for (const [name, comp] of Object.entries(components)) {
                    const compRef = window.firebaseDoc(window.firebaseDB, 'components', name);
                    batch.set(compRef, comp);
                }
                
                for (const [name, kit] of Object.entries(kits)) {
                    const kitRef = window.firebaseDoc(window.firebaseDB, 'kits', name);
                    batch.set(kitRef, kit);
                }
                
                const nextOrderIdRef = window.firebaseDoc(window.firebaseDB, 'metadata', 'nextOrderId');
                batch.set(nextOrderIdRef, { value: nextOrderId });
                
                await batch.commit();
                updateFirebaseStatus('connected', 'Synced');
                showToast('Synced to cloud');
                setTimeout(() => updateFirebaseStatus('connected', 'Connected'), 2000);
            } catch (error) {
                console.error('Sync error:', error);
                updateFirebaseStatus('offline', 'Sync Failed');
            }
        }
        
        function manualSync() {
            if (firebaseAvailable) syncToFirebase();
            else tryLoadFromFirebase();
        }
        
        function updateFirebaseStatus(status, text) {
            const statusPill = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            statusPill.className = 'firebase-status-pill ' + status;
            statusText.textContent = text;
        }
        
        function renderAll() {
            updateStats();
            renderOrders();
            renderInventory();
            renderKits();
            renderShippedOrders();
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function updateStats() {
            const activeOrders = orders.filter(o => !o.shipped);
            const readyToShip = activeOrders.filter(o => o.paid && canFulfillOrder(o));
            let inventoryValue = 0;
            for (const comp of Object.values(components)) {
                inventoryValue += comp.onHand * 0.10;
            }
            document.getElementById('activeOrdersCount').textContent = activeOrders.length;
            document.getElementById('readyToShipCount').textContent = readyToShip.length;
            document.getElementById('totalComponents').textContent = Object.keys(components).length;
            document.getElementById('inventoryValue').textContent = '$' + inventoryValue.toFixed(0);
        }
        
        function canFulfillOrder(order) {
            for (const [kitName, kit] of Object.entries(kits)) {
                const qtyNeeded = order[kitName.toLowerCase()] || 0;
                if (qtyNeeded > 0) {
                    for (const [componentName, componentQty] of Object.entries(kit.components)) {
                        const comp = components[componentName];
                        if (!comp || comp.onHand < qtyNeeded * componentQty) return false;
                    }
                }
            }
            return true;
        }
        
        // Simplified rendering functions (include full implementations from previous version)
        function renderOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            const activeOrders = orders.filter(o => !o.shipped);
            
            if (activeOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No active orders</td></tr>';
                renderOrdersSummary();
                return;
            }
            
            activeOrders.forEach(order => {
                let totalQty = 0;
                const productList = [];
                for (const kitName of Object.keys(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        totalQty += qty;
                        productList.push(`${qty}× ${kitName}`);
                    }
                }
                const productText = totalQty > 0 ? `${totalQty} item${totalQty > 1 ? 's' : ''} (${productList.join(', ')})` : 'No products';
                const ready = canFulfillOrder(order);
                let bgColor = '', statusText = '';
                if (order.paid && ready) {
                    bgColor = '#d1fae5';
                    statusText = '<span class="status-paid">✓ PAID & READY</span>';
                } else if (order.paid) {
                    bgColor = '#fef3c7';
                    statusText = '<span class="status-paid awaiting">⚠ AWAITING STOCK</span>';
                } else {
                    bgColor = '#fee2e2';
                    statusText = '<span class="status-unpaid">UNPAID</span>';
                }
                
                const tr = document.createElement('tr');
                tr.style.backgroundColor = bgColor;
                tr.onclick = () => editOrder(order.id);
                tr.innerHTML = `
                    <td><strong>${order.name}</strong></td>
                    <td>${order.shopifyOrderNumber || '-'}</td>
                    <td>${productText}</td>
                    <td>${statusText}</td>
                `;
                tbody.appendChild(tr);
            });
            renderOrdersSummary();
        }
        
        function renderOrdersSummary() {
            const activeOrders = orders.filter(o => !o.shipped);
            const kitTotals = {};
            activeOrders.forEach(order => {
                for (const kitName of Object.keys(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) kitTotals[kitName] = (kitTotals[kitName] || 0) + qty;
                }
            });
            const summaryDiv = document.getElementById('ordersSummary');
            summaryDiv.innerHTML = '';
            for (const [kitName, total] of Object.entries(kitTotals)) {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                card.innerHTML = `
                    <div style="font-size: 12px; color: #666; font-weight: 600; margin-bottom: 5px;">${kitName.toUpperCase()}</div>
                    <div style="font-size: 24px; color: #667eea; font-weight: bold;">${total}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">to build</div>
                `;
                summaryDiv.appendChild(card);
            }
            if (Object.keys(kitTotals).length === 0) {
                summaryDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No active orders</div>';
            }
        }
        
        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            if (Object.keys(components).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No components. Import CSV or add manually.</td></tr>';
                return;
            }
            for (const [name, comp] of Object.entries(components)) {
                let needed = 0;
                const paidOrders = orders.filter(o => o.paid && !o.shipped);
                paidOrders.forEach(order => {
                    for (const [kitName, kit] of Object.entries(kits)) {
                        const kitQty = order[kitName.toLowerCase()] || 0;
                        const componentQty = kit.components[name] || 0;
                        needed += kitQty * componentQty;
                    }
                });
                const totalAvailable = comp.onHand + comp.onOrder;
                let statusClass = 'inventory-ok', statusText = '✓ OK', onHandClass = 'onhand-ok';
                if (comp.onHand < needed) {
                    if (totalAvailable >= needed) {
                        statusClass = 'inventory-low';
                        statusText = '⚠ On Order';
                        onHandClass = 'onhand-low';
                    } else {
                        statusClass = 'inventory-critical';
                        statusText = '⚠️ Need Ordered';
                        onHandClass = 'onhand-critical';
                    }
                }
                const row = document.createElement('tr');
                row.onclick = () => editComponent(name);
                row.innerHTML = `
                    <td><strong>${name}</strong></td>
                    <td>${needed}</td>
                    <td><span class="${onHandClass}">${comp.onHand}</span></td>
                    <td>${comp.onOrder}</td>
                    <td>${comp.eta}</td>
                    <td><strong>${totalAvailable}</strong></td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function renderKits() {
            const tbody = document.getElementById('kitsBody');
            tbody.innerHTML = '';
            if (Object.keys(kits).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No kits. Import CSV or add manually.</td></tr>';
                return;
            }
            for (const [kitName, kit] of Object.entries(kits)) {
                const canMake = calculateKitsCanMake(kitName);
                const componentsList = Object.entries(kit.components).map(([comp, qty]) => `${qty}× ${comp}`).join(', ');
                const row = document.createElement('tr');
                row.onclick = () => editKit(kitName);
                row.innerHTML = `
                    <td><strong>${kitName}</strong></td>
                    <td>${componentsList}</td>
                    <td>${(kit.cost || 0).toFixed(2)}</td>
                    <td>${(kit.price || 0).toFixed(2)}</td>
                    <td><strong>${canMake}</strong></td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function calculateKitsCanMake(kitName) {
            const kit = kits[kitName];
            if (!kit) return 0;
            let minCanMake = Infinity;
            for (const [componentName, qtyNeeded] of Object.entries(kit.components)) {
                const comp = components[componentName];
                if (!comp) return 0;
                const canMake = Math.floor(comp.onHand / qtyNeeded);
                minCanMake = Math.min(minCanMake, canMake);
            }
            return minCanMake === Infinity ? 0 : minCanMake;
        }
        
        function renderShippedOrders() {
            const tbody = document.getElementById('shippedBody');
            tbody.innerHTML = '';
            const shippedOrders = orders.filter(o => o.shipped);
            if (shippedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No shipped orders yet</td></tr>';
                return;
            }
            shippedOrders.forEach(order => {
                let amount = 0, items = [];
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        items.push(`${qty} ${kitName}`);
                        amount += qty * (kit.price || 0);
                    }
                }
                const row = document.createElement('tr');
                row.onclick = () => editOrder(order.id);
                row.innerHTML = `
                    <td><strong>${order.name}</strong></td>
                    <td>${items.join(', ')}</td>
                    <td><strong>$${amount.toFixed(2)}</strong></td>
                    <td>${order.tracking || 'N/A'}</td>
                    <td><button class="btn btn-small btn-danger" onclick="event.stopPropagation(); unshipOrder(${order.id})">Unship</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Modal functions (simplified - add full implementations)
        function openNewOrderModal() {
            currentEditOrder = null;
            document.getElementById('orderModalTitle').textContent = 'New Order';
            document.getElementById('orderName').value = '';
            document.getElementById('orderShopifyNumber').value = '';
            document.getElementById('orderPaid').checked = false;
            document.getElementById('orderShipped').checked = false;
            document.getElementById('orderTracking').value = '';
            document.getElementById('trackingGroup').style.display = 'none';
            document.getElementById('deleteOrderZone').style.display = 'none';
            const container = document.getElementById('orderKitsContainer');
            container.innerHTML = '';
            for (const kitName of Object.keys(kits)) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>${kitName}</label><input type="number" id="order${kitName}" value="0" min="0">`;
                container.appendChild(div);
            }
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function closeNewOrderModal() {
            document.getElementById('newOrderModal').classList.remove('active');
        }
        
        function saveOrder() {
            const name = document.getElementById('orderName').value.trim();
            if (!name) { alert('Please enter a customer name'); return; }
            const order = currentEditOrder ? orders.find(o => o.id === currentEditOrder) : { id: nextOrderId++ };
            order.name = name;
            order.shopifyOrderNumber = document.getElementById('orderShopifyNumber').value.trim();
            order.paid = document.getElementById('orderPaid').checked;
            order.shipped = document.getElementById('orderShipped').checked;
            order.tracking = document.getElementById('orderTracking').value.trim();
            for (const kitName of Object.keys(kits)) {
                order[kitName.toLowerCase()] = parseInt(document.getElementById(`order${kitName}`).value) || 0;
            }
            if (!currentEditOrder) orders.push(order);
            saveToLocalStorage();
            syncToFirebase();
            closeNewOrderModal();
            renderAll();
            showToast('Order saved');
        }
        
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            currentEditOrder = orderId;
            document.getElementById('orderModalTitle').textContent = 'Edit Order';
            document.getElementById('orderName').value = order.name;
            document.getElementById('orderShopifyNumber').value = order.shopifyOrderNumber || '';
            document.getElementById('orderPaid').checked = order.paid;
            document.getElementById('orderShipped').checked = order.shipped;
            document.getElementById('orderTracking').value = order.tracking || '';
            document.getElementById('trackingGroup').style.display = order.shipped ? 'block' : 'none';
            document.getElementById('deleteOrderZone').style.display = 'block';
            const container = document.getElementById('orderKitsContainer');
            container.innerHTML = '';
            for (const kitName of Object.keys(kits)) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>${kitName}</label><input type="number" id="order${kitName}" value="${order[kitName.toLowerCase()] || 0}" min="0">`;
                container.appendChild(div);
            }
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function deleteCurrentOrder() {
            if (!currentEditOrder || !confirm('Delete this order?')) return;
            orders = orders.filter(o => o.id !== currentEditOrder);
            saveToLocalStorage();
            syncToFirebase();
            closeNewOrderModal();
            renderAll();
            showToast('Order deleted');
        }
        
        function unshipOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            order.shipped = false;
            order.tracking = '';
            saveToLocalStorage();
            syncToFirebase();
            renderAll();
            showToast('Order unshipped');
        }
        
        document.getElementById('orderShipped').addEventListener('change', function() {
            document.getElementById('trackingGroup').style.display = this.checked ? 'block' : 'none';
        });
        
        // Component modal functions
        function openNewComponentModal() {
            currentEditComponent = null;
            document.getElementById('componentModalTitle').textContent = 'New Component';
            document.getElementById('componentName').value = '';
            document.getElementById('componentName').disabled = false;
            document.getElementById('componentOnHand').value = '0';
            document.getElementById('componentOnOrder').value = '0';
            document.getElementById('componentETA').value = '';
            document.getElementById('deleteComponentZone').style.display = 'none';
            document.getElementById('newComponentModal').classList.add('active');
        }
        
        function closeNewComponentModal() {
            document.getElementById('newComponentModal').classList.remove('active');
        }
        
        function saveComponent() {
            const name = document.getElementById('componentName').value.trim();
            if (!name) { alert('Please enter a component name'); return; }
            if (!currentEditComponent && components[name]) { alert('Component already exists'); return; }
            if (currentEditComponent && currentEditComponent !== name) delete components[currentEditComponent];
            components[name] = {
                onHand: parseInt(document.getElementById('componentOnHand').value) || 0,
                onOrder: parseInt(document.getElementById('componentOnOrder').value) || 0,
                eta: document.getElementById('componentETA').value.trim()
            };
            saveToLocalStorage();
            syncToFirebase();
            closeNewComponentModal();
            renderAll();
            showToast('Component saved');
        }
        
        function editComponent(name) {
            const comp = components[name];
            if (!comp) return;
            currentEditComponent = name;
            document.getElementById('componentModalTitle').textContent = 'Edit Component';
            document.getElementById('componentName').value = name;
            document.getElementById('componentName').disabled = true;
            document.getElementById('componentOnHand').value = comp.onHand;
            document.getElementById('componentOnOrder').value = comp.onOrder;
            document.getElementById('componentETA').value = comp.eta;
            document.getElementById('deleteComponentZone').style.display = 'block';
            document.getElementById('newComponentModal').classList.add('active');
        }
        
        function deleteCurrentComponent() {
            if (!currentEditComponent || !confirm(`Delete ${currentEditComponent}?`)) return;
            delete components[currentEditComponent];
            saveToLocalStorage();
            syncToFirebase();
            closeNewComponentModal();
            renderAll();
            showToast('Component deleted');
        }
        
        // Kit modal functions
        function openNewKitModal() {
            currentEditKit = null;
            document.getElementById('kitModalTitle').textContent = 'New Kit';
            document.getElementById('kitName').value = '';
            document.getElementById('kitName').disabled = false;
            document.getElementById('kitCost').value = '0';
            document.getElementById('kitPrice').value = '0';
            document.getElementById('kitComponentsContainer').innerHTML = '';
            document.getElementById('deleteKitZone').style.display = 'none';
            addKitComponent();
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function closeNewKitModal() {
            document.getElementById('newKitModal').classList.remove('active');
        }
        
        function addKitComponent() {
            const container = document.getElementById('kitComponentsContainer');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';
            const select = document.createElement('select');
            select.style.flex = '2';
            select.innerHTML = '<option value="">Select Component</option>';
            for (const name of Object.keys(components)) {
                select.innerHTML += `<option value="${name}">${name}</option>`;
            }
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '1';
            input.value = '1';
            input.style.flex = '1';
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-small btn-danger';
            removeBtn.textContent = '×';
            removeBtn.type = 'button';
            removeBtn.onclick = () => div.remove();
            div.appendChild(select);
            div.appendChild(input);
            div.appendChild(removeBtn);
            container.appendChild(div);
        }
        
        function saveKit() {
            const name = document.getElementById('kitName').value.trim();
            if (!name) { alert('Please enter a kit name'); return; }
            if (!currentEditKit && kits[name]) { alert('Kit already exists'); return; }
            const componentsObj = {};
            const container = document.getElementById('kitComponentsContainer');
            container.querySelectorAll('div').forEach(div => {
                const select = div.querySelector('select');
                const input = div.querySelector('input[type="number"]');
                const compName = select?.value;
                const qty = parseInt(input?.value) || 1;
                if (compName) componentsObj[compName] = qty;
            });
            if (Object.keys(componentsObj).length === 0) { alert('Add at least one component'); return; }
            if (currentEditKit && currentEditKit !== name) delete kits[currentEditKit];
            kits[name] = {
                cost: parseFloat(document.getElementById('kitCost').value) || 0,
                price: parseFloat(document.getElementById('kitPrice').value) || 0,
                components: componentsObj
            };
            saveToLocalStorage();
            syncToFirebase();
            closeNewKitModal();
            renderAll();
            showToast('Kit saved');
        }
        
        function editKit(kitName) {
            const kit = kits[kitName];
            if (!kit) return;
            currentEditKit = kitName;
            document.getElementById('kitModalTitle').textContent = 'Edit Kit';
            document.getElementById('kitName').value = kitName;
            document.getElementById('kitName').disabled = true;
            document.getElementById('kitCost').value = kit.cost;
            document.getElementById('kitPrice').value = kit.price;
            document.getElementById('deleteKitZone').style.display = 'block';
            const container = document.getElementById('kitComponentsContainer');
            container.innerHTML = '';
            for (const [compName, qty] of Object.entries(kit.components)) {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.gap = '10px';
                div.style.marginBottom = '10px';
                const select = document.createElement('select');
                select.style.flex = '2';
                for (const name of Object.keys(components)) {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (name === compName) opt.selected = true;
                    select.appendChild(opt);
                }
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.value = qty;
                input.style.flex = '1';
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-small btn-danger';
                removeBtn.textContent = '×';
                removeBtn.type = 'button';
                removeBtn.onclick = () => div.remove();
                div.appendChild(select);
                div.appendChild(input);
                div.appendChild(removeBtn);
                container.appendChild(div);
            }
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function deleteCurrentKit() {
            if (!currentEditKit || !confirm(`Delete ${currentEditKit}?`)) return;
            delete kits[currentEditKit];
            saveToLocalStorage();
            syncToFirebase();
            closeNewKitModal();
            renderAll();
            showToast('Kit deleted');
        }
        
        // CSV Import/Export functions (simplified versions)
        function importOrdersCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const lines = e.target.result.split('\n').filter(line => line.trim());
                if (lines.length < 2) { alert('Invalid CSV'); return; }
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    const order = { id: nextOrderId++ };
                    headers.forEach((header, index) => {
                        if (header === 'name') order.name = parts[index];
                        else if (header.includes('shopify') || header.includes('order')) order.shopifyOrderNumber = parts[index];
                        else if (header === 'paid') order.paid = parts[index].toLowerCase() === 'true' || parts[index] === '1';
                        else if (header === 'shipped') order.shipped = parts[index].toLowerCase() === 'true' || parts[index] === '1';
                        else if (header === 'tracking') order.tracking = parts[index];
                        else {
                            const kitName = Object.keys(kits).find(k => k.toLowerCase() === header);
                            if (kitName) order[kitName.toLowerCase()] = parseInt(parts[index]) || 0;
                        }
                    });
                    if (order.name) orders.push(order);
                }
                saveToLocalStorage();
                await syncToFirebase();
                renderAll();
                showToast('Orders imported');
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportOrdersCSV() {
            const kitNames = Object.keys(kits);
            let csv = 'Name,Shopify Order Number,' + kitNames.join(',') + ',Paid,Shipped,Tracking\n';
            orders.forEach(order => {
                const kitQtys = kitNames.map(k => order[k.toLowerCase()] || 0).join(',');
                csv += `${order.name},${order.shopifyOrderNumber || ''},${kitQtys},${order.paid},${order.shipped},${order.tracking || ''}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'orders.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importInventoryCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const lines = e.target.result.split('\n').filter(line => line.trim());
                if (lines.length < 2) { alert('Invalid CSV'); return; }
                components = {};
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    if (parts.length >= 4) {
                        components[parts[0]] = {
                            onHand: parseInt(parts[1]) || 0,
                            onOrder: parseInt(parts[2]) || 0,
                            eta: parts[3] || ''
                        };
                    }
                }
                saveToLocalStorage();
                await syncToFirebase();
                renderAll();
                showToast('Inventory imported');
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportInventoryCSV() {
            let csv = '=== COMPONENT INVENTORY ===\nComponent,On Hand,On Order,ETA,Needed\n';
            const paidOrders = orders.filter(o => o.paid && !o.shipped);
            const neededQuantities = {};
            paidOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const kitQty = order[kitName.toLowerCase()] || 0;
                    if (kitQty > 0) {
                        for (const [componentName, componentQty] of Object.entries(kit.components)) {
                            neededQuantities[componentName] = (neededQuantities[componentName] || 0) + (kitQty * componentQty);
                        }
                    }
                }
            });
            for (const [name, comp] of Object.entries(components)) {
                csv += `${name},${comp.onHand},${comp.onOrder},${comp.eta},${neededQuantities[name] || 0}\n`;
            }
            csv += '\n=== KIT DEFINITIONS ===\nKit Name,Cost,Price,Components,Can Make\n';
            for (const [kitName, kit] of Object.entries(kits)) {
                const canMake = calculateKitsCanMake(kitName);
                const componentsList = Object.entries(kit.components).map(([comp, qty]) => `${qty}× ${comp}`).join('; ');
                csv += `${kitName},${kit.cost},${kit.price},"${componentsList}",${canMake}\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `inventory-${date}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Inventory exported');
        }
        
        function importKitsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const lines = e.target.result.split('\n').filter(line => line.trim());
                if (lines.length < 2) { alert('Invalid CSV'); return; }
                kits = {};
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    if (parts.length >= 4) {
                        const kitName = parts[0];
                        const cost = parseFloat(parts[1]) || 0;
                        const price = parseFloat(parts[2]) || 0;
                        const componentsStr = parts[3].replace(/^"|"$/g, '');
                        const componentsObj = {};
                        if (componentsStr) {
                            componentsStr.split(';').forEach(pair => {
                                const [qty, name] = pair.split('×').map(s => s.trim());
                                if (qty && name) componentsObj[name] = parseInt(qty);
                            });
                        }
                        kits[kitName] = { cost, price, components: componentsObj };
                    }
                }
                saveToLocalStorage();
                await syncToFirebase();
                renderAll();
                showToast('Kits imported');
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportKitsCSV() {
            let csv = 'Kit Name,Cost,Price,Components\n';
            for (const [name, kit] of Object.entries(kits)) {
                const componentsStr = Object.entries(kit.components).map(([comp, qty]) => `${qty}× ${comp}`).join('; ');
                csv += `${name},${kit.cost},${kit.price},"${componentsStr}"\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kits.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
