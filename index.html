<!DOCTYPE html>
<html lang="en">
<!--
Budget Build Club Inventory Manager
Version: 1.1.1
Last Updated: 2025-10-28

CHANGELOG:
v1.1.1 (2025-10-28)
- Fixed Firebase function imports not being exposed to global scope
- Fixed "getDocs is not defined" error on page load
- Fixed "doc is not defined" error when importing CSVs
- Enhanced Export Inventory button to include comprehensive data export with all kits and components
- Added structured export format with separate sections for inventory and kit requirements
- Improved error handling for Firebase connection issues

v1.1.0 (2025-10-28)
- Replaced clickable Firebase migration button with status pill indicator
- Added automatic Firebase sync when CSV files are uploaded
- Improved error handling for empty collections
- Enhanced Firebase connection status display
- Removed manual migration requirement

v1.0.4 (2025-10-24)
- Previous stable version
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Build Club Inventory Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .firebase-status-container {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .firebase-status-pill {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .firebase-status-pill.connected {
            background: rgba(16, 185, 129, 0.9);
        }
        
        .firebase-status-pill.disconnected {
            background: rgba(239, 68, 68, 0.9);
        }
        
        .firebase-status-pill.syncing {
            background: rgba(245, 158, 11, 0.9);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .value::before {
            content: attr(data-prefix);
        }
        
        .stat-card .subvalue {
            font-size: 14px;
            color: #999;
            margin-top: 4px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr {
            cursor: pointer;
        }
        
        tbody tr:hover {
            opacity: 0.85;
        }
        
        .status-paid {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-paid.awaiting {
            background: #f59e0b;
        }
        
        .status-unpaid {
            background: #ef4444;
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .inventory-ok {
            color: #10b981;
            font-weight: bold;
        }
        
        .inventory-low {
            color: #f59e0b;
            font-weight: bold;
        }
        
        .inventory-critical {
            color: #ef4444;
            font-weight: bold;
        }
        
        .onhand-ok {
            background: #d1fae5;
            color: #065f46;
            font-weight: bold;
            padding: 8px;
            border-radius: 6px;
        }
        
        .onhand-low {
            background: #fed7aa;
            color: #92400e;
            font-weight: bold;
            padding: 8px;
            border-radius: 6px;
        }
        
        .onhand-critical {
            background: #fecaca;
            color: #991b1b;
            font-weight: bold;
            padding: 8px;
            border-radius: 6px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn-small {
            padding: 4px 10px;
            font-size: 12px;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        .danger-zone {
            margin-top: 30px;
            padding: 15px;
            background: #fee2e2;
            border-radius: 8px;
            border: 2px solid #fecaca;
        }
        
        .danger-zone h3 {
            color: #991b1b;
            margin-bottom: 10px;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            transform: translateY(150px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .controls input[type="file"] {
            display: none;
        }
        
        .file-label {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            display: inline-block;
        }
        
        .file-label:hover {
            background: #5568d3;
        }
        
        .orders-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>
    
    <div class="container">
        <div class="header">
            <div class="firebase-status-container">
                <div id="firebaseStatus" class="firebase-status-pill disconnected">
                    <div class="status-dot"></div>
                    <span id="firebaseStatusText">Connecting...</span>
                </div>
            </div>
            <h1>📦 Budget Build Club Inventory Manager</h1>
            <p>Track orders, components, and inventory in real-time</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Active Orders</h3>
                <div class="value" id="activeOrdersCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Paid & Ready</h3>
                <div class="value" id="readyToShipCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Components</h3>
                <div class="value" id="totalComponents">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Inventory Value</h3>
                <div class="value" data-prefix="$" id="inventoryValue">0</div>
            </div>
        </div>
        
        <div class="content">
            <div class="section">
                <h2>📋 Active Orders</h2>
                <div class="controls">
                    <button class="btn" onclick="openNewOrderModal()">+ New Order</button>
                    <label class="file-label">
                        📥 Import Orders CSV
                        <input type="file" id="importOrdersCSV" accept=".csv" onchange="importOrdersCSV(event)">
                    </label>
                    <button class="btn" onclick="exportOrdersCSV()">📤 Export Orders</button>
                </div>
                <div id="ordersSummary" class="orders-summary"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Order #</th>
                            <th>Products</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>📦 Inventory Status</h2>
                <div class="controls">
                    <button class="btn" onclick="openNewComponentModal()">+ New Component</button>
                    <label class="file-label">
                        📥 Import Inventory CSV
                        <input type="file" id="importInventoryCSV" accept=".csv" onchange="importInventoryCSV(event)">
                    </label>
                    <button class="btn" onclick="exportInventoryCSV()">📤 Export Full Inventory</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Needed</th>
                            <th>On Hand</th>
                            <th>On Order</th>
                            <th>ETA</th>
                            <th>Total Available</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>🎁 Kits</h2>
                <div class="controls">
                    <button class="btn" onclick="openNewKitModal()">+ New Kit</button>
                    <label class="file-label">
                        📥 Import Kits CSV
                        <input type="file" id="importKitsCSV" accept=".csv" onchange="importKitsCSV(event)">
                    </label>
                    <button class="btn" onclick="exportKitsCSV()">📤 Export Kits</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Kit Name</th>
                            <th>Components</th>
                            <th>Cost</th>
                            <th>Price</th>
                            <th>Can Make</th>
                        </tr>
                    </thead>
                    <tbody id="kitsBody"></tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>✅ Shipped Orders</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Amount</th>
                            <th>Tracking</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="shippedBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- New Order Modal -->
    <div id="newOrderModal" class="modal">
        <div class="modal-content">
            <h2 id="orderModalTitle">New Order</h2>
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="orderName" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label>Shopify Order Number (Optional)</label>
                <input type="text" id="orderShopifyNumber" placeholder="#1001">
            </div>
            <div id="orderKitsContainer"></div>
            <div class="checkbox-group">
                <input type="checkbox" id="orderPaid">
                <label for="orderPaid">Paid</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="orderShipped">
                <label for="orderShipped">Shipped</label>
            </div>
            <div class="form-group" id="trackingGroup" style="display: none;">
                <label>Tracking Number</label>
                <input type="text" id="orderTracking" placeholder="1Z999AA10123456784">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="saveOrder()">Save Order</button>
                <button class="btn btn-danger" onclick="closeNewOrderModal()">Cancel</button>
            </div>
            <div id="deleteOrderZone" class="danger-zone" style="display: none;">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" onclick="deleteCurrentOrder()">Delete Order</button>
            </div>
        </div>
    </div>
    
    <!-- New Component Modal -->
    <div id="newComponentModal" class="modal">
        <div class="modal-content">
            <h2 id="componentModalTitle">New Component</h2>
            <div class="form-group">
                <label>Component Name</label>
                <input type="text" id="componentName" placeholder="M3 Screw">
            </div>
            <div class="form-group">
                <label>On Hand</label>
                <input type="number" id="componentOnHand" value="0">
            </div>
            <div class="form-group">
                <label>On Order</label>
                <input type="number" id="componentOnOrder" value="0">
            </div>
            <div class="form-group">
                <label>ETA</label>
                <input type="text" id="componentETA" placeholder="2 weeks">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="saveComponent()">Save Component</button>
                <button class="btn btn-danger" onclick="closeNewComponentModal()">Cancel</button>
            </div>
            <div id="deleteComponentZone" class="danger-zone" style="display: none;">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" onclick="deleteCurrentComponent()">Delete Component</button>
            </div>
        </div>
    </div>
    
    <!-- New Kit Modal -->
    <div id="newKitModal" class="modal">
        <div class="modal-content">
            <h2 id="kitModalTitle">New Kit</h2>
            <div class="form-group">
                <label>Kit Name</label>
                <input type="text" id="kitName" placeholder="Basic Kit">
            </div>
            <div class="form-group">
                <label>Cost</label>
                <input type="number" step="0.01" id="kitCost" value="0">
            </div>
            <div class="form-group">
                <label>Price</label>
                <input type="number" step="0.01" id="kitPrice" value="0">
            </div>
            <div class="form-group">
                <label>Components</label>
                <div id="kitComponentsContainer"></div>
                <button class="btn btn-small" onclick="addKitComponent()">+ Add Component</button>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="saveKit()">Save Kit</button>
                <button class="btn btn-danger" onclick="closeNewKitModal()">Cancel</button>
            </div>
            <div id="deleteKitZone" class="danger-zone" style="display: none;">
                <h3>⚠️ Danger Zone</h3>
                <button class="btn btn-danger" onclick="deleteCurrentKit()">Delete Kit</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCiQ_BXP5SIBkZJIlWNCKQ5n0Pj8gkPzz8",
            authDomain: "product-tracking-app-8c663.firebaseapp.com",
            projectId: "product-tracking-app-8c663",
            storageBucket: "product-tracking-app-8c663.firebasestorage.app",
            messagingSenderId: "990878772679",
            appId: "1:990878772679:web:b4937a2b2f0b47c1a9ad43"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Expose Firebase functions to global scope
        window.firebaseDB = db;
        window.firebaseCollection = collection;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseWriteBatch = writeBatch;
        
        // Update Firebase status
        window.updateFirebaseStatus('connected', 'Connected');
        
        // Initialize data loading
        window.initializeApp();
    </script>
    
    <script>
        let orders = [];
        let components = {};
        let kits = {};
        let nextOrderId = 1;
        let currentEditOrder = null;
        let currentEditComponent = null;
        let currentEditKit = null;
        let dataLoaded = {
            orders: false,
            components: false,
            kits: false,
            nextOrderId: false
        };
        
        // Initialize app function
        function initializeApp() {
            loadDataFromFirebase();
            loadNextOrderId();
        }
        
        // Firebase Status Updates
        function updateFirebaseStatus(status, text) {
            const statusPill = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            
            statusPill.className = 'firebase-status-pill ' + status;
            statusText.textContent = text;
        }
        
        // Auto-sync to Firebase when CSV is imported
        async function autoSyncToFirebase() {
            updateFirebaseStatus('syncing', 'Syncing...');
            try {
                await saveAllDataToFirebase();
                updateFirebaseStatus('connected', 'Synced');
                showToast('Data automatically synced to Firebase');
                setTimeout(() => {
                    updateFirebaseStatus('connected', 'Connected');
                }, 2000);
            } catch (error) {
                console.error('Auto-sync error:', error);
                updateFirebaseStatus('disconnected', 'Sync Failed');
                showToast('Auto-sync failed: ' + error.message);
            }
        }
        
        async function saveAllDataToFirebase() {
            const batch = firebaseWriteBatch(firebaseDB);
            
            // Save orders
            for (const order of orders) {
                const orderRef = firebaseDoc(firebaseDB, 'orders', String(order.id));
                batch.set(orderRef, order);
            }
            
            // Save components
            for (const [name, comp] of Object.entries(components)) {
                const compRef = firebaseDoc(firebaseDB, 'components', name);
                batch.set(compRef, comp);
            }
            
            // Save kits
            for (const [name, kit] of Object.entries(kits)) {
                const kitRef = firebaseDoc(firebaseDB, 'kits', name);
                batch.set(kitRef, kit);
            }
            
            // Save nextOrderId
            const nextOrderIdRef = firebaseDoc(firebaseDB, 'metadata', 'nextOrderId');
            batch.set(nextOrderIdRef, { value: nextOrderId });
            
            await batch.commit();
        }
        
        async function loadDataFromFirebase() {
            updateFirebaseStatus('syncing', 'Loading...');
            console.log('Checking for existing data in Firebase...');
            
            try {
                // Load orders
                const ordersSnapshot = await firebaseGetDocs(firebaseCollection(firebaseDB, 'orders'));
                orders = [];
                ordersSnapshot.forEach(doc => {
                    orders.push(doc.data());
                });
                dataLoaded.orders = true;
                console.log('Orders loaded:', orders.length);
                
                // Load components
                const componentsSnapshot = await firebaseGetDocs(firebaseCollection(firebaseDB, 'components'));
                components = {};
                componentsSnapshot.forEach(doc => {
                    components[doc.id] = doc.data();
                });
                dataLoaded.components = true;
                console.log('Components loaded:', Object.keys(components).length);
                
                // Load kits
                const kitsSnapshot = await firebaseGetDocs(firebaseCollection(firebaseDB, 'kits'));
                kits = {};
                kitsSnapshot.forEach(doc => {
                    kits[doc.id] = doc.data();
                });
                dataLoaded.kits = true;
                console.log('Kits loaded:', Object.keys(kits).length);
                
                checkAllDataLoaded();
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                updateFirebaseStatus('disconnected', 'Load Failed');
                showToast('Failed to load data from Firebase');
                // Still mark as loaded so app can continue
                dataLoaded.orders = true;
                dataLoaded.components = true;
                dataLoaded.kits = true;
                checkAllDataLoaded();
            }
        }
        
        function checkAllDataLoaded() {
            if (dataLoaded.orders && dataLoaded.components && dataLoaded.kits && dataLoaded.nextOrderId) {
                console.log('All data loaded from Firebase');
                updateFirebaseStatus('connected', 'Connected');
                updateStats();
                renderOrders();
                renderInventory();
                renderKits();
                renderShippedOrders();
            }
        }
        
        async function loadNextOrderId() {
            try {
                const docRef = firebaseDoc(firebaseDB, 'metadata', 'nextOrderId');
                const docSnap = await firebaseGetDoc(docRef);
                if (docSnap.exists()) {
                    nextOrderId = docSnap.data().value;
                } else {
                    nextOrderId = Math.max(...orders.map(o => o.id), 0) + 1;
                }
                dataLoaded.nextOrderId = true;
                console.log('NextOrderId loaded:', nextOrderId);
                checkAllDataLoaded();
            } catch (error) {
                console.error('Error loading nextOrderId:', error);
                nextOrderId = 1;
                dataLoaded.nextOrderId = true;
                checkAllDataLoaded();
            }
        }
        
        async function saveOrderToFirebase(order) {
            try {
                const orderRef = firebaseDoc(firebaseDB, 'orders', String(order.id));
                await firebaseSetDoc(orderRef, order);
            } catch (error) {
                console.error('Error saving order:', error);
                showToast('Failed to save order to Firebase');
            }
        }
        
        async function deleteOrderFromFirebase(orderId) {
            try {
                const orderRef = firebaseDoc(firebaseDB, 'orders', String(orderId));
                await firebaseDeleteDoc(orderRef);
            } catch (error) {
                console.error('Error deleting order:', error);
                showToast('Failed to delete order from Firebase');
            }
        }
        
        async function saveComponentToFirebase(name, component) {
            try {
                const compRef = firebaseDoc(firebaseDB, 'components', name);
                await firebaseSetDoc(compRef, component);
            } catch (error) {
                console.error('Error saving component:', error);
                showToast('Failed to save component to Firebase');
            }
        }
        
        async function deleteComponentFromFirebase(name) {
            try {
                const compRef = firebaseDoc(firebaseDB, 'components', name);
                await firebaseDeleteDoc(compRef);
            } catch (error) {
                console.error('Error deleting component:', error);
                showToast('Failed to delete component from Firebase');
            }
        }
        
        async function saveKitToFirebase(name, kit) {
            try {
                const kitRef = firebaseDoc(firebaseDB, 'kits', name);
                await firebaseSetDoc(kitRef, kit);
            } catch (error) {
                console.error('Error saving kit:', error);
                showToast('Failed to save kit to Firebase');
            }
        }
        
        async function deleteKitFromFirebase(name) {
            try {
                const kitRef = firebaseDoc(firebaseDB, 'kits', name);
                await firebaseDeleteDoc(kitRef);
            } catch (error) {
                console.error('Error deleting kit:', error);
                showToast('Failed to delete kit from Firebase');
            }
        }
        
        async function saveNextOrderId() {
            try {
                const nextOrderIdRef = firebaseDoc(firebaseDB, 'metadata', 'nextOrderId');
                await firebaseSetDoc(nextOrderIdRef, { value: nextOrderId });
            } catch (error) {
                console.error('Error saving nextOrderId:', error);
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function updateStats() {
            const activeOrders = orders.filter(o => !o.shipped);
            const readyToShip = activeOrders.filter(o => o.paid && canFulfillOrder(o));
            
            let inventoryValue = 0;
            for (const comp of Object.values(components)) {
                inventoryValue += comp.onHand * 0.10;
            }
            
            document.getElementById('activeOrdersCount').textContent = activeOrders.length;
            document.getElementById('readyToShipCount').textContent = readyToShip.length;
            document.getElementById('totalComponents').textContent = Object.keys(components).length;
            document.getElementById('inventoryValue').textContent = inventoryValue.toFixed(0);
        }
        
        function canFulfillOrder(order) {
            for (const [kitName, kit] of Object.entries(kits)) {
                const qtyNeeded = order[kitName.toLowerCase()] || 0;
                if (qtyNeeded > 0) {
                    for (const [componentName, componentQty] of Object.entries(kit.components)) {
                        const comp = components[componentName];
                        if (!comp || comp.onHand < qtyNeeded * componentQty) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }
        
        function openNewOrderModal() {
            currentEditOrder = null;
            document.getElementById('orderModalTitle').textContent = 'New Order';
            document.getElementById('orderName').value = '';
            document.getElementById('orderShopifyNumber').value = '';
            document.getElementById('orderPaid').checked = false;
            document.getElementById('orderShipped').checked = false;
            document.getElementById('orderTracking').value = '';
            document.getElementById('trackingGroup').style.display = 'none';
            document.getElementById('deleteOrderZone').style.display = 'none';
            
            const container = document.getElementById('orderKitsContainer');
            container.innerHTML = '';
            
            for (const kitName of Object.keys(kits)) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${kitName}</label>
                    <input type="number" id="order${kitName}" value="0" min="0">
                `;
                container.appendChild(div);
            }
            
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function closeNewOrderModal() {
            document.getElementById('newOrderModal').classList.remove('active');
        }
        
        document.getElementById('orderShipped').addEventListener('change', function() {
            document.getElementById('trackingGroup').style.display = this.checked ? 'block' : 'none';
        });
        
        function saveOrder() {
            const name = document.getElementById('orderName').value.trim();
            const shopifyNumber = document.getElementById('orderShopifyNumber').value.trim();
            const paid = document.getElementById('orderPaid').checked;
            const shipped = document.getElementById('orderShipped').checked;
            const tracking = document.getElementById('orderTracking').value.trim();
            
            if (!name) {
                alert('Please enter a customer name');
                return;
            }
            
            const order = currentEditOrder 
                ? orders.find(o => o.id === currentEditOrder)
                : { id: nextOrderId++ };
            
            order.name = name;
            order.shopifyOrderNumber = shopifyNumber;
            order.paid = paid;
            order.shipped = shipped;
            order.tracking = tracking;
            
            for (const kitName of Object.keys(kits)) {
                const qty = parseInt(document.getElementById(`order${kitName}`).value) || 0;
                order[kitName.toLowerCase()] = qty;
            }
            
            if (!currentEditOrder) {
                orders.push(order);
                saveNextOrderId();
            }
            
            saveOrderToFirebase(order);
            
            closeNewOrderModal();
            updateStats();
            renderOrders();
            renderInventory();
            renderShippedOrders();
            showToast(currentEditOrder ? 'Order updated' : 'Order created');
        }
        
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            currentEditOrder = orderId;
            document.getElementById('orderModalTitle').textContent = 'Edit Order';
            document.getElementById('orderName').value = order.name;
            document.getElementById('orderShopifyNumber').value = order.shopifyOrderNumber || '';
            document.getElementById('orderPaid').checked = order.paid;
            document.getElementById('orderShipped').checked = order.shipped;
            document.getElementById('orderTracking').value = order.tracking || '';
            document.getElementById('trackingGroup').style.display = order.shipped ? 'block' : 'none';
            document.getElementById('deleteOrderZone').style.display = 'block';
            
            const container = document.getElementById('orderKitsContainer');
            container.innerHTML = '';
            
            for (const kitName of Object.keys(kits)) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${kitName}</label>
                    <input type="number" id="order${kitName}" value="${order[kitName.toLowerCase()] || 0}" min="0">
                `;
                container.appendChild(div);
            }
            
            document.getElementById('newOrderModal').classList.add('active');
        }
        
        function deleteCurrentOrder() {
            if (!currentEditOrder) return;
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            deleteOrderFromFirebase(currentEditOrder);
            orders = orders.filter(o => o.id !== currentEditOrder);
            
            closeNewOrderModal();
            updateStats();
            renderOrders();
            renderInventory();
            renderShippedOrders();
            showToast('Order deleted');
        }
        
        function unshipOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.shipped = false;
            order.tracking = '';
            
            saveOrderToFirebase(order);
            
            updateStats();
            renderOrders();
            renderShippedOrders();
            showToast('Order unshipped');
        }
        
        function openNewComponentModal() {
            currentEditComponent = null;
            document.getElementById('componentModalTitle').textContent = 'New Component';
            document.getElementById('componentName').value = '';
            document.getElementById('componentName').disabled = false;
            document.getElementById('componentOnHand').value = '0';
            document.getElementById('componentOnOrder').value = '0';
            document.getElementById('componentETA').value = '';
            document.getElementById('deleteComponentZone').style.display = 'none';
            document.getElementById('newComponentModal').classList.add('active');
        }
        
        function closeNewComponentModal() {
            document.getElementById('newComponentModal').classList.remove('active');
        }
        
        function saveComponent() {
            const name = document.getElementById('componentName').value.trim();
            const onHand = parseInt(document.getElementById('componentOnHand').value) || 0;
            const onOrder = parseInt(document.getElementById('componentOnOrder').value) || 0;
            const eta = document.getElementById('componentETA').value.trim();
            
            if (!name) {
                alert('Please enter a component name');
                return;
            }
            
            if (!currentEditComponent && components[name]) {
                alert('A component with this name already exists');
                return;
            }
            
            if (currentEditComponent && currentEditComponent !== name) {
                delete components[currentEditComponent];
                deleteComponentFromFirebase(currentEditComponent);
            }
            
            components[name] = { onHand, onOrder, eta };
            saveComponentToFirebase(name, components[name]);
            
            closeNewComponentModal();
            updateStats();
            renderInventory();
            renderKits();
            showToast(currentEditComponent ? 'Component updated' : 'Component created');
        }
        
        function editComponent(name) {
            const comp = components[name];
            if (!comp) return;
            
            currentEditComponent = name;
            document.getElementById('componentModalTitle').textContent = 'Edit Component';
            document.getElementById('componentName').value = name;
            document.getElementById('componentName').disabled = true;
            document.getElementById('componentOnHand').value = comp.onHand;
            document.getElementById('componentOnOrder').value = comp.onOrder;
            document.getElementById('componentETA').value = comp.eta;
            document.getElementById('deleteComponentZone').style.display = 'block';
            document.getElementById('newComponentModal').classList.add('active');
        }
        
        function deleteCurrentComponent() {
            if (!currentEditComponent) return;
            if (!confirm(`Are you sure you want to delete ${currentEditComponent}?`)) return;
            
            deleteComponentFromFirebase(currentEditComponent);
            delete components[currentEditComponent];
            
            closeNewComponentModal();
            updateStats();
            renderInventory();
            renderKits();
            showToast('Component deleted');
        }
        
        function importInventoryCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    alert('CSV file is empty or invalid');
                    return;
                }
                
                components = {};
                
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    if (parts.length >= 4) {
                        const name = parts[0];
                        const onHand = parseInt(parts[1]) || 0;
                        const onOrder = parseInt(parts[2]) || 0;
                        const eta = parts[3] || '';
                        components[name] = { onHand, onOrder, eta };
                    }
                }
                
                await autoSyncToFirebase();
                updateStats();
                renderInventory();
                renderKits();
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportInventoryCSV() {
            // Create comprehensive inventory export with all kits and components
            let csv = '=== COMPONENT INVENTORY ===\n';
            csv += 'Component,On Hand,On Order,ETA,Needed for Active Orders\n';
            
            // Calculate needed quantities for each component
            const paidOrders = orders.filter(o => o.paid && !o.shipped);
            const neededQuantities = {};
            
            paidOrders.forEach(order => {
                for (const [kitName, kit] of Object.entries(kits)) {
                    const kitQty = order[kitName.toLowerCase()] || 0;
                    if (kitQty > 0) {
                        for (const [componentName, componentQty] of Object.entries(kit.components)) {
                            neededQuantities[componentName] = (neededQuantities[componentName] || 0) + (kitQty * componentQty);
                        }
                    }
                }
            });
            
            for (const [name, comp] of Object.entries(components)) {
                const needed = neededQuantities[name] || 0;
                csv += `${name},${comp.onHand},${comp.onOrder},${comp.eta},${needed}\n`;
            }
            
            csv += '\n=== KIT DEFINITIONS ===\n';
            csv += 'Kit Name,Cost,Price,Components Required,Can Make with Current Inventory\n';
            
            for (const [kitName, kit] of Object.entries(kits)) {
                const canMake = calculateKitsCanMake(kitName);
                const componentsList = Object.entries(kit.components)
                    .map(([comp, qty]) => `${qty}× ${comp}`)
                    .join('; ');
                csv += `${kitName},${kit.cost},${kit.price},"${componentsList}",${canMake}\n`;
            }
            
            csv += '\n=== KIT REQUIREMENTS PER COMPONENT ===\n';
            csv += 'Component Name';
            for (const kitName of Object.keys(kits)) {
                csv += `,${kitName}`;
            }
            csv += '\n';
            
            // Create a matrix showing which components are needed for each kit
            for (const componentName of Object.keys(components)) {
                csv += componentName;
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = kit.components[componentName] || 0;
                    csv += `,${qty}`;
                }
                csv += '\n';
            }
            
            csv += '\n=== SUMMARY ===\n';
            csv += `Total Components,${Object.keys(components).length}\n`;
            csv += `Total Kits,${Object.keys(kits).length}\n`;
            csv += `Active Paid Orders,${paidOrders.length}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `full-inventory-export-${date}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Full inventory exported with kits and components');
        }
        
        function importOrdersCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    alert('CSV file is empty or invalid');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    const order = { id: nextOrderId++ };
                    
                    headers.forEach((header, index) => {
                        if (header === 'name') {
                            order.name = parts[index];
                        } else if (header === 'shopify order number' || header === 'order number') {
                            order.shopifyOrderNumber = parts[index];
                        } else if (header === 'paid') {
                            order.paid = parts[index].toLowerCase() === 'true' || parts[index] === '1';
                        } else if (header === 'shipped') {
                            order.shipped = parts[index].toLowerCase() === 'true' || parts[index] === '1';
                        } else if (header === 'tracking') {
                            order.tracking = parts[index];
                        } else {
                            const kitName = Object.keys(kits).find(k => k.toLowerCase() === header);
                            if (kitName) {
                                order[kitName.toLowerCase()] = parseInt(parts[index]) || 0;
                            }
                        }
                    });
                    
                    if (order.name) {
                        orders.push(order);
                    }
                }
                
                await saveNextOrderId();
                await autoSyncToFirebase();
                updateStats();
                renderOrders();
                renderInventory();
                renderShippedOrders();
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportOrdersCSV() {
            const kitNames = Object.keys(kits);
            let csv = 'Name,Shopify Order Number,' + kitNames.join(',') + ',Paid,Shipped,Tracking\n';
            
            orders.forEach(order => {
                const kitQtys = kitNames.map(k => order[k.toLowerCase()] || 0).join(',');
                csv += `${order.name},${order.shopifyOrderNumber || ''},${kitQtys},${order.paid},${order.shipped},${order.tracking || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'orders.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function openNewKitModal() {
            currentEditKit = null;
            document.getElementById('kitModalTitle').textContent = 'New Kit';
            document.getElementById('kitName').value = '';
            document.getElementById('kitName').disabled = false;
            document.getElementById('kitCost').value = '0';
            document.getElementById('kitPrice').value = '0';
            document.getElementById('kitComponentsContainer').innerHTML = '';
            document.getElementById('deleteKitZone').style.display = 'none';
            addKitComponent();
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function closeNewKitModal() {
            document.getElementById('newKitModal').classList.remove('active');
        }
        
        function addKitComponent() {
            const container = document.getElementById('kitComponentsContainer');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.style.alignItems = 'center';
            
            const select = document.createElement('select');
            select.style.flex = '2';
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Select Component';
            select.appendChild(option);
            
            for (const name of Object.keys(components)) {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            }
            
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '1';
            input.value = '1';
            input.style.flex = '1';
            input.placeholder = 'Qty';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-small btn-danger';
            removeBtn.textContent = '×';
            removeBtn.type = 'button';
            removeBtn.onclick = () => div.remove();
            
            div.appendChild(select);
            div.appendChild(input);
            div.appendChild(removeBtn);
            container.appendChild(div);
        }
        
        function updateOrderTableHeaders() {
            // This function would dynamically update headers if needed
        }
        
        function importKitsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    alert('CSV file is empty or invalid');
                    return;
                }
                
                kits = {};
                
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    if (parts.length >= 4) {
                        const kitName = parts[0];
                        const cost = parseFloat(parts[1]) || 0;
                        const price = parseFloat(parts[2]) || 0;
                        const componentsStr = parts[3].replace(/^"|"$/g, '');
                        
                        const componentsObj = {};
                        if (componentsStr) {
                            const compPairs = componentsStr.split(';');
                            compPairs.forEach(pair => {
                                const [qty, name] = pair.split('×').map(s => s.trim());
                                if (qty && name) {
                                    componentsObj[name] = parseInt(qty);
                                }
                            });
                        }
                        
                        kits[kitName] = {
                            cost,
                            price,
                            components: componentsObj
                        };
                    }
                }
                
                await autoSyncToFirebase();
                updateStats();
                renderKits();
                updateOrderTableHeaders();
                renderOrders();
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportKitsCSV() {
            let csv = 'Kit Name,Cost,Price,Components\n';
            for (const [name, kit] of Object.entries(kits)) {
                const componentsStr = Object.entries(kit.components)
                    .map(([comp, qty]) => `${qty}× ${comp}`)
                    .join('; ');
                csv += `${name},${kit.cost},${kit.price},"${componentsStr}"\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kits.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function editKit(kitName) {
            const kit = kits[kitName];
            if (!kit) return;
            
            currentEditKit = kitName;
            document.getElementById('kitModalTitle').textContent = 'Edit Kit';
            document.getElementById('kitName').value = kitName;
            document.getElementById('kitName').disabled = true;
            document.getElementById('kitCost').value = kit.cost;
            document.getElementById('kitPrice').value = kit.price;
            document.getElementById('deleteKitZone').style.display = 'block';
            
            const container = document.getElementById('kitComponentsContainer');
            container.innerHTML = '';
            
            for (const [compName, qty] of Object.entries(kit.components)) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.style.display = 'flex';
                div.style.gap = '10px';
                div.style.alignItems = 'center';
                
                const select = document.createElement('select');
                select.style.flex = '2';
                
                for (const name of Object.keys(components)) {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (name === compName) opt.selected = true;
                    select.appendChild(opt);
                }
                
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.value = qty;
                input.style.flex = '1';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-small btn-danger';
                removeBtn.textContent = '×';
                removeBtn.type = 'button';
                removeBtn.onclick = () => div.remove();
                
                div.appendChild(select);
                div.appendChild(input);
                div.appendChild(removeBtn);
                container.appendChild(div);
            }
            
            document.getElementById('newKitModal').classList.add('active');
        }
        
        function saveKit() {
            const name = document.getElementById('kitName').value.trim();
            const cost = parseFloat(document.getElementById('kitCost').value) || 0;
            const price = parseFloat(document.getElementById('kitPrice').value) || 0;
            
            if (!name) {
                alert('Please enter a kit name');
                return;
            }
            
            if (!currentEditKit && kits[name]) {
                alert('A kit with this name already exists');
                return;
            }
            
            const componentsObj = {};
            const container = document.getElementById('kitComponentsContainer');
            const componentDivs = container.querySelectorAll('.form-group');
            
            componentDivs.forEach(div => {
                const select = div.querySelector('select');
                const input = div.querySelector('input[type="number"]');
                const compName = select.value;
                const qty = parseInt(input.value) || 1;
                
                if (compName) {
                    componentsObj[compName] = qty;
                }
            });
            
            if (Object.keys(componentsObj).length === 0) {
                alert('Please add at least one component');
                return;
            }
            
            if (currentEditKit && currentEditKit !== name) {
                delete kits[currentEditKit];
                deleteKitFromFirebase(currentEditKit);
            }
            
            kits[name] = { cost, price, components: componentsObj };
            saveKitToFirebase(name, kits[name]);
            
            closeNewKitModal();
            renderKits();
            updateOrderTableHeaders();
            renderOrders();
            showToast(currentEditKit ? 'Kit updated' : 'Kit created');
        }
        
        function deleteCurrentKit() {
            if (!currentEditKit) return;
            if (!confirm(`Are you sure you want to delete the ${currentEditKit} kit?`)) return;
            
            deleteKitFromFirebase(currentEditKit);
            delete kits[currentEditKit];
            
            closeNewKitModal();
            renderKits();
            updateOrderTableHeaders();
            renderOrders();
            showToast('Kit deleted');
        }
        
        function renderOrdersSummary() {
            const activeOrders = orders.filter(o => !o.shipped);
            const kitTotals = {};
            
            activeOrders.forEach(order => {
                for (const kitName of Object.keys(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        kitTotals[kitName] = (kitTotals[kitName] || 0) + qty;
                    }
                }
            });
            
            const summaryDiv = document.getElementById('ordersSummary');
            summaryDiv.innerHTML = '';
            
            for (const [kitName, total] of Object.entries(kitTotals)) {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                card.innerHTML = `
                    <div style="font-size: 12px; color: #666; font-weight: 600; margin-bottom: 5px;">${kitName.toUpperCase()}</div>
                    <div style="font-size: 24px; color: #667eea; font-weight: bold;">${total}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">to build</div>
                `;
                summaryDiv.appendChild(card);
            }
            
            if (Object.keys(kitTotals).length === 0) {
                summaryDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No active orders</div>';
            }
        }
        
        function renderOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            const activeOrders = orders.filter(o => !o.shipped);
            
            if (activeOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No active orders</td></tr>';
            }
            
            activeOrders.forEach(order => {
                let totalQty = 0;
                const productList = [];
                
                for (const kitName of Object.keys(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        totalQty += qty;
                        productList.push(`${qty}× ${kitName}`);
                    }
                }
                
                const productText = totalQty > 0 
                    ? `${totalQty} item${totalQty > 1 ? 's' : ''} (${productList.join(', ')})`
                    : 'No products';
                
                const ready = canFulfillOrder(order);
                const orderNumber = order.shopifyOrderNumber || '-';
                
                let bgColor = '';
                let statusText = '';
                
                if (order.paid && ready) {
                    bgColor = '#d1fae5';
                    statusText = '<span class="status-paid">✓ PAID & READY TO SHIP</span>';
                } else if (order.paid) {
                    bgColor = '#fef3c7';
                    statusText = '<span class="status-paid awaiting">⚠ PAID - AWAITING STOCK</span>';
                } else {
                    bgColor = '#fee2e2';
                    statusText = '<span class="status-unpaid">UNPAID</span>';
                }
                
                const tr = document.createElement('tr');
                tr.style.backgroundColor = bgColor;
                tr.onclick = () => editOrder(order.id);
                
                const td1 = document.createElement('td');
                td1.innerHTML = `<strong>${order.name}</strong>`;
                tr.appendChild(td1);
                
                const td2 = document.createElement('td');
                td2.textContent = orderNumber;
                tr.appendChild(td2);
                
                const td3 = document.createElement('td');
                td3.textContent = productText;
                tr.appendChild(td3);
                
                const td4 = document.createElement('td');
                td4.innerHTML = statusText;
                tr.appendChild(td4);
                
                tbody.appendChild(tr);
            });
            
            renderOrdersSummary();
        }
        
        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            for (const [name, comp] of Object.entries(components)) {
                let needed = 0;
                
                const paidOrders = orders.filter(o => o.paid && !o.shipped);
                paidOrders.forEach(order => {
                    for (const [kitName, kit] of Object.entries(kits)) {
                        const kitQty = order[kitName.toLowerCase()] || 0;
                        const componentQty = kit.components[name] || 0;
                        needed += kitQty * componentQty;
                    }
                });
                
                const totalAvailable = comp.onHand + comp.onOrder;
                let statusClass = 'inventory-ok', statusText = '✓ OK';
                let onHandClass = 'onhand-ok';
                
                if (comp.onHand < needed) {
                    if (totalAvailable >= needed) {
                        statusClass = 'inventory-low';
                        statusText = '⚠ On Order';
                        onHandClass = 'onhand-low';
                    } else {
                        statusClass = 'inventory-critical';
                        statusText = '⚠️ Need Ordered';
                        onHandClass = 'onhand-critical';
                    }
                }
                
                const row = document.createElement('tr');
                row.onclick = () => editComponent(name);
                row.innerHTML = `
                    <td><strong>${name}</strong></td>
                    <td>${needed}</td>
                    <td><span class="${onHandClass}">${comp.onHand}</span></td>
                    <td>${comp.onOrder}</td>
                    <td>${comp.eta}</td>
                    <td><strong>${totalAvailable}</strong></td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function calculateKitsCanMake(kitName) {
            const kit = kits[kitName];
            if (!kit) return 0;
            
            let minCanMake = Infinity;
            for (const [componentName, qtyNeeded] of Object.entries(kit.components)) {
                const comp = components[componentName];
                if (!comp) return 0;
                const canMake = Math.floor(comp.onHand / qtyNeeded);
                minCanMake = Math.min(minCanMake, canMake);
            }
            return minCanMake === Infinity ? 0 : minCanMake;
        }
        
        function renderKits() {
            const tbody = document.getElementById('kitsBody');
            tbody.innerHTML = '';
            
            for (const [kitName, kit] of Object.entries(kits)) {
                const canMake = calculateKitsCanMake(kitName);
                const componentsList = Object.entries(kit.components)
                    .map(([comp, qty]) => `${qty}× ${comp}`)
                    .join(', ');
                
                const row = document.createElement('tr');
                row.onclick = () => editKit(kitName);
                row.innerHTML = `
                    <td><strong>${kitName}</strong></td>
                    <td>${componentsList}</td>
                    <td>${(kit.cost || 0).toFixed(2)}</td>
                    <td>${(kit.price || 0).toFixed(2)}</td>
                    <td><strong>${canMake}</strong></td>
                `;
                tbody.appendChild(row);
            }
        }
        
        function renderShippedOrders() {
            const tbody = document.getElementById('shippedBody');
            tbody.innerHTML = '';
            const shippedOrders = orders.filter(o => o.shipped);
            if (shippedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No shipped orders yet</td></tr>';
                return;
            }
            shippedOrders.forEach((order) => {
                let amount = 0;
                const items = [];
                for (const [kitName, kit] of Object.entries(kits)) {
                    const qty = order[kitName.toLowerCase()] || 0;
                    if (qty > 0) {
                        items.push(`${qty} ${kitName}`);
                        amount += qty * (kit.price || 0);
                    }
                }
                
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => editOrder(order.id);
                row.innerHTML = `
                    <td><strong>${order.name}</strong></td>
                    <td>${items.join(', ')}</td>
                    <td><strong>${amount}</strong></td>
                    <td>${order.tracking || 'N/A'}</td>
                    <td><button class="btn btn-small btn-danger" onclick="event.stopPropagation(); unshipOrder(${order.id})">Unship</button></td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
